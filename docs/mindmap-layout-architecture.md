# 思维导图 SOTA 布局与渲染架构说明

## 1. 概述

本文档详细说明了思维导图（Learning Hub MindMap）组件的布局算法与渲染策略。针对用户反馈的布局不对称、走线难看等问题，我们采用了业界 SOTA (State of the Art) 的实现方案进行了全面优化。

## 2. 核心问题分析

优化前的主要问题：
1.  **组织结构图连线混乱**：使用 ReactFlow 默认的 `smoothstep` 边，在复杂层级下路径计算不理想，使用 `orthogonal` 边导致线条绕路。
2.  **节点样式单一**：所有层级节点均为圆角矩形背景，缺乏层次感，不符合现代思维导图的轻量化趋势。
3.  **布局对称性不足**：部分布局算法未严格按照子树几何中心对齐父节点。
4.  **视觉单调**：缺乏颜色区分，难以一眼区分不同分支的内容。

## 3. SOTA 布局算法实现

我们参考了主流思维导图软件的布局策略，实现了以下优化：

### 3.1 连线策略 (Edge Routing)

我们废弃了通用的寻路算法，转而使用确定性的几何路径计算。

*   **思维导图 (Mind Map) / 树形图 (Tree)**:
    *   **核心改进**：**下划线连线风格 (Underline Style)**。
    *   对于叶子节点或深层节点 (Level >= 2)，连线不再连接到节点侧边中心，而是平滑过渡到节点的底部下划线。
    *   通过调整 ReactFlow Handle 的位置到节点底部角落，利用贝塞尔曲线的水平切线特性，实现完美的“线-线”衔接。

*   **组织结构图 (Org Chart) / 逻辑图 (Logic Chart)**:
    *   **核心改进**：引入自定义 `OrgChartEdge`。
    *   **路径算法**：
        *   **Vertical (垂直)**: 倒T形结构 (Center -> Down -> Horizontal -> Down -> Top)。
        *   **Horizontal (水平)**: 阶梯形结构 (Side -> Horizontal -> Vertical -> Horizontal -> Side)。
    *   **特点**：确定性路径，无随机绕路，拐角处添加平滑圆角。

### 3.2 节点定位 (Node Positioning)

采用递归的包围盒 (Bounding Box) 算法，确保严格的对称性。

*   **垂直/水平布局**：严格基于“子树几何中心”对齐父节点，而非简单的平均分布。
*   **平衡布局 (Balanced)**: 基于子树权重的动态左右分配，确保左右两侧的视觉高度平衡。

### 3.3 节点实测高度 (Measured Node Height)

为彻底避免子树高度低估导致节点重叠，布局计算采用“实测优先”策略：

*   **实测优先**：节点渲染后通过 `ResizeObserver` 记录真实高度，布局引擎优先使用实测高度进行子树计算。
*   **主题基准**：首轮布局仍以主题的 `fontSize` 与 `padding` 计算基准高度，避免首次渲染过于紧凑。
*   **内容补偿**：文本换行与 `note` 的高度仍被计算进基准值，确保即使在实测前也有合理间距。

### 3.4 子树碰撞消除 (Subtree Collision Resolution)

为保证任意分支间“互相排斥”，布局在完成初步定位后执行碰撞消除：

*   **同侧分离**：仅当兄弟子树的 X 范围存在重叠时才进行纵向分离，避免左右两侧互相影响。
*   **整体下移**：一旦发生重叠，整体下移后续子树，保持子树内部相对位置不变。
*   **基于实测高度**：碰撞判定使用实测节点高度，避免估算偏差导致的视觉重叠。

### 3.5 引用预览一致性 (Embed Consistency)

思维导图引用卡片中的预览渲染与主视图保持一致：

*   **同一布局引擎**：预览使用同样的 `TreeLayoutEngine` 与碰撞消除逻辑。
*   **实测高度复用**：预览依赖节点实测高度，保证节点间距与主视图一致。

## 4. 组件架构

### 4.1 节点渲染 (Node Rendering)

针对不同层级应用差异化样式：

*   **Root (Level 0)**:
    *   组件：`RootNode.tsx`
    *   样式：黑色背景，高亮边框，大号字体，强调中心地位。
*   **Branch (Level 1)**:
    *   组件：`BranchNode.tsx`
    *   样式：浅灰背景，圆角矩形，作为主要分支的视觉承载。
*   **Leaf / Deep Branch (Level >= 2)**:
    *   组件：`BranchNode.tsx` (动态样式)
    *   样式：**下划线风格 (Underline Style)**。
    *   实现：透明背景，仅保留底部边框。Handle 移至底部角落，与边框无缝衔接。

### 4.2 布局引擎 (Layout Engines)

| 引擎类名 | 对应布局 | 边类型 | 优化策略 |
| :--- | :--- | :--- | :--- |
| `TreeLayoutEngine` | 普通树形图 | `curved` | 贝塞尔曲线 + 下划线衔接 |
| `BalancedLayoutEngine` | 平衡思维导图 | `curved` | 左右平衡 + 下划线衔接 |
| `VerticalOrgChartEngine` | 垂直组织图 | `orgchart` | 倒T型连线 |
| `HorizontalOrgChartEngine` | 水平组织图 | `orgchart` | 阶梯连线 |
| `LogicTreeLayoutEngine` | 逻辑图 | `orgchart` | 阶梯连线 (水平-垂直-水平) |

## 5. 总结

通过引入“下划线节点”风格，Learning Hub 的思维导图组件在视觉表现力上实现了质的飞跃。不仅解决了布局混乱的问题，更使思维结构一目了然。
