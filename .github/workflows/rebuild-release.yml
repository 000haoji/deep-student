# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë  ÊâãÂä®ÈáçÂª∫ Release (rebuild-release.yml)                        ‚ïë
# ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
# ‚ïë                                                                ‚ïë
# ‚ïë  Áî®ÈÄî: ÈáçÊñ∞ÊûÑÂª∫Âπ∂ÂèëÂ∏ÉÊüê‰∏™Â∑≤Â≠òÂú®ÁöÑ tag ÁâàÊú¨                     ‚ïë
# ‚ïë  Âú∫ÊôØ: ÊûÑÂª∫Â§±Ë¥•ÈúÄË¶ÅÈáçËØï / ÈúÄË¶ÅÊõøÊç¢Â∑≤Êúâ‰∫ßÁâ© / Ë°•ÂèëÊüê‰∏™Âπ≥Âè∞      ‚ïë
# ‚ïë                                                                ‚ïë
# ‚ïë  ÂÆâÂÖ®‰øùÈöú:                                                     ‚ïë
# ‚ïë    - Âè™Êé•ÂèóÂ∑≤Â≠òÂú®‰∫é‰ªìÂ∫ì‰∏≠ÁöÑ tag (‰∏çÂ≠òÂú®Âàô checkout Â§±Ë¥•)        ‚ïë
# ‚ïë    - ÊâßË°å‰∏é‰∏ªÊµÅÁ®ãÂÆåÂÖ®Áõ∏ÂêåÁöÑÁâàÊú¨Âè∑‰∏âÈáçÊ†°È™å                      ‚ïë
# ‚ïë    - checkout ÁöÑÊòØ tag ÊåáÂêëÁöÑ commit, ‰∏çÂèó headSha ÂΩ±Âìç        ‚ïë
# ‚ïë                                                                ‚ïë
# ‚ïë  Êìç‰Ωú: GitHub ‚Üí Actions ‚Üí Rebuild Release ‚Üí Run workflow       ‚ïë
# ‚ïë        ËæìÂÖ• tag ÂêçÁß∞ (Â¶Ç v0.9.22) ‚Üí Ëá™Âä®ÊûÑÂª∫ÂèëÂ∏É               ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

name: Rebuild Release

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Ë¶ÅÈáçÂª∫ÁöÑ tag (Â¶Ç v0.9.22), ÂøÖÈ°ªÊòØÂ∑≤Â≠òÂú®ÁöÑ tag'
        required: true
        type: string

concurrency:
  group: rebuild-${{ github.event.inputs.tag_name }}
  cancel-in-progress: false

env:
  GITHUB_REPO: ${{ github.repository }}
  R2_BUCKET: deepstudent
  KEEP_VERSIONS: 10

jobs:
  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  # ÁâàÊú¨Âè∑‰∏âÈáçÊ†°È™åÈó®Á¶Å
  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  verify:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.verify.outputs.version }}
      tag_name: ${{ steps.verify.outputs.tag_name }}
    steps:
      - name: Validate tag format
        run: |
          TAG_NAME="${{ github.event.inputs.tag_name }}"
          if [[ ! "${TAG_NAME}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid tag format: '${TAG_NAME}'. Expected format: v0.9.22"
            exit 1
          fi
          echo "‚úÖ Tag format valid: ${TAG_NAME}"

      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag_name }}

      - name: Verify version consistency
        id: verify
        run: |
          TAG_NAME="${{ github.event.inputs.tag_name }}"
          TAG_VERSION="${TAG_NAME#v}"

          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "version=${TAG_VERSION}" >> $GITHUB_OUTPUT

          PKG_VERSION=$(jq -r '.version' package.json)
          CARGO_VERSION=$(sed -n '/^\[package\]/,/^\[/{s/^version *= *"\(.*\)"/\1/p}' src-tauri/Cargo.toml)
          TAURI_VERSION=$(jq -r '.version' src-tauri/tauri.conf.json)

          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "  Tag version:       ${TAG_VERSION}"
          echo "  package.json:      ${PKG_VERSION}"
          echo "  Cargo.toml:        ${CARGO_VERSION}"
          echo "  tauri.conf.json:   ${TAURI_VERSION}"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

          ERRORS=0

          if [[ "${PKG_VERSION}" != "${TAG_VERSION}" ]]; then
            echo "::error::package.json version (${PKG_VERSION}) does not match tag (${TAG_VERSION})"
            ERRORS=$((ERRORS + 1))
          fi

          if [[ "${CARGO_VERSION}" != "${TAG_VERSION}" ]]; then
            echo "::error::Cargo.toml version (${CARGO_VERSION}) does not match tag (${TAG_VERSION})"
            ERRORS=$((ERRORS + 1))
          fi

          if [[ "${TAURI_VERSION}" != "${TAG_VERSION}" ]]; then
            echo "::error::tauri.conf.json version (${TAURI_VERSION}) does not match tag (${TAG_VERSION})"
            ERRORS=$((ERRORS + 1))
          fi

          if [[ $ERRORS -gt 0 ]]; then
            echo "::error::Version mismatch detected! ${ERRORS} file(s) have inconsistent versions."
            echo "::error::The tag does not point to a commit with matching version numbers."
            exit 1
          fi

          echo "‚úÖ All version numbers are consistent: ${TAG_VERSION}"

  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  # ÊûÑÂª∫ (ÈÄöËøáÁâàÊú¨Ê†°È™åÂêéÂπ∂Ë°åÊûÑÂª∫ÂÖ®Âπ≥Âè∞)
  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

  build-macos:
    needs: [verify]
    runs-on: macos-latest
    env:
      NODE_OPTIONS: '--max-old-space-size=4096'
    strategy:
      fail-fast: false
      matrix:
        target: [aarch64-apple-darwin, x86_64-apple-darwin]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.verify.outputs.tag_name }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install dependencies
        run: npm ci

      - name: Generate version info
        run: node scripts/generate-version.mjs

      - name: Build Tauri app
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          SILICONFLOW_BUILTIN_TEXT_KEY: ${{ secrets.SILICONFLOW_BUILTIN_TEXT_KEY }}
          SILICONFLOW_BUILTIN_VISION_KEY: ${{ secrets.SILICONFLOW_BUILTIN_VISION_KEY }}
          SILICONFLOW_BUILTIN_EMBED_KEY: ${{ secrets.SILICONFLOW_BUILTIN_EMBED_KEY }}
        run: npx tauri build --target ${{ matrix.target }}

      - name: Rename updater artifacts with arch suffix
        run: |
          BUNDLE_DIR="src-tauri/target/${{ matrix.target }}/release/bundle/macos"
          ARCH=$(echo "${{ matrix.target }}" | cut -d'-' -f1)
          for f in "$BUNDLE_DIR"/*.app.tar.gz; do
            [ -f "$f" ] || continue
            BASE=$(basename "$f" .app.tar.gz | tr ' ' '.')
            mv "$f" "$BUNDLE_DIR/${BASE}_${ARCH}.app.tar.gz"
            [ -f "$f.sig" ] && mv "$f.sig" "$BUNDLE_DIR/${BASE}_${ARCH}.app.tar.gz.sig"
          done
          echo "üì¶ Renamed updater artifacts:"
          ls -la "$BUNDLE_DIR"/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.target }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app.tar.gz
            src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app.tar.gz.sig
            src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg

  build-windows:
    needs: [verify]
    runs-on: windows-latest
    env:
      NODE_OPTIONS: '--max-old-space-size=4096'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.verify.outputs.tag_name }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install dependencies
        run: npm ci

      - name: Generate version info
        run: node scripts/generate-version.mjs

      - name: Build Tauri app
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          SILICONFLOW_BUILTIN_TEXT_KEY: ${{ secrets.SILICONFLOW_BUILTIN_TEXT_KEY }}
          SILICONFLOW_BUILTIN_VISION_KEY: ${{ secrets.SILICONFLOW_BUILTIN_VISION_KEY }}
          SILICONFLOW_BUILTIN_EMBED_KEY: ${{ secrets.SILICONFLOW_BUILTIN_EMBED_KEY }}
        run: npx tauri build --target x86_64-pc-windows-msvc

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x86_64
          path: |
            src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*.exe
            src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*.exe.sig

  build-android:
    needs: [verify]
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: '--max-old-space-size=4096'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.verify.outputs.tag_name }}

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android/sdk/ndk /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Android SDK & NDK
        run: |
          yes | ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager \
            "ndk;27.0.12077973" "build-tools;35.0.0" "platforms;android-35" | tail -3
          echo "NDK_HOME=${ANDROID_HOME}/ndk/27.0.12077973" >> $GITHUB_ENV

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      - name: Setup protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install dependencies
        run: npm ci

      - name: Generate version info
        run: node scripts/generate-version.mjs

      - name: Initialize Android project
        run: npx tauri android init

      - name: Copy custom Android icons
        run: |
          ICONS_SRC="src-tauri/icons/android"
          RES_DST="src-tauri/gen/android/app/src/main/res"
          if [ -d "$ICONS_SRC" ]; then
            for density in mipmap-mdpi mipmap-hdpi mipmap-xhdpi mipmap-xxhdpi mipmap-xxxhdpi; do
              if [ -d "$ICONS_SRC/$density" ]; then
                mkdir -p "$RES_DST/$density"
                cp -f "$ICONS_SRC/$density/"* "$RES_DST/$density/"
              fi
            done
            if [ -d "$ICONS_SRC/mipmap-anydpi-v26" ]; then
              mkdir -p "$RES_DST/mipmap-anydpi-v26"
              cp -f "$ICONS_SRC/mipmap-anydpi-v26/"* "$RES_DST/mipmap-anydpi-v26/"
            fi
            if [ -f "$ICONS_SRC/values/ic_launcher_background.xml" ]; then
              mkdir -p "$RES_DST/values"
              cp -f "$ICONS_SRC/values/ic_launcher_background.xml" "$RES_DST/values/"
            fi
            rm -f "$RES_DST/drawable-v24/ic_launcher_foreground.xml"
            rm -f "$RES_DST/drawable/ic_launcher_background.xml"
            echo "‚úÖ Custom Android icons copied from $ICONS_SRC"
            find "$RES_DST" -name "ic_launcher*" -type f | head -20
          else
            echo "‚ö†Ô∏è No custom Android icons found at $ICONS_SRC, using defaults"
          fi

      - name: Bundle pdfium for Android
        run: |
          JNILIBS_DIR="src-tauri/gen/android/app/src/main/jniLibs/arm64-v8a"
          mkdir -p "$JNILIBS_DIR"
          if [ -f "src-tauri/resources/pdfium/libpdfium_android_arm64.so" ]; then
            cp src-tauri/resources/pdfium/libpdfium_android_arm64.so "$JNILIBS_DIR/libpdfium.so"
            echo "‚úÖ Bundled pdfium for arm64: $(ls -lh "$JNILIBS_DIR/libpdfium.so" | awk '{print $5}')"
          else
            echo "‚ö†Ô∏è Android pdfium .so not found, downloading..."
            bash scripts/download-pdfium.sh android-arm64
            cp src-tauri/resources/pdfium/libpdfium_android_arm64.so "$JNILIBS_DIR/libpdfium.so"
            echo "‚úÖ Downloaded and bundled pdfium for arm64"
          fi

      - name: Configure NDK toolchain
        run: |
          NDK_PREBUILT="${NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64"

          sed -i '/\[target.aarch64-linux-android\]/,/^$/{ s|linker = .*|linker = "'"${NDK_PREBUILT}"'/bin/aarch64-linux-android21-clang"|; s|ar = .*|ar = "'"${NDK_PREBUILT}"'/bin/llvm-ar"| }' src-tauri/.cargo/config.toml

          echo "CC_aarch64_linux_android=${NDK_PREBUILT}/bin/aarch64-linux-android21-clang" >> $GITHUB_ENV
          echo "CXX_aarch64_linux_android=${NDK_PREBUILT}/bin/aarch64-linux-android21-clang++" >> $GITHUB_ENV
          echo "AR_aarch64_linux_android=${NDK_PREBUILT}/bin/llvm-ar" >> $GITHUB_ENV
          echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=${NDK_PREBUILT}/bin/aarch64-linux-android21-clang" >> $GITHUB_ENV

          echo "‚úÖ NDK toolchain configured:"
          cat src-tauri/.cargo/config.toml | grep -A2 aarch64-linux-android

      - name: Build Android APK
        env:
          SILICONFLOW_BUILTIN_TEXT_KEY: ${{ secrets.SILICONFLOW_BUILTIN_TEXT_KEY }}
          SILICONFLOW_BUILTIN_VISION_KEY: ${{ secrets.SILICONFLOW_BUILTIN_VISION_KEY }}
          SILICONFLOW_BUILTIN_EMBED_KEY: ${{ secrets.SILICONFLOW_BUILTIN_EMBED_KEY }}
        run: npx tauri android build --target aarch64

      - name: Sign APK
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          echo "${ANDROID_KEYSTORE_BASE64}" | base64 -d > /tmp/release.keystore

          UNSIGNED_APK=$(find src-tauri/gen/android -name "*-unsigned.apk" -type f | head -1)
          if [ -z "$UNSIGNED_APK" ]; then
            echo "::error::Êú™ÊâæÂà∞Êú™Á≠æÂêçÁöÑ APK"
            find src-tauri/gen/android -name "*.apk" -type f
            exit 1
          fi
          echo "ÊâæÂà∞ APK: $UNSIGNED_APK"

          BUILD_TOOLS=$(ls -d "${ANDROID_HOME}/build-tools/"* | sort -V | tail -1)

          "${BUILD_TOOLS}/zipalign" -v 4 "$UNSIGNED_APK" /tmp/aligned.apk

          "${BUILD_TOOLS}/apksigner" sign \
            --ks /tmp/release.keystore \
            --ks-key-alias "${ANDROID_KEY_ALIAS:-deepstudent}" \
            --ks-pass "pass:${ANDROID_KEYSTORE_PASSWORD}" \
            --key-pass "pass:${ANDROID_KEY_PASSWORD}" \
            --in /tmp/aligned.apk \
            --out /tmp/signed.apk

          "${BUILD_TOOLS}/apksigner" verify --print-certs /tmp/signed.apk

          VERSION="${{ needs.verify.outputs.version }}"
          mkdir -p android-output
          cp /tmp/signed.apk "android-output/Deep.Student_${VERSION}_arm64.apk"

          rm -f /tmp/release.keystore

          echo "‚úÖ APK Á≠æÂêçÂÆåÊàê: Deep.Student_${VERSION}_arm64.apk"
          ls -lh android-output/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-arm64
          path: android-output/*.apk

  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  # ÂèëÂ∏É (ÂÖ®Âπ≥Âè∞ÊûÑÂª∫ÂÆåÊàêÂêéÁªü‰∏ÄÂèëÂ∏É)
  # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  publish:
    needs: [verify, build-macos, build-windows, build-android]
    if: |
      always() &&
      needs.verify.result == 'success' &&
      needs.build-macos.result == 'success' &&
      needs.build-windows.result == 'success' &&
      !cancelled()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.verify.outputs.tag_name }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifact structure
        run: find artifacts -type f | head -50

      - name: Normalize artifact filenames
        run: |
          find artifacts -type f -name '* *' | while IFS= read -r f; do
            DIR=$(dirname "$f")
            OLD=$(basename "$f")
            NEW=$(echo "$OLD" | tr ' ' '.')
            mv "$f" "$DIR/$NEW"
            echo "  Renamed: $OLD ‚Üí $NEW"
          done

      - name: Generate latest.json
        run: |
          VERSION="${{ needs.verify.outputs.version }}"
          REPO="${{ github.repository }}"
          TAG="${{ needs.verify.outputs.tag_name }}"
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          CHANNEL=$(cat .release-channel 2>/dev/null | tr -d '[:space:]' || echo "stable")
          if [[ "$CHANNEL" != "experimental" ]]; then CHANNEL="stable"; fi
          echo "üì¢ Release channel: ${CHANNEL}"

          PLATFORMS="{}"

          MACOS_ARM_DIR="artifacts/macos-aarch64-apple-darwin"
          if [ -d "$MACOS_ARM_DIR" ]; then
            TAR=$(find "$MACOS_ARM_DIR" -name "*_aarch64.app.tar.gz" ! -name "*.sig" | head -1)
            SIG=$(find "$MACOS_ARM_DIR" -name "*_aarch64.app.tar.gz.sig" | head -1)
            if [ -n "$TAR" ] && [ -n "$SIG" ]; then
              TAR_NAME=$(basename "$TAR")
              SIGNATURE=$(cat "$SIG")
              PLATFORMS=$(echo "$PLATFORMS" | jq --arg url "https://github.com/$REPO/releases/download/$TAG/$TAR_NAME" \
                --arg sig "$SIGNATURE" \
                '. + {"darwin-aarch64": {"url": $url, "signature": $sig}}')
            fi
          fi

          MACOS_X64_DIR="artifacts/macos-x86_64-apple-darwin"
          if [ -d "$MACOS_X64_DIR" ]; then
            TAR=$(find "$MACOS_X64_DIR" -name "*_x86_64.app.tar.gz" ! -name "*.sig" | head -1)
            SIG=$(find "$MACOS_X64_DIR" -name "*_x86_64.app.tar.gz.sig" | head -1)
            if [ -n "$TAR" ] && [ -n "$SIG" ]; then
              TAR_NAME=$(basename "$TAR")
              SIGNATURE=$(cat "$SIG")
              PLATFORMS=$(echo "$PLATFORMS" | jq --arg url "https://github.com/$REPO/releases/download/$TAG/$TAR_NAME" \
                --arg sig "$SIGNATURE" \
                '. + {"darwin-x86_64": {"url": $url, "signature": $sig}}')
            fi
          fi

          WIN_DIR="artifacts/windows-x86_64"
          if [ -d "$WIN_DIR" ]; then
            EXE=$(find "$WIN_DIR" -name "*-setup.exe" ! -name "*.sig" | head -1)
            SIG=$(find "$WIN_DIR" -name "*-setup.exe.sig" | head -1)
            if [ -n "$EXE" ] && [ -n "$SIG" ]; then
              EXE_NAME=$(basename "$EXE")
              SIGNATURE=$(cat "$SIG")
              PLATFORMS=$(echo "$PLATFORMS" | jq --arg url "https://github.com/$REPO/releases/download/$TAG/$EXE_NAME" \
                --arg sig "$SIGNATURE" \
                '. + {"windows-x86_64": {"url": $url, "signature": $sig}}')
            fi
          fi

          jq -n \
            --arg version "$VERSION" \
            --arg notes "Deep Student v$VERSION Êõ¥Êñ∞" \
            --arg pub_date "$DATE" \
            --arg channel "$CHANNEL" \
            --argjson platforms "$PLATFORMS" \
            '{version: $version, notes: $notes, pub_date: $pub_date, channel: $channel, platforms: $platforms}' \
            > latest.json

          echo "‚úÖ latest.json Â∑≤ÁîüÊàê:"
          cat latest.json

      - name: Collect release files
        run: |
          mkdir -p release-files
          cp latest.json release-files/

          find artifacts -name "*.app.tar.gz" -exec cp {} release-files/ \;
          find artifacts -name "*.app.tar.gz.sig" -exec cp {} release-files/ \;
          find artifacts -name "*.dmg" -exec cp {} release-files/ \;
          find artifacts -name "*.exe" -exec cp {} release-files/ \;
          find artifacts -name "*.exe.sig" -exec cp {} release-files/ \;
          find artifacts -name "*.apk" -exec cp {} release-files/ \;

          echo "üì¶ Release files:"
          ls -lh release-files/

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2 pinned
        with:
          tag_name: ${{ needs.verify.outputs.tag_name }}
          draft: false
          prerelease: false
          files: release-files/*

      - name: Setup Node.js for wrangler
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Upload to Cloudflare R2
        continue-on-error: true
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          TAG="${{ needs.verify.outputs.tag_name }}"
          echo "üì§ Uploading release ${TAG} to R2..."
          for FILE in release-files/*; do
            NAME=$(basename "$FILE")
            [ "$NAME" = "latest.json" ] && continue
            case "$NAME" in
              *.sig)  CT="application/pgp-signature" ;;
              *.dmg)  CT="application/x-apple-diskimage" ;;
              *.apk)  CT="application/vnd.android.package-archive" ;;
              *)      CT="application/octet-stream" ;;
            esac
            echo "  ‚¨ÜÔ∏è ${NAME} (${CT})"
            npx wrangler r2 object put "${R2_BUCKET}/releases/${TAG}/${NAME}" \
              --file "$FILE" --content-type "$CT" \
              --cache-control "public, max-age=31536000, immutable" --remote
          done
          echo "‚úÖ R2 upload complete"

      - name: Generate R2 latest.json
        continue-on-error: true
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          TAG="${{ needs.verify.outputs.tag_name }}"
          R2_BASE="https://download.deepstudent.cn/releases/${TAG}"

          if [ ! -f latest.json ]; then
            echo "‚ö†Ô∏è No latest.json, skipping"
            exit 0
          fi

          APK_NAME=$(ls release-files/*.apk 2>/dev/null | head -1 | xargs basename 2>/dev/null || echo "")
          APK_URL=""
          if [ -n "$APK_NAME" ]; then
            APK_URL="${R2_BASE}/${APK_NAME}"
            echo "üì± APK: ${APK_URL}"
          fi

          jq --arg base "$R2_BASE" --arg apk "$APK_URL" '
            .platforms |= with_entries(
              .value.url = ($base + "/" + (.value.url | split("/") | last))
            )
            | if $apk != "" then .apk_url = $apk else . end
          ' latest.json > r2-latest.json

          echo "R2 latest.json:"
          cat r2-latest.json

          npx wrangler r2 object put "${R2_BUCKET}/releases/latest.json" \
            --file r2-latest.json --content-type "application/json" \
            --cache-control "public, max-age=300" --remote
          echo "‚úÖ R2 latest.json uploaded"

      - name: Cleanup old R2 versions
        continue-on-error: true
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üßπ Checking for old versions to clean up..."
          RELEASES=$(gh api repos/${{ github.repository }}/releases \
            --paginate -q '.[].tag_name')
          TOTAL=$(echo "$RELEASES" | grep -c . || true)
          echo "Found ${TOTAL} releases"

          if [ "$TOTAL" -le "$KEEP_VERSIONS" ]; then
            echo "‚úÖ No cleanup needed (${TOTAL} ‚â§ ${KEEP_VERSIONS})"
            exit 0
          fi

          TO_DELETE=$(echo "$RELEASES" | tail -n +$((KEEP_VERSIONS + 1)))
          echo "üóëÔ∏è Deleting $(echo "$TO_DELETE" | grep -c . || true) old versions from R2"
          echo "$TO_DELETE" | while read -r OLD_TAG; do
            [ -z "$OLD_TAG" ] && continue
            echo "  Removing releases/${OLD_TAG}/..."
            ASSETS=$(gh api "repos/${{ github.repository }}/releases/tags/${OLD_TAG}" \
              -q '.assets[].name' 2>/dev/null || true)
            echo "$ASSETS" | while read -r NAME; do
              [ -z "$NAME" ] && continue
              npx wrangler r2 object delete "${R2_BUCKET}/releases/${OLD_TAG}/${NAME}" --remote 2>/dev/null || true
            done
          done
          echo "‚úÖ R2 cleanup complete"

      - name: Trigger website rebuild
        continue-on-error: true
        env:
          VERCEL_DEPLOY_HOOK: ${{ secrets.VERCEL_DEPLOY_HOOK }}
        run: |
          if [ -z "$VERCEL_DEPLOY_HOOK" ]; then
            echo "‚ö†Ô∏è VERCEL_DEPLOY_HOOK not configured, skipping"
            exit 0
          fi
          RESP=$(curl -s -X POST "$VERCEL_DEPLOY_HOOK")
          echo "üåê Website rebuild triggered: $RESP"
