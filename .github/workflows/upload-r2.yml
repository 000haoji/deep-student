# Ëá™Âä®ÂêåÊ≠• GitHub Release ‰∫ßÁâ©Âà∞ Cloudflare R2
#
# Ëß¶Âèë: Release ÂèëÂ∏ÉÊó∂Ëá™Âä®ËøêË°å
# ÂäüËÉΩ:
#   1. ‰∏ãËΩΩÂΩìÂâç Release ÁöÑÊâÄÊúâÈôÑ‰ª∂Âπ∂‰∏ä‰º†Âà∞ R2
#   2. Ê∏ÖÁêÜÊóßÁâàÊú¨Ôºå‰ªÖ‰øùÁïôÊúÄËøë 10 ‰∏™ÁâàÊú¨
#
# ÈúÄË¶ÅÂú®‰ªìÂ∫ì Settings ‚Üí Secrets ‰∏≠ÈÖçÁΩÆ:
#   R2_ACCOUNT_ID       - Cloudflare Ë¥¶Êà∑ ID
#   R2_ACCESS_KEY_ID    - R2 API Token ÁöÑ Access Key ID
#   R2_SECRET_ACCESS_KEY - R2 API Token ÁöÑ Secret Access Key

name: Release to R2

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Ë¶ÅÂêåÊ≠•ÁöÑ Release tagÔºàÂ¶Ç v0.9.9Ôºâ'
        required: true
        default: 'v0.9.9'

env:
  R2_BUCKET: deepstudent
  KEEP_VERSIONS: 10

jobs:
  upload-to-r2:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve tag
        id: tag
        run: |
          if [ -n "${{ github.event.release.tag_name }}" ]; then
            echo "value=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "value=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          fi
          echo "üìå Tag: $(cat $GITHUB_OUTPUT | grep value | cut -d= -f2)"

      - name: Download Release Assets
        uses: robinraju/release-downloader@v1.10
        with:
          repository: ${{ github.repository }}
          tag: ${{ steps.tag.outputs.value }}
          fileName: "*"
          out-file-path: "dist"

      - name: Show downloaded files
        run: ls -lh dist/

      - name: Configure AWS CLI for R2
        run: |
          aws configure set aws_access_key_id "${{ secrets.R2_ACCESS_KEY_ID }}"
          aws configure set aws_secret_access_key "${{ secrets.R2_SECRET_ACCESS_KEY }}"
          aws configure set default.region auto

      - name: Upload to R2
        env:
          R2_ENDPOINT: https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com
        run: |
          TAG="${{ steps.tag.outputs.value }}"
          echo "üì§ Uploading release ${TAG} to R2..."
          aws s3 sync dist/ "s3://${R2_BUCKET}/releases/${TAG}/" \
            --endpoint-url "${R2_ENDPOINT}" \
            --no-progress
          echo "‚úÖ Upload complete"
          aws s3 ls "s3://${R2_BUCKET}/releases/${TAG}/" \
            --endpoint-url "${R2_ENDPOINT}"

      - name: Cleanup old versions (keep latest ${{ env.KEEP_VERSIONS }})
        env:
          R2_ENDPOINT: https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com
        run: |
          echo "üßπ Checking for old versions to clean up..."

          # ÂàóÂá∫ÊâÄÊúâÁâàÊú¨ÁõÆÂΩï
          ALL_VERSIONS=$(aws s3 ls "s3://${R2_BUCKET}/releases/" \
            --endpoint-url "${R2_ENDPOINT}" \
            | awk '{print $2}' | sed 's|/||' | sort -V)

          TOTAL=$(echo "$ALL_VERSIONS" | wc -l | tr -d ' ')
          echo "Found ${TOTAL} versions in R2"

          if [ "$TOTAL" -le "$KEEP_VERSIONS" ]; then
            echo "‚úÖ No cleanup needed (${TOTAL} ‚â§ ${KEEP_VERSIONS})"
            exit 0
          fi

          # ËÆ°ÁÆóÈúÄË¶ÅÂà†Èô§ÁöÑÁâàÊú¨Êï∞
          DELETE_COUNT=$((TOTAL - KEEP_VERSIONS))
          TO_DELETE=$(echo "$ALL_VERSIONS" | head -n "$DELETE_COUNT")

          echo "üóëÔ∏è Deleting ${DELETE_COUNT} old versions:"
          echo "$TO_DELETE" | while read -r VERSION; do
            [ -z "$VERSION" ] && continue
            echo "  Removing releases/${VERSION}/..."
            aws s3 rm "s3://${R2_BUCKET}/releases/${VERSION}/" \
              --endpoint-url "${R2_ENDPOINT}" \
              --recursive --quiet
          done

          echo "‚úÖ Cleanup complete. Remaining versions:"
          aws s3 ls "s3://${R2_BUCKET}/releases/" \
            --endpoint-url "${R2_ENDPOINT}" \
            | awk '{print "  " $2}'
