# è‡ªåŠ¨åŒæ­¥ GitHub Release äº§ç‰©åˆ° Cloudflare R2
#
# è§¦å‘: Release å‘å¸ƒæ—¶è‡ªåŠ¨è¿è¡Œ
# åŠŸèƒ½:
#   1. ä¸‹è½½å½“å‰ Release çš„æ‰€æœ‰é™„ä»¶å¹¶ä¸Šä¼ åˆ° R2
#   2. æ¸…ç†æ—§ç‰ˆæœ¬ï¼Œä»…ä¿ç•™æœ€è¿‘ 10 ä¸ªç‰ˆæœ¬
#
# éœ€è¦åœ¨ä»“åº“ Settings â†’ Secrets ä¸­é…ç½®:
#   R2_ACCOUNT_ID       - Cloudflare è´¦æˆ· ID
#   R2_ACCESS_KEY_ID    - R2 API Token çš„ Access Key ID
#   R2_SECRET_ACCESS_KEY - R2 API Token çš„ Secret Access Key

name: Release to R2

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'è¦åŒæ­¥çš„ Release tagï¼ˆå¦‚ v0.9.9ï¼‰'
        required: true
        default: 'v0.9.9'

env:
  R2_BUCKET: deepstudent
  KEEP_VERSIONS: 10

jobs:
  upload-to-r2:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve tag
        id: tag
        run: |
          if [ -n "${{ github.event.release.tag_name }}" ]; then
            echo "value=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "value=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          fi
          echo "ðŸ“Œ Tag: $(cat $GITHUB_OUTPUT | grep value | cut -d= -f2)"

      - name: Download Release Assets
        uses: robinraju/release-downloader@v1.10
        with:
          repository: ${{ github.repository }}
          tag: ${{ steps.tag.outputs.value }}
          fileName: "*"
          out-file-path: "dist"

      - name: Show downloaded files
        run: ls -lh dist/

      - name: Install and configure rclone
        run: |
          curl -sSL https://rclone.org/install.sh | sudo bash
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << EOF
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${{ secrets.R2_ACCESS_KEY_ID }}
          secret_access_key = ${{ secrets.R2_SECRET_ACCESS_KEY }}
          endpoint = https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com
          no_check_bucket = true
          EOF
          echo "âœ… rclone configured"

      - name: Upload to R2
        run: |
          TAG="${{ steps.tag.outputs.value }}"
          echo "ðŸ“¤ Uploading release ${TAG} to R2..."
          rclone copy dist/ "r2:${R2_BUCKET}/releases/${TAG}/" --progress
          echo "âœ… Upload complete"
          rclone ls "r2:${R2_BUCKET}/releases/${TAG}/"

      - name: Cleanup old versions (keep latest ${{ env.KEEP_VERSIONS }})
        run: |
          echo "ðŸ§¹ Checking for old versions to clean up..."

          # åˆ—å‡ºæ‰€æœ‰ç‰ˆæœ¬ç›®å½•
          ALL_VERSIONS=$(rclone lsf "r2:${R2_BUCKET}/releases/" --dirs-only | sed 's|/||' | sort -V)

          TOTAL=$(echo "$ALL_VERSIONS" | grep -c . || true)
          echo "Found ${TOTAL} versions in R2"

          if [ "$TOTAL" -le "$KEEP_VERSIONS" ]; then
            echo "âœ… No cleanup needed (${TOTAL} â‰¤ ${KEEP_VERSIONS})"
            exit 0
          fi

          # è®¡ç®—éœ€è¦åˆ é™¤çš„ç‰ˆæœ¬æ•°
          DELETE_COUNT=$((TOTAL - KEEP_VERSIONS))
          TO_DELETE=$(echo "$ALL_VERSIONS" | head -n "$DELETE_COUNT")

          echo "ðŸ—‘ï¸ Deleting ${DELETE_COUNT} old versions:"
          echo "$TO_DELETE" | while read -r VERSION; do
            [ -z "$VERSION" ] && continue
            echo "  Removing releases/${VERSION}/..."
            rclone purge "r2:${R2_BUCKET}/releases/${VERSION}/"
          done

          echo "âœ… Cleanup complete. Remaining versions:"
          rclone lsf "r2:${R2_BUCKET}/releases/" --dirs-only | sort -V | sed 's|^|  |'
