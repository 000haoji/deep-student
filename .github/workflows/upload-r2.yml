# è‡ªåŠ¨åŒæ­¥ GitHub Release äº§ç‰©åˆ° Cloudflare R2
#
# è§¦å‘: Release å‘å¸ƒæ—¶è‡ªåŠ¨è¿è¡Œï¼Œä¹Ÿæ”¯æŒæ‰‹åŠ¨è§¦å‘
# åŠŸèƒ½:
#   1. ä¸‹è½½å½“å‰ Release çš„æ‰€æœ‰é™„ä»¶å¹¶ä¸Šä¼ åˆ° R2
#   2. æ¸…ç†æ—§ç‰ˆæœ¬ï¼Œä»…ä¿ç•™æœ€è¿‘ KEEP_VERSIONS ä¸ªç‰ˆæœ¬
#
# éœ€è¦åœ¨ä»“åº“ Settings â†’ Secrets ä¸­é…ç½®:
#   CLOUDFLARE_ACCOUNT_ID  - Cloudflare è´¦æˆ· ID
#   CLOUDFLARE_API_TOKEN   - Cloudflare API Token (éœ€è¦ R2 Edit æƒé™)

name: Release to R2

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'è¦åŒæ­¥çš„ Release tagï¼ˆå¦‚ v0.9.9ï¼‰'
        required: true
        default: 'v0.9.9'

env:
  R2_BUCKET: deepstudent
  KEEP_VERSIONS: 10

jobs:
  upload-to-r2:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve tag
        id: tag
        run: |
          if [ -n "${{ github.event.release.tag_name }}" ]; then
            echo "value=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "value=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          fi
          echo "ğŸ“Œ Tag: $(grep value $GITHUB_OUTPUT | cut -d= -f2)"

      - name: Download Release Assets
        uses: robinraju/release-downloader@v1.10
        with:
          repository: ${{ github.repository }}
          tag: ${{ steps.tag.outputs.value }}
          fileName: "*"
          out-file-path: "dist"

      - name: Show downloaded files
        run: ls -lh dist/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Upload to R2
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          TAG="${{ steps.tag.outputs.value }}"
          echo "ğŸ“¤ Uploading release ${TAG} to R2..."
          for FILE in dist/*; do
            NAME=$(basename "$FILE")
            echo "  â¬†ï¸ ${NAME}..."
            npx wrangler r2 object put "${R2_BUCKET}/releases/${TAG}/${NAME}" \
              --file "$FILE" --content-type "application/octet-stream"
          done
          echo "âœ… Upload complete"
          echo "ğŸ“‹ Listing uploaded files:"
          npx wrangler r2 object list "${R2_BUCKET}" --prefix "releases/${TAG}/" \
            | grep -o '"key":"[^"]*"' | sed 's/"key":"//;s/"//' | sed 's|^|  |'

      - name: Cleanup old versions (keep latest ${{ env.KEEP_VERSIONS }})
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "ğŸ§¹ Checking for old versions to clean up..."

          # åˆ—å‡ºæ‰€æœ‰ç‰ˆæœ¬å‰ç¼€
          ALL_VERSIONS=$(npx wrangler r2 object list "${R2_BUCKET}" --prefix "releases/" \
            | grep -o '"key":"releases/[^/]*/' | sed 's/"key":"releases\///;s/\///' \
            | sort -uV)

          TOTAL=$(echo "$ALL_VERSIONS" | grep -c . || true)
          echo "Found ${TOTAL} versions in R2"

          if [ "$TOTAL" -le "$KEEP_VERSIONS" ]; then
            echo "âœ… No cleanup needed (${TOTAL} â‰¤ ${KEEP_VERSIONS})"
            exit 0
          fi

          DELETE_COUNT=$((TOTAL - KEEP_VERSIONS))
          TO_DELETE=$(echo "$ALL_VERSIONS" | head -n "$DELETE_COUNT")

          echo "ğŸ—‘ï¸ Deleting ${DELETE_COUNT} old versions:"
          echo "$TO_DELETE" | while read -r VERSION; do
            [ -z "$VERSION" ] && continue
            echo "  Removing releases/${VERSION}/..."
            # åˆ—å‡ºè¯¥ç‰ˆæœ¬ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å¹¶é€ä¸ªåˆ é™¤
            npx wrangler r2 object list "${R2_BUCKET}" --prefix "releases/${VERSION}/" \
              | grep -o '"key":"[^"]*"' | sed 's/"key":"//;s/"//' \
              | while read -r KEY; do
                npx wrangler r2 object delete "${R2_BUCKET}/${KEY}"
              done
          done

          echo "âœ… Cleanup complete"
