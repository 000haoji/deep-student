# è‡ªåŠ¨åŒæ­¥ GitHub Release äº§ç‰©åˆ° Cloudflare R2
#
# è§¦å‘: Release å‘å¸ƒæ—¶è‡ªåŠ¨è¿è¡Œï¼Œä¹Ÿæ”¯æŒæ‰‹åŠ¨è§¦å‘
# åŠŸèƒ½:
#   1. ä¸‹è½½å½“å‰ Release çš„æ‰€æœ‰é™„ä»¶å¹¶ä¸Šä¼ åˆ° R2
#   2. æ¸…ç†æ—§ç‰ˆæœ¬ï¼Œä»…ä¿ç•™æœ€è¿‘ KEEP_VERSIONS ä¸ªç‰ˆæœ¬
#
# éœ€è¦åœ¨ä»“åº“ Settings â†’ Secrets ä¸­é…ç½®:
#   CLOUDFLARE_ACCOUNT_ID  - Cloudflare è´¦æˆ· ID
#   CLOUDFLARE_API_TOKEN   - Cloudflare API Token (éœ€è¦ R2 Edit æƒé™)

name: Release to R2

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'è¦åŒæ­¥çš„ Release tagï¼ˆå¦‚ v0.9.9ï¼‰'
        required: true
        default: 'v0.9.9'

env:
  R2_BUCKET: deepstudent
  KEEP_VERSIONS: 10

jobs:
  upload-to-r2:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Resolve tag
        id: tag
        run: |
          if [ -n "${{ github.event.release.tag_name }}" ]; then
            echo "value=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "value=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          fi
          echo "ðŸ“Œ Tag: $(grep value $GITHUB_OUTPUT | cut -d= -f2)"

      - name: Download Release Assets
        uses: robinraju/release-downloader@v1.10
        with:
          repository: ${{ github.repository }}
          tag: ${{ steps.tag.outputs.value }}
          fileName: "*"
          out-file-path: "dist"

      - name: Show downloaded files
        run: ls -lh dist/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Upload to R2
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          TAG="${{ steps.tag.outputs.value }}"
          echo "ðŸ“¤ Uploading release ${TAG} to R2..."
          for FILE in dist/*; do
            NAME=$(basename "$FILE")
            echo "  â¬†ï¸ ${NAME}..."
            npx wrangler r2 object put "${R2_BUCKET}/releases/${TAG}/${NAME}" \
              --file "$FILE" --content-type "application/octet-stream" --remote
          done
          echo "âœ… Upload complete ($(ls dist/ | wc -l | tr -d ' ') files)"

      - name: Cleanup old versions (keep latest ${{ env.KEEP_VERSIONS }})
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ§¹ Checking for old versions to clean up..."

          # é€šè¿‡ GitHub API èŽ·å–æ‰€æœ‰ release tagsï¼ˆæŒ‰å‘å¸ƒæ—¶é—´å€’åºï¼‰
          RELEASES=$(gh api repos/${{ github.repository }}/releases \
            --paginate -q '.[].tag_name')

          TOTAL=$(echo "$RELEASES" | grep -c . || true)
          echo "Found ${TOTAL} releases on GitHub"

          if [ "$TOTAL" -le "$KEEP_VERSIONS" ]; then
            echo "âœ… No cleanup needed (${TOTAL} â‰¤ ${KEEP_VERSIONS})"
            exit 0
          fi

          # è·³è¿‡æœ€æ–°çš„ KEEP_VERSIONS ä¸ªï¼Œåˆ é™¤æ›´æ—§çš„
          TO_DELETE=$(echo "$RELEASES" | tail -n +$((KEEP_VERSIONS + 1)))
          DELETE_COUNT=$(echo "$TO_DELETE" | grep -c . || true)

          echo "ðŸ—‘ï¸ Deleting ${DELETE_COUNT} old versions from R2:"
          echo "$TO_DELETE" | while read -r OLD_TAG; do
            [ -z "$OLD_TAG" ] && continue
            echo "  Removing releases/${OLD_TAG}/..."
            # èŽ·å–è¯¥ release çš„æ‰€æœ‰ asset æ–‡ä»¶åï¼Œé€ä¸ªä»Ž R2 åˆ é™¤
            ASSETS=$(gh api "repos/${{ github.repository }}/releases/tags/${OLD_TAG}" \
              -q '.assets[].name' 2>/dev/null || true)
            echo "$ASSETS" | while read -r NAME; do
              [ -z "$NAME" ] && continue
              npx wrangler r2 object delete "${R2_BUCKET}/releases/${OLD_TAG}/${NAME}" --remote 2>/dev/null || true
            done
          done

          echo "âœ… Cleanup complete"
