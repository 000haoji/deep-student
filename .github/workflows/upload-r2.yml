# è‡ªåŠ¨åŒæ­¥ GitHub Release äº§ç‰©åˆ° Cloudflare R2
#
# è§¦å‘: Release å‘å¸ƒæ—¶è‡ªåŠ¨è¿è¡Œï¼Œä¹Ÿæ”¯æŒæ‰‹åŠ¨è§¦å‘
# åŠŸèƒ½:
#   1. ä¸‹è½½å½“å‰ Release çš„æ‰€æœ‰é™„ä»¶å¹¶ä¸Šä¼ åˆ° R2
#   2. æ¸…ç†æ—§ç‰ˆæœ¬ï¼Œä»…ä¿ç•™æœ€è¿‘ KEEP_VERSIONS ä¸ªç‰ˆæœ¬
#
# éœ€è¦åœ¨ä»“åº“ Settings â†’ Secrets ä¸­é…ç½®:
#   CLOUDFLARE_ACCOUNT_ID  - Cloudflare è´¦æˆ· ID
#   CLOUDFLARE_API_TOKEN   - Cloudflare API Token (éœ€è¦ R2 Edit æƒé™)

name: Release to R2

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'è¦åŒæ­¥çš„ Release tagï¼ˆå¦‚ v0.9.9ï¼‰'
        required: true
        default: 'v0.9.9'

env:
  R2_BUCKET: deepstudent
  KEEP_VERSIONS: 10

jobs:
  upload-to-r2:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Resolve tag
        id: tag
        run: |
          if [ -n "${{ github.event.release.tag_name }}" ]; then
            echo "value=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "value=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          fi
          echo "ðŸ“Œ Tag: $(grep value $GITHUB_OUTPUT | cut -d= -f2)"

      - name: Download Release Assets
        uses: robinraju/release-downloader@v1.10
        with:
          repository: ${{ github.repository }}
          tag: ${{ steps.tag.outputs.value }}
          fileName: "*"
          out-file-path: "dist"

      - name: Show downloaded files
        run: ls -lh dist/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Upload to R2
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          TAG="${{ steps.tag.outputs.value }}"
          echo "ðŸ“¤ Uploading release ${TAG} to R2..."
          for FILE in dist/*; do
            NAME=$(basename "$FILE")
            # æ ¹æ®æ‰©å±•åè®¾ç½® Content-Type
            case "$NAME" in
              *.json) CT="application/json" ;;
              *.sig)  CT="application/pgp-signature" ;;
              *.dmg)  CT="application/x-apple-diskimage" ;;
              *.apk)  CT="application/vnd.android.package-archive" ;;
              *)      CT="application/octet-stream" ;;
            esac
            echo "  â¬†ï¸ ${NAME} (${CT})"
            npx wrangler r2 object put "${R2_BUCKET}/releases/${TAG}/${NAME}" \
              --file "$FILE" --content-type "$CT" \
              --cache-control "public, max-age=31536000, immutable" --remote
          done
          echo "âœ… Upload complete ($(ls dist/ | wc -l | tr -d ' ') files)"

      - name: Generate R2 latest.json for auto-updater
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          TAG="${{ steps.tag.outputs.value }}"
          R2_BASE="https://download.deepstudent.cn/releases/${TAG}"

          if [ ! -f dist/latest.json ]; then
            echo "âš ï¸ No latest.json in release assets, skipping"
            exit 0
          fi

          echo "ðŸ“ Rewriting latest.json URLs to R2..."
          # å°† GitHub ä¸‹è½½ URL æ›¿æ¢ä¸º R2 URL
          jq --arg base "$R2_BASE" '
            .platforms |= with_entries(
              .value.url = ($base + "/" + (.value.url | split("/") | last))
            )
          ' dist/latest.json > r2-latest.json

          echo "Original:"
          jq -r '.platforms[].url' dist/latest.json
          echo "R2 version:"
          jq -r '.platforms[].url' r2-latest.json

          # ä¸Šä¼ åˆ°ç¨³å®šè·¯å¾„ releases/latest.jsonï¼ˆTauri updater ç«¯ç‚¹ï¼‰
          npx wrangler r2 object put "${R2_BUCKET}/releases/latest.json" \
            --file r2-latest.json --content-type "application/json" \
            --cache-control "public, max-age=300" --remote
          echo "âœ… R2 latest.json uploaded to releases/latest.json"

      - name: Cleanup old versions (keep latest ${{ env.KEEP_VERSIONS }})
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ§¹ Checking for old versions to clean up..."

          # é€šè¿‡ GitHub API èŽ·å–æ‰€æœ‰ release tagsï¼ˆæŒ‰å‘å¸ƒæ—¶é—´å€’åºï¼‰
          RELEASES=$(gh api repos/${{ github.repository }}/releases \
            --paginate -q '.[].tag_name')

          TOTAL=$(echo "$RELEASES" | grep -c . || true)
          echo "Found ${TOTAL} releases on GitHub"

          if [ "$TOTAL" -le "$KEEP_VERSIONS" ]; then
            echo "âœ… No cleanup needed (${TOTAL} â‰¤ ${KEEP_VERSIONS})"
            exit 0
          fi

          # è·³è¿‡æœ€æ–°çš„ KEEP_VERSIONS ä¸ªï¼Œåˆ é™¤æ›´æ—§çš„
          TO_DELETE=$(echo "$RELEASES" | tail -n +$((KEEP_VERSIONS + 1)))
          DELETE_COUNT=$(echo "$TO_DELETE" | grep -c . || true)

          echo "ðŸ—‘ï¸ Deleting ${DELETE_COUNT} old versions from R2:"
          echo "$TO_DELETE" | while read -r OLD_TAG; do
            [ -z "$OLD_TAG" ] && continue
            echo "  Removing releases/${OLD_TAG}/..."
            # èŽ·å–è¯¥ release çš„æ‰€æœ‰ asset æ–‡ä»¶åï¼Œé€ä¸ªä»Ž R2 åˆ é™¤
            ASSETS=$(gh api "repos/${{ github.repository }}/releases/tags/${OLD_TAG}" \
              -q '.assets[].name' 2>/dev/null || true)
            echo "$ASSETS" | while read -r NAME; do
              [ -z "$NAME" ] && continue
              npx wrangler r2 object delete "${R2_BUCKET}/releases/${OLD_TAG}/${NAME}" --remote 2>/dev/null || true
            done
          done

          echo "âœ… Cleanup complete"
