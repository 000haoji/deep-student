# ä»“åº“é˜²ç¯¡æ”¹å¿«ç…§å¤‡ä»½å·¥ä½œæµ
#
# ç­–ç•¥ï¼šå¢é‡æ¨é€ + ä¸å¯å˜å¿«ç…§æ ‡ç­¾ï¼Œé˜²æ­¢ä¸»ä»“åº“è¢«æŠ•æ¯’æ—¶ä¼ æŸ“å¤‡ä»½ã€‚
#
# ä¸ --mirror çš„åŒºåˆ«ï¼š
#   --mirrorï¼šå®Œå…¨è¦†ç›–å¤‡ä»½ä»“åº“ï¼ˆä¸»ä»“åº“è¢«ç¯¡æ”¹ â†’ å¤‡ä»½ä¹Ÿè¢«è¦†ç›–ï¼‰
#   æœ¬æ–¹æ¡ˆï¼šä»…è¿½åŠ æ–°å†…å®¹ï¼Œä¸åˆ é™¤å¤‡ä»½ä¸­å·²æœ‰çš„åˆ†æ”¯/æ ‡ç­¾/å†å²
#          + æ¯æ¬¡åˆ›å»º backup/YYYY-MM-DD å¿«ç…§æ ‡ç­¾ï¼ˆä¸å¯å˜æ£€æŸ¥ç‚¹ï¼‰
#          + æ£€æµ‹ force-push ç­‰å¼‚å¸¸æ“ä½œï¼Œå‘ç°å³ä¸­æ­¢å¹¶å‘Šè­¦
#
# æ¢å¤æ–¹å¼ï¼š
#   git clone git@github.com:000haoji/deep-student-backup.git
#   git checkout backup/2026-02-17   # æ¢å¤åˆ°ä»»æ„æ—¥æœŸçš„å¹²å‡€å¿«ç…§
#
# å¤‡ä»½ç›®æ ‡: 000haoji/deep-student-backup (private)
#
# éœ€è¦åœ¨ä¸»ä»“åº“ Settings â†’ Secrets ä¸­é…ç½®:
#   BACKUP_DEPLOY_KEY â€” å¤‡ä»½ä»“åº“çš„ SSH deploy keyï¼ˆå·²é…ç½®ï¼Œwrite æƒé™ï¼‰

name: Backup

on:
  schedule:
    # æ¯å¤© UTC 04:00ï¼ˆåŒ—äº¬æ—¶é—´ 12:00ï¼‰æ‰§è¡Œ
    - cron: '0 4 * * *'
  workflow_dispatch:

env:
  BACKUP_REPO: "000haoji/deep-student-backup"

jobs:
  backup:
    name: Snapshot backup
    runs-on: ubuntu-latest
    steps:
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.BACKUP_DEPLOY_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
          cat > ~/.ssh/config << 'EOF'
          Host github.com
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
          EOF

      - name: Clone source repo
        run: git clone --bare https://github.com/${{ github.repository }}.git source.git

      - name: Clone backup repo
        run: git clone --bare git@github.com:${{ env.BACKUP_REPO }}.git backup.git 2>/dev/null || mkdir backup.git

      - name: Tamper detection
        id: check
        run: |
          SOURCE_HEAD=$(git -C source.git rev-parse refs/heads/main 2>/dev/null || echo "")
          BACKUP_HEAD=$(git -C backup.git rev-parse refs/heads/main 2>/dev/null || echo "")

          echo "source_head=${SOURCE_HEAD}" >> $GITHUB_OUTPUT
          echo "backup_head=${BACKUP_HEAD}" >> $GITHUB_OUTPUT

          if [ -z "$BACKUP_HEAD" ]; then
            echo "ğŸ“¦ First backup â€” no history to compare"
            echo "safe=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ "$SOURCE_HEAD" = "$BACKUP_HEAD" ]; then
            echo "âœ… No changes since last backup"
            echo "safe=true" >> $GITHUB_OUTPUT
            echo "unchanged=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # æ£€æµ‹ force-pushï¼šä¸»ä»“åº“ HEAD æ˜¯å¦åŒ…å«å¤‡ä»½çš„ HEADï¼ˆæ­£å¸¸åº”è¯¥æ˜¯ç¥–å…ˆå…³ç³»ï¼‰
          cd source.git
          if git merge-base --is-ancestor "$BACKUP_HEAD" "$SOURCE_HEAD" 2>/dev/null; then
            COMMITS_AHEAD=$(git rev-list --count "${BACKUP_HEAD}..${SOURCE_HEAD}")
            echo "âœ… Clean fast-forward: ${COMMITS_AHEAD} new commits"
            echo "safe=true" >> $GITHUB_OUTPUT

            # é¢å¤–æ£€æŸ¥ï¼šå•æ¬¡è¶…è¿‡ 500 commit è§†ä¸ºå¼‚å¸¸ï¼ˆé˜²æ­¢å¤§è§„æ¨¡å†å²ç¯¡æ”¹ï¼‰
            if [ "$COMMITS_AHEAD" -gt 500 ]; then
              echo "âš ï¸ WARNING: Unusually large update (${COMMITS_AHEAD} commits)"
              echo "safe=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "ğŸš¨ ALERT: Force-push detected! Source HEAD is NOT a descendant of backup HEAD."
            echo "  Backup HEAD: ${BACKUP_HEAD}"
            echo "  Source HEAD: ${SOURCE_HEAD}"
            echo "  Backup will be SKIPPED to protect clean history."
            echo "safe=false" >> $GITHUB_OUTPUT
          fi

      - name: Push updates (incremental, no deletions)
        if: steps.check.outputs.safe == 'true' && steps.check.outputs.unchanged != 'true'
        run: |
          cd source.git
          # æ¨é€æ‰€æœ‰åˆ†æ”¯å’Œæ ‡ç­¾ï¼Œä½†ä¸åˆ é™¤å¤‡ä»½ä¸­å·²æœ‰çš„ refsï¼ˆå…³é”®ï¼šä¸ç”¨ --mirrorï¼‰
          git push git@github.com:${{ env.BACKUP_REPO }}.git 'refs/heads/*:refs/heads/*' --force 2>&1 || true
          git push git@github.com:${{ env.BACKUP_REPO }}.git 'refs/tags/*:refs/tags/*' --force 2>&1 || true
          echo "âœ… Incremental push completed"

      - name: Create snapshot tag
        if: steps.check.outputs.safe == 'true' && steps.check.outputs.unchanged != 'true'
        run: |
          cd source.git
          git config user.name "backup-bot"
          git config user.email "backup@deep-student"

          DATE=$(date -u +%Y-%m-%d)
          TAG="backup/${DATE}"
          SOURCE_HEAD="${{ steps.check.outputs.source_head }}"

          # åˆ›å»ºå¿«ç…§æ ‡ç­¾ï¼ˆå¦‚æœä»Šå¤©å·²å­˜åœ¨åˆ™è·³è¿‡ï¼‰
          if git tag -a "$TAG" "$SOURCE_HEAD" -m "Daily backup snapshot ${DATE}" 2>&1; then
            git push git@github.com:${{ env.BACKUP_REPO }}.git "refs/tags/${TAG}" 2>&1
            echo "ğŸ“¸ Snapshot created: ${TAG} â†’ ${SOURCE_HEAD}"
          else
            echo "â„¹ï¸ Snapshot tag ${TAG} already exists (multiple backups today)"
          fi

      - name: Alert on failure
        if: steps.check.outputs.safe == 'false'
        run: |
          echo "::error::ğŸš¨ Backup BLOCKED â€” anomaly detected in source repository!"
          echo "::error::Check the 'Tamper detection' step for details."
          echo "::error::Backup repo preserves last known good state."
          exit 1

      - name: Cleanup
        if: always()
        run: rm -rf ~/.ssh/deploy_key source.git backup.git
