# è‡ªåŠ¨å‘å¸ƒå·¥ä½œæµ
#
# è§¦å‘æ–¹å¼:
#   1. æ¨é€åˆ° main â†’ release-please è‡ªåŠ¨ç®¡ç† Release PR
#   2. åˆå¹¶ Release PR â†’ è‡ªåŠ¨æ„å»º + å‘å¸ƒå…¨å¹³å°äº§ç‰©
#   3. æ¨é€ v* æ ‡ç­¾ â†’ æ‰‹åŠ¨è§¦å‘æ„å»º + å‘å¸ƒï¼ˆå…¼å®¹æ—§æ–¹å¼ï¼‰
#
# éœ€è¦åœ¨ä»“åº“ Settings â†’ Secrets ä¸­é…ç½®:
#   TAURI_SIGNING_PRIVATE_KEY          - Tauri æ›´æ–°ç­¾åç§é’¥
#   TAURI_SIGNING_PRIVATE_KEY_PASSWORD - ç§é’¥å¯†ç 
#
# Android ç­¾å:
#   ANDROID_KEYSTORE_BASE64            - release.keystore çš„ base64 ç¼–ç 
#   ANDROID_KEYSTORE_PASSWORD          - å¯†é’¥åº“å¯†ç 
#   ANDROID_KEY_ALIAS                  - å¯†é’¥åˆ«å (é»˜è®¤ deepstudent)
#   ANDROID_KEY_PASSWORD               - å¯†é’¥å¯†ç 
#
# macOS å…¬è¯ï¼ˆå¯é€‰ï¼‰:
#   APPLE_SIGNING_IDENTITY / APPLE_ID / APPLE_PASSWORD / APPLE_TEAM_ID

name: Release

on:
  push:
    branches: [main]
    tags: ['v*']

env:
  GITHUB_REPO: ${{ github.repository }}

jobs:
  # â”€â”€â”€ Release Please â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  release-please:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  # â”€â”€â”€ å‡†å¤‡é˜¶æ®µ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  prepare:
    needs: [release-please]
    if: always() && !failure() && !cancelled()
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      version: ${{ steps.check.outputs.version }}
      tag_name: ${{ steps.check.outputs.tag_name }}
    steps:
      - id: check
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "tag_name=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
            echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
            echo "ğŸ·ï¸ Manual tag push: ${GITHUB_REF_NAME}"
          elif [[ "${{ needs.release-please.outputs.release_created }}" == "true" ]]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            TAG="${{ needs.release-please.outputs.tag_name }}"
            echo "tag_name=${TAG}" >> $GITHUB_OUTPUT
            echo "version=${TAG#v}" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Release created by release-please: ${TAG}"
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ No release needed, skipping builds"
          fi

  # â”€â”€â”€ macOS æ„å»º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-macos:
    needs: [prepare]
    if: always() && needs.prepare.outputs.should_build == 'true'
    runs-on: macos-latest
    env:
      NODE_OPTIONS: '--max-old-space-size=4096'
    strategy:
      fail-fast: false
      matrix:
        target: [aarch64-apple-darwin, x86_64-apple-darwin]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.prepare.outputs.tag_name }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install dependencies
        run: npm ci

      - name: Generate version info
        run: node scripts/generate-version.mjs

      - name: Build Tauri app
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: npx tauri build --target ${{ matrix.target }}

      - name: Rename updater artifacts with arch suffix
        run: |
          BUNDLE_DIR="src-tauri/target/${{ matrix.target }}/release/bundle/macos"
          ARCH=$(echo "${{ matrix.target }}" | cut -d'-' -f1)
          for f in "$BUNDLE_DIR"/*.app.tar.gz; do
            [ -f "$f" ] || continue
            # ç©ºæ ¼â†’ç‚¹å·ï¼Œé¿å… URL è§£æå¤±è´¥
            BASE=$(basename "$f" .app.tar.gz | tr ' ' '.')
            mv "$f" "$BUNDLE_DIR/${BASE}_${ARCH}.app.tar.gz"
            [ -f "$f.sig" ] && mv "$f.sig" "$BUNDLE_DIR/${BASE}_${ARCH}.app.tar.gz.sig"
          done
          echo "ğŸ“¦ Renamed updater artifacts:"
          ls -la "$BUNDLE_DIR"/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.target }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app.tar.gz
            src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app.tar.gz.sig
            src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg

  # â”€â”€â”€ Windows æ„å»º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-windows:
    needs: [prepare]
    if: always() && needs.prepare.outputs.should_build == 'true'
    runs-on: windows-latest
    env:
      NODE_OPTIONS: '--max-old-space-size=4096'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.prepare.outputs.tag_name }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install dependencies
        run: npm ci

      - name: Generate version info
        run: node scripts/generate-version.mjs

      - name: Build Tauri app
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: npx tauri build --target x86_64-pc-windows-msvc

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x86_64
          path: |
            src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*.exe
            src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*.exe.sig

  # â”€â”€â”€ Android æ„å»º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-android:
    needs: [prepare]
    if: always() && needs.prepare.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: '--max-old-space-size=4096'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.prepare.outputs.tag_name }}

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android/sdk/ndk /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Android SDK & NDK
        run: |
          yes | ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager \
            "ndk;27.0.12077973" "build-tools;35.0.0" "platforms;android-35" | tail -3
          echo "NDK_HOME=${ANDROID_HOME}/ndk/27.0.12077973" >> $GITHUB_ENV

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      - name: Setup protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install dependencies
        run: npm ci

      - name: Generate version info
        run: node scripts/generate-version.mjs

      - name: Initialize Android project
        run: npx tauri android init

      - name: Bundle pdfium for Android
        run: |
          JNILIBS_DIR="src-tauri/gen/android/app/src/main/jniLibs/arm64-v8a"
          mkdir -p "$JNILIBS_DIR"
          if [ -f "src-tauri/resources/pdfium/libpdfium_android_arm64.so" ]; then
            cp src-tauri/resources/pdfium/libpdfium_android_arm64.so "$JNILIBS_DIR/libpdfium.so"
            echo "âœ… Bundled pdfium for arm64: $(ls -lh "$JNILIBS_DIR/libpdfium.so" | awk '{print $5}')"
          else
            echo "âš ï¸ Android pdfium .so not found, downloading..."
            bash scripts/download-pdfium.sh android-arm64
            cp src-tauri/resources/pdfium/libpdfium_android_arm64.so "$JNILIBS_DIR/libpdfium.so"
            echo "âœ… Downloaded and bundled pdfium for arm64"
          fi

      - name: Configure NDK toolchain
        run: |
          NDK_PREBUILT="${NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64"

          sed -i '/\[target.aarch64-linux-android\]/,/^$/{ s|linker = .*|linker = "'"${NDK_PREBUILT}"'/bin/aarch64-linux-android21-clang"|; s|ar = .*|ar = "'"${NDK_PREBUILT}"'/bin/llvm-ar"| }' src-tauri/.cargo/config.toml

          echo "CC_aarch64_linux_android=${NDK_PREBUILT}/bin/aarch64-linux-android21-clang" >> $GITHUB_ENV
          echo "CXX_aarch64_linux_android=${NDK_PREBUILT}/bin/aarch64-linux-android21-clang++" >> $GITHUB_ENV
          echo "AR_aarch64_linux_android=${NDK_PREBUILT}/bin/llvm-ar" >> $GITHUB_ENV
          echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=${NDK_PREBUILT}/bin/aarch64-linux-android21-clang" >> $GITHUB_ENV

          echo "âœ… NDK toolchain configured:"
          cat src-tauri/.cargo/config.toml | grep -A2 aarch64-linux-android

      - name: Build Android APK
        run: npx tauri android build --target aarch64

      - name: Sign APK
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          echo "${ANDROID_KEYSTORE_BASE64}" | base64 -d > /tmp/release.keystore

          UNSIGNED_APK=$(find src-tauri/gen/android -name "*-unsigned.apk" -type f | head -1)
          if [ -z "$UNSIGNED_APK" ]; then
            echo "::error::æœªæ‰¾åˆ°æœªç­¾åçš„ APK"
            find src-tauri/gen/android -name "*.apk" -type f
            exit 1
          fi
          echo "æ‰¾åˆ° APK: $UNSIGNED_APK"

          BUILD_TOOLS=$(ls -d "${ANDROID_HOME}/build-tools/"* | sort -V | tail -1)

          "${BUILD_TOOLS}/zipalign" -v 4 "$UNSIGNED_APK" /tmp/aligned.apk

          "${BUILD_TOOLS}/apksigner" sign \
            --ks /tmp/release.keystore \
            --ks-key-alias "${ANDROID_KEY_ALIAS:-deepstudent}" \
            --ks-pass "pass:${ANDROID_KEYSTORE_PASSWORD}" \
            --key-pass "pass:${ANDROID_KEY_PASSWORD}" \
            --in /tmp/aligned.apk \
            --out /tmp/signed.apk

          "${BUILD_TOOLS}/apksigner" verify --print-certs /tmp/signed.apk

          VERSION="${{ needs.prepare.outputs.version }}"
          mkdir -p android-output
          cp /tmp/signed.apk "android-output/Deep.Student_${VERSION}_arm64.apk"

          rm -f /tmp/release.keystore

          echo "âœ… APK ç­¾åå®Œæˆ: Deep.Student_${VERSION}_arm64.apk"
          ls -lh android-output/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-arm64
          path: android-output/*.apk

  # â”€â”€â”€ å‘å¸ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  publish:
    needs: [prepare, build-macos, build-windows, build-android]
    # æ¡Œé¢ç«¯æ„å»ºå¿…é¡»æˆåŠŸï¼›Android å…è®¸å¤±è´¥ï¼ˆä¸é˜»å¡æ¡Œé¢å‘å¸ƒï¼‰
    if: |
      always() &&
      needs.prepare.outputs.should_build == 'true' &&
      needs.build-macos.result == 'success' &&
      needs.build-windows.result == 'success' &&
      !cancelled()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifact structure
        run: find artifacts -type f | head -50

      - name: Normalize artifact filenames
        run: |
          # å°†æ‰€æœ‰äº§ç‰©æ–‡ä»¶åä¸­çš„ç©ºæ ¼æ›¿æ¢ä¸ºç‚¹å·ï¼Œé¿å… URL è§£æå¤±è´¥
          find artifacts -type f -name '* *' | while IFS= read -r f; do
            DIR=$(dirname "$f")
            OLD=$(basename "$f")
            NEW=$(echo "$OLD" | tr ' ' '.')
            mv "$f" "$DIR/$NEW"
            echo "  Renamed: $OLD â†’ $NEW"
          done

      - name: Generate latest.json
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          REPO="${{ github.repository }}"
          TAG="${{ needs.prepare.outputs.tag_name }}"
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          PLATFORMS="{}"

          # â”€â”€ macOS aarch64 â”€â”€
          MACOS_ARM_DIR="artifacts/macos-aarch64-apple-darwin"
          if [ -d "$MACOS_ARM_DIR" ]; then
            TAR=$(find "$MACOS_ARM_DIR" -name "*_aarch64.app.tar.gz" ! -name "*.sig" | head -1)
            SIG=$(find "$MACOS_ARM_DIR" -name "*_aarch64.app.tar.gz.sig" | head -1)
            if [ -n "$TAR" ] && [ -n "$SIG" ]; then
              TAR_NAME=$(basename "$TAR")
              SIGNATURE=$(cat "$SIG")
              PLATFORMS=$(echo "$PLATFORMS" | jq --arg url "https://github.com/$REPO/releases/download/$TAG/$TAR_NAME" \
                --arg sig "$SIGNATURE" \
                '. + {"darwin-aarch64": {"url": $url, "signature": $sig}}')
            fi
          fi

          # â”€â”€ macOS x86_64 â”€â”€
          MACOS_X64_DIR="artifacts/macos-x86_64-apple-darwin"
          if [ -d "$MACOS_X64_DIR" ]; then
            TAR=$(find "$MACOS_X64_DIR" -name "*_x86_64.app.tar.gz" ! -name "*.sig" | head -1)
            SIG=$(find "$MACOS_X64_DIR" -name "*_x86_64.app.tar.gz.sig" | head -1)
            if [ -n "$TAR" ] && [ -n "$SIG" ]; then
              TAR_NAME=$(basename "$TAR")
              SIGNATURE=$(cat "$SIG")
              PLATFORMS=$(echo "$PLATFORMS" | jq --arg url "https://github.com/$REPO/releases/download/$TAG/$TAR_NAME" \
                --arg sig "$SIGNATURE" \
                '. + {"darwin-x86_64": {"url": $url, "signature": $sig}}')
            fi
          fi

          # â”€â”€ Windows x86_64 â”€â”€
          WIN_DIR="artifacts/windows-x86_64"
          if [ -d "$WIN_DIR" ]; then
            EXE=$(find "$WIN_DIR" -name "*-setup.exe" ! -name "*.sig" | head -1)
            SIG=$(find "$WIN_DIR" -name "*-setup.exe.sig" | head -1)
            if [ -n "$EXE" ] && [ -n "$SIG" ]; then
              EXE_NAME=$(basename "$EXE")
              SIGNATURE=$(cat "$SIG")
              PLATFORMS=$(echo "$PLATFORMS" | jq --arg url "https://github.com/$REPO/releases/download/$TAG/$EXE_NAME" \
                --arg sig "$SIGNATURE" \
                '. + {"windows-x86_64": {"url": $url, "signature": $sig}}')
            fi
          fi

          jq -n \
            --arg version "$VERSION" \
            --arg notes "Deep Student v$VERSION æ›´æ–°" \
            --arg pub_date "$DATE" \
            --argjson platforms "$PLATFORMS" \
            '{version: $version, notes: $notes, pub_date: $pub_date, platforms: $platforms}' \
            > latest.json

          echo "âœ… latest.json å·²ç”Ÿæˆ:"
          cat latest.json

      - name: Collect release files
        run: |
          mkdir -p release-files
          cp latest.json release-files/

          find artifacts -name "*.app.tar.gz" -exec cp {} release-files/ \;
          find artifacts -name "*.app.tar.gz.sig" -exec cp {} release-files/ \;
          find artifacts -name "*.dmg" -exec cp {} release-files/ \;
          find artifacts -name "*.exe" -exec cp {} release-files/ \;
          find artifacts -name "*.exe.sig" -exec cp {} release-files/ \;
          find artifacts -name "*.apk" -exec cp {} release-files/ \;

          echo "ğŸ“¦ Release files:"
          ls -lh release-files/

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag_name }}
          draft: false
          prerelease: false
          generate_release_notes: ${{ startsWith(github.ref, 'refs/tags/') }}
          files: release-files/*
