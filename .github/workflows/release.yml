# è‡ªåŠ¨å‘å¸ƒå·¥ä½œæµ
# è§¦å‘æ–¹å¼: æ¨é€ v* æ ‡ç­¾æ—¶è‡ªåŠ¨è¿è¡Œ
# æµç¨‹: å¤šå¹³å°æ„å»º â†’ ç­¾å â†’ ç”Ÿæˆ latest.json â†’ ä¸Šä¼ åˆ° GitHub Release
#
# éœ€è¦åœ¨ä»“åº“ Settings â†’ Secrets ä¸­é…ç½®:
#   TAURI_SIGNING_PRIVATE_KEY          - Tauri æ›´æ–°ç­¾åç§é’¥
#   TAURI_SIGNING_PRIVATE_KEY_PASSWORD - ç§é’¥å¯†ç 
#
# macOS å…¬è¯ï¼ˆå¯é€‰ï¼Œå¦‚éœ€å…¬è¯ï¼‰:
#   APPLE_SIGNING_IDENTITY             - ç­¾åèº«ä»½
#   APPLE_ID                           - Apple ID
#   APPLE_PASSWORD                     - App-specific password
#   APPLE_TEAM_ID                      - Team ID

name: Release

on:
  push:
    tags:
      - 'v*'

env:
  GITHUB_REPO: ${{ github.repository }}

jobs:
  # â”€â”€â”€ macOS æ„å»º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-macos:
    runs-on: macos-latest
    env:
      NODE_OPTIONS: '--max-old-space-size=4096'
    strategy:
      matrix:
        target: [aarch64-apple-darwin, x86_64-apple-darwin]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Build Tauri app
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: npx tauri build --target ${{ matrix.target }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.target }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app.tar.gz
            src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app.tar.gz.sig
            src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg

  # â”€â”€â”€ Windows æ„å»º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-windows:
    runs-on: windows-latest
    env:
      NODE_OPTIONS: '--max-old-space-size=4096'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Build Tauri app
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: npx tauri build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x86_64
          path: |
            src-tauri/target/release/bundle/nsis/*.nsis.zip
            src-tauri/target/release/bundle/nsis/*.nsis.zip.sig
            src-tauri/target/release/bundle/nsis/*.exe

  # â”€â”€â”€ å‘å¸ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  publish:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifact structure
        run: find artifacts -type f | head -50

      - name: Generate latest.json
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          REPO="${{ github.repository }}"
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # åˆå§‹åŒ– platforms JSON
          PLATFORMS="{}"

          # â”€â”€ macOS aarch64 â”€â”€
          MACOS_ARM_DIR="artifacts/macos-aarch64-apple-darwin"
          if [ -d "$MACOS_ARM_DIR" ]; then
            TAR=$(find "$MACOS_ARM_DIR" -name "*.app.tar.gz" ! -name "*.sig" | head -1)
            SIG=$(find "$MACOS_ARM_DIR" -name "*.app.tar.gz.sig" | head -1)
            if [ -n "$TAR" ] && [ -n "$SIG" ]; then
              TAR_NAME=$(basename "$TAR")
              SIGNATURE=$(cat "$SIG")
              PLATFORMS=$(echo "$PLATFORMS" | jq --arg url "https://github.com/$REPO/releases/download/v$VERSION/$TAR_NAME" \
                --arg sig "$SIGNATURE" \
                '. + {"darwin-aarch64": {"url": $url, "signature": $sig}}')
            fi
          fi

          # â”€â”€ macOS x86_64 â”€â”€
          MACOS_X64_DIR="artifacts/macos-x86_64-apple-darwin"
          if [ -d "$MACOS_X64_DIR" ]; then
            TAR=$(find "$MACOS_X64_DIR" -name "*.app.tar.gz" ! -name "*.sig" | head -1)
            SIG=$(find "$MACOS_X64_DIR" -name "*.app.tar.gz.sig" | head -1)
            if [ -n "$TAR" ] && [ -n "$SIG" ]; then
              TAR_NAME=$(basename "$TAR")
              SIGNATURE=$(cat "$SIG")
              PLATFORMS=$(echo "$PLATFORMS" | jq --arg url "https://github.com/$REPO/releases/download/v$VERSION/$TAR_NAME" \
                --arg sig "$SIGNATURE" \
                '. + {"darwin-x86_64": {"url": $url, "signature": $sig}}')
            fi
          fi

          # â”€â”€ Windows x86_64 â”€â”€
          WIN_DIR="artifacts/windows-x86_64"
          if [ -d "$WIN_DIR" ]; then
            ZIP=$(find "$WIN_DIR" -name "*.nsis.zip" ! -name "*.sig" | head -1)
            SIG=$(find "$WIN_DIR" -name "*.nsis.zip.sig" | head -1)
            if [ -n "$ZIP" ] && [ -n "$SIG" ]; then
              ZIP_NAME=$(basename "$ZIP")
              SIGNATURE=$(cat "$SIG")
              PLATFORMS=$(echo "$PLATFORMS" | jq --arg url "https://github.com/$REPO/releases/download/v$VERSION/$ZIP_NAME" \
                --arg sig "$SIGNATURE" \
                '. + {"windows-x86_64": {"url": $url, "signature": $sig}}')
            fi
          fi

          # ç”Ÿæˆ latest.json
          jq -n \
            --arg version "$VERSION" \
            --arg notes "Deep Student v$VERSION æ›´æ–°" \
            --arg pub_date "$DATE" \
            --argjson platforms "$PLATFORMS" \
            '{version: $version, notes: $notes, pub_date: $pub_date, platforms: $platforms}' \
            > latest.json

          echo "âœ… latest.json å·²ç”Ÿæˆ:"
          cat latest.json

      - name: Collect release files
        run: |
          mkdir -p release-files
          cp latest.json release-files/

          # å¤åˆ¶æ‰€æœ‰æ›´æ–°åŒ…å’Œç­¾å
          find artifacts -name "*.app.tar.gz" -exec cp {} release-files/ \;
          find artifacts -name "*.app.tar.gz.sig" -exec cp {} release-files/ \;
          find artifacts -name "*.nsis.zip" -exec cp {} release-files/ \;
          find artifacts -name "*.nsis.zip.sig" -exec cp {} release-files/ \;

          # å¤åˆ¶å®‰è£…åŒ…ï¼ˆä¾›ç”¨æˆ·ç›´æ¥ä¸‹è½½ï¼‰
          find artifacts -name "*.dmg" -exec cp {} release-files/ \;
          find artifacts -name "*.exe" -exec cp {} release-files/ \;

          echo "ğŸ“¦ Release files:"
          ls -lh release-files/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: false
          generate_release_notes: true
          files: release-files/*
