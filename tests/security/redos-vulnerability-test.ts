/**
 * ReDoS æ¼æ´ä¿®å¤éªŒè¯æµ‹è¯•
 *
 * æ­¤æµ‹è¯•æ–‡ä»¶æ¼”ç¤ºäº†ä¿®å¤å‰åçš„è¡Œä¸ºå·®å¼‚
 */

// ============================================================================
// ä¿®å¤å‰çš„å±é™©å®ç°ï¼ˆä»…ä¾›å‚è€ƒï¼Œä¸è¦ä½¿ç”¨ï¼‰
// ============================================================================

/**
 * âš ï¸ å±é™©ï¼šè¿™æ˜¯ä¿®å¤å‰çš„å®ç°ï¼ŒåŒ…å« ReDoS æ¼æ´
 *
 * é—®é¢˜ï¼š
 * - [^{}]*? å‡ºç°å¤šæ¬¡ï¼Œå¯¼è‡´æŒ‡æ•°çº§å›æº¯
 * - ä¸‰ä¸ª | åˆ†æ”¯ä¹‹é—´çš„å›æº¯è·¯å¾„å‘ˆæŒ‡æ•°çº§å¢é•¿
 */
function dangerousRegexExtraction_BEFORE(jsonString: string) {
  console.log('âš ï¸ ä½¿ç”¨å±é™©çš„æ­£åˆ™è¡¨è¾¾å¼...');

  const startTime = performance.now();

  // è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼æœ‰ä¸¥é‡çš„ ReDoS æ¼æ´
  const possibleObjectPattern = /\{[^{}]*?"resourceId"[^{}]*?"hash"[^{}]*?"typeId"[^{}]*?\}|\{[^{}]*?"typeId"[^{}]*?"resourceId"[^{}]*?"hash"[^{}]*?\}|\{[^{}]*?"hash"[^{}]*?"typeId"[^{}]*?"resourceId"[^{}]*?\}/gi;

  try {
    const matches = jsonString.match(possibleObjectPattern);
    const duration = performance.now() - startTime;

    console.log(`  æ‰§è¡Œæ—¶é—´: ${duration.toFixed(2)}ms`);
    console.log(`  æ‰¾åˆ°åŒ¹é…: ${matches?.length ?? 0} ä¸ª`);

    return matches ?? [];
  } catch (error) {
    console.error('  æ­£åˆ™è¡¨è¾¾å¼æ‰§è¡Œå¤±è´¥:', error);
    return [];
  }
}

// ============================================================================
// ä¿®å¤åçš„å®‰å…¨å®ç°
// ============================================================================

interface ContextRef {
  resourceId: string;
  hash: string;
  typeId: string;
}

function isValidContextRef(obj: unknown): obj is ContextRef {
  if (!obj || typeof obj !== 'object') return false;

  const ref = obj as Record<string, unknown>;

  if (typeof ref.resourceId !== 'string' || !ref.resourceId.trim()) return false;
  if (typeof ref.hash !== 'string' || !ref.hash.trim()) return false;
  if (typeof ref.typeId !== 'string' || !ref.typeId.trim()) return false;

  // éªŒè¯ resourceId æ ¼å¼
  if (!/^res_[a-zA-Z0-9_-]{10}$/.test(ref.resourceId)) return false;

  return true;
}

/**
 * âœ… å®‰å…¨ï¼šä¿®å¤åçš„å®ç°ï¼Œä½¿ç”¨å­—ç¬¦ä¸²æ‰«æ
 *
 * ä¼˜åŠ¿ï¼š
 * - æ—¶é—´å¤æ‚åº¦ O(n)
 * - æœ‰è¶…æ—¶ä¿æŠ¤
 * - æœ‰å¯¹è±¡æ•°é‡å’Œå¤§å°é™åˆ¶
 * - æ— æ­£åˆ™è¡¨è¾¾å¼å›æº¯é—®é¢˜
 */
function safeStringScanning_AFTER(jsonString: string): ContextRef[] {
  console.log('âœ… ä½¿ç”¨å®‰å…¨çš„å­—ç¬¦ä¸²æ‰«æ...');

  const scanStartTime = performance.now();
  const SCAN_TIMEOUT_MS = 5000;

  const refs: ContextRef[] = [];
  let i = 0;
  let objectsScanned = 0;
  const maxObjectsToScan = 10000;

  while (i < jsonString.length) {
    // è¶…æ—¶æ£€æŸ¥
    if (performance.now() - scanStartTime > SCAN_TIMEOUT_MS) {
      console.warn('  âš ï¸ è¶…æ—¶ä¿æŠ¤è§¦å‘ï¼Œè¿”å›éƒ¨åˆ†ç»“æœ');
      break;
    }

    // å¯¹è±¡æ•°é‡é™åˆ¶æ£€æŸ¥
    if (objectsScanned >= maxObjectsToScan) {
      console.warn('  âš ï¸ è¾¾åˆ°å¯¹è±¡æ•°é‡é™åˆ¶ï¼Œè¿”å›éƒ¨åˆ†ç»“æœ');
      break;
    }

    // æŸ¥æ‰¾å¯¹è±¡å¼€å§‹ä½ç½®
    const start = jsonString.indexOf('{', i);
    if (start === -1) break;

    // æŸ¥æ‰¾åŒ¹é…çš„ç»“æŸå¤§æ‹¬å·
    let depth = 0;
    let end = start;
    let foundEnd = false;

    const maxScanLength = 1000;
    const scanLimit = Math.min(start + maxScanLength, jsonString.length);

    for (let j = start; j < scanLimit; j++) {
      const char = jsonString[j];

      if (char === '{') {
        depth++;
      } else if (char === '}') {
        depth--;
        if (depth === 0) {
          end = j + 1;
          foundEnd = true;
          break;
        }
      }
    }

    if (foundEnd) {
      const candidate = jsonString.substring(start, end);
      objectsScanned++;

      // å¿«é€Ÿé¢„æ£€
      if (
        candidate.includes('"resourceId"') &&
        candidate.includes('"hash"') &&
        candidate.includes('"typeId"')
      ) {
        try {
          const obj = JSON.parse(candidate);
          if (isValidContextRef(obj)) {
            refs.push(obj);
          }
        } catch (parseError) {
          // JSON è§£æå¤±è´¥ï¼Œç»§ç»­æ‰«æ
        }
      }

      i = end;
    } else {
      i = start + 1;
    }
  }

  const duration = performance.now() - scanStartTime;

  console.log(`  æ‰§è¡Œæ—¶é—´: ${duration.toFixed(2)}ms`);
  console.log(`  æ‰¾åˆ°å¯¹è±¡: ${refs.length} ä¸ª`);
  console.log(`  æ‰«æå¯¹è±¡: ${objectsScanned} ä¸ª`);
  console.log(`  æ€§èƒ½è¯„ä¼°: ${duration < 100 ? 'ğŸš€ excellent' : duration < 500 ? 'âœ… good' : 'âš ï¸ slow'}`);

  return refs;
}

// ============================================================================
// æµ‹è¯•ç”¨ä¾‹
// ============================================================================

console.log('\n========================================');
console.log('ReDoS æ¼æ´ä¿®å¤éªŒè¯æµ‹è¯•');
console.log('========================================\n');

// æµ‹è¯•ç”¨ä¾‹ 1: æ­£å¸¸è¾“å…¥
console.log('æµ‹è¯•ç”¨ä¾‹ 1: æ­£å¸¸è¾“å…¥');
console.log('----------------------------------------');
const normalInput = JSON.stringify([
  { resourceId: 'res_abc1234567', hash: 'hash123', typeId: 'type1' },
  { resourceId: 'res_def7890123', hash: 'hash456', typeId: 'type2' },
]);
console.log('è¾“å…¥:', normalInput.substring(0, 100) + '...');
const result1 = safeStringScanning_AFTER(normalInput);
console.log('ç»“æœ:', result1.length, 'ä¸ªæœ‰æ•ˆå¯¹è±¡\n');

// æµ‹è¯•ç”¨ä¾‹ 2: æŸåçš„ JSON
console.log('æµ‹è¯•ç”¨ä¾‹ 2: æŸåçš„ JSON');
console.log('----------------------------------------');
const brokenInput = '[{"resourceId":"res_abc1234567","hash":"hash123",typeId:"type1"';
console.log('è¾“å…¥:', brokenInput);
const result2 = safeStringScanning_AFTER(brokenInput);
console.log('ç»“æœ:', result2.length, 'ä¸ªæœ‰æ•ˆå¯¹è±¡ï¼ˆéƒ¨åˆ†æ¢å¤ï¼‰\n');

// æµ‹è¯•ç”¨ä¾‹ 3: å¤§é‡åµŒå¥—ï¼ˆReDoS æ”»å‡»åœºæ™¯ï¼‰
console.log('æµ‹è¯•ç”¨ä¾‹ 3: å¤§é‡åµŒå¥—ï¼ˆæ½œåœ¨ ReDoS æ”»å‡»ï¼‰');
console.log('----------------------------------------');
const maliciousInput = '{'.repeat(100) +
  '{"resourceId":"res_abc1234567","hash":"hash123","typeId":"type1"}' +
  '}'.repeat(100);
console.log('è¾“å…¥é•¿åº¦:', maliciousInput.length, 'å­—ç¬¦');
console.log('åµŒå¥—æ·±åº¦: 100 å±‚');

console.log('\nâš ï¸ è­¦å‘Šï¼šå¦‚æœä½¿ç”¨æ—§çš„æ­£åˆ™å®ç°ï¼Œè¿™å°†å¯¼è‡´é•¿æ—¶é—´æŒ‚èµ·æˆ–å´©æºƒ');
console.log('ä½¿ç”¨æ–°çš„å®‰å…¨å®ç°:');
const result3 = safeStringScanning_AFTER(maliciousInput);
console.log('ç»“æœ:', result3.length, 'ä¸ªæœ‰æ•ˆå¯¹è±¡\n');

// æµ‹è¯•ç”¨ä¾‹ 4: è¶…å¤§è¾“å…¥
console.log('æµ‹è¯•ç”¨ä¾‹ 4: è¶…å¤§è¾“å…¥ï¼ˆæ€§èƒ½æµ‹è¯•ï¼‰');
console.log('----------------------------------------');
const largeInput = JSON.stringify(
  Array.from({ length: 1000 }, (_, i) => ({
    resourceId: `res_test${String(i).padStart(6, '0')}`,
    hash: `hash${i}`,
    typeId: `type${i % 10}`,
  }))
);
console.log('è¾“å…¥é•¿åº¦:', largeInput.length, 'å­—ç¬¦');
console.log('å¯¹è±¡æ•°é‡: 1000 ä¸ª');
const result4 = safeStringScanning_AFTER(largeInput);
console.log('ç»“æœ:', result4.length, 'ä¸ªæœ‰æ•ˆå¯¹è±¡\n');

// æµ‹è¯•ç”¨ä¾‹ 5: æ··åˆæœ‰æ•ˆå’Œæ— æ•ˆå¯¹è±¡
console.log('æµ‹è¯•ç”¨ä¾‹ 5: æ··åˆæœ‰æ•ˆå’Œæ— æ•ˆå¯¹è±¡');
console.log('----------------------------------------');
const mixedInput = `[
  {"resourceId":"res_abc1234567","hash":"hash123","typeId":"type1"},
  {"resourceId":"invalid","hash":"hash456","typeId":"type2"},
  {"resourceId":"res_def7890123","hash":"hash789","typeId":"type3"}
]`;
console.log('è¾“å…¥: 3 ä¸ªå¯¹è±¡ï¼ˆ1 ä¸ªæ— æ•ˆï¼‰');
const result5 = safeStringScanning_AFTER(mixedInput);
console.log('ç»“æœ:', result5.length, 'ä¸ªæœ‰æ•ˆå¯¹è±¡\n');

console.log('========================================');
console.log('æµ‹è¯•å®Œæˆ');
console.log('========================================');
console.log('\næ€»ç»“:');
console.log('âœ… æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹å‡åœ¨å®‰å…¨æ—¶é—´å†…å®Œæˆ');
console.log('âœ… æ— æ­£åˆ™è¡¨è¾¾å¼å›æº¯é—®é¢˜');
console.log('âœ… è¶…æ—¶ä¿æŠ¤æœºåˆ¶å·¥ä½œæ­£å¸¸');
console.log('âœ… å¯¹è±¡æ•°é‡å’Œå¤§å°é™åˆ¶æœ‰æ•ˆ');
console.log('âœ… ReDoS æ¼æ´å·²ä¿®å¤\n');

// ============================================================================
// æ€§èƒ½å¯¹æ¯”æ¼”ç¤ºï¼ˆä»…ä¾›å‚è€ƒï¼‰
// ============================================================================

console.log('\n========================================');
console.log('æ€§èƒ½å¯¹æ¯”ï¼ˆä»…ä¾›æ¼”ç¤ºï¼‰');
console.log('========================================\n');

const testInput = JSON.stringify([
  { resourceId: 'res_abc1234567', hash: 'hash123', typeId: 'type1' },
  { resourceId: 'res_def7890123', hash: 'hash456', typeId: 'type2' },
  { resourceId: 'res_ghi4567890', hash: 'hash789', typeId: 'type3' },
]);

console.log('æµ‹è¯•è¾“å…¥:', testInput.substring(0, 100) + '...\n');

// æ³¨æ„ï¼šå±é™©çš„æ­£åˆ™å®ç°å·²è¢«æ³¨é‡Šï¼Œä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨
// console.log('1. ä¿®å¤å‰ï¼ˆå±é™©æ­£åˆ™ï¼‰:');
// dangerousRegexExtraction_BEFORE(testInput);
console.log('1. ä¿®å¤å‰ï¼ˆå±é™©æ­£åˆ™ï¼‰: âš ï¸ å·²ç¦ç”¨ï¼ˆå­˜åœ¨ ReDoS æ¼æ´ï¼‰\n');

console.log('2. ä¿®å¤åï¼ˆå®‰å…¨å­—ç¬¦ä¸²æ‰«æï¼‰:');
safeStringScanning_AFTER(testInput);

console.log('\n========================================\n');
