- __当前工作 (Current Work):__

  - 我们正在修改 `frontend/src/views/problems/ProblemCreate.vue` 文件，以实现AI辅助创建错题的功能。

  - __第一阶段 (图片上传与初步结构化)__ 已基本完成（使用模拟API）：

    - 实现了图片上传的UI和AI导入按钮。
    - 定义了管理AI会话和数据的状态变量。
    - 实现了图片处理和启动AI导入的方法 (`handleStartAIImageImport`)，该方法会使用模拟API返回的结构化数据填充表单，并更新用于显示初步AI分析结果的对话框 (`aiResultVisible`)。
    - `handleSubmit` 方法已更新，以区分手动创建和AI辅助创建流程。

  - __第二阶段 (AI交互式分析/聊天)__ 的基础搭建已开始：

    - 在模板中添加了聊天界面的UI占位符（聊天卡片、历史记录显示区、输入框、发送按钮）。
    - 添加了聊天所需的状态变量 (`chatHistory`, `currentUserMessage`, `isAIChatProcessing`, `eventSourceInstance`, `chatHistoryRef`)。
    - 引入了 `watch`, `nextTick`, `Loading` 图标。计划使用 `DOMPurify` 和 `marked` 处理AI返回的Markdown/HTML (目前在代码中为注释状态)。
    - 实现了基础的模拟聊天功能，包括 `loadChatHistory` (模拟) 和 `handleSendChatMessage` (使用基于`setInterval`的模拟流式响应)。
    - 为聊天界面添加了基础CSS样式。
    - `handleImageFileChange` 和 `handleImageFileRemove` 方法已更新，以在更换或移除图片时重置聊天状态并关闭任何活动的 `EventSource`。

  - 最近的尝试是使用 `write_to_file` 工具将上述所有更改写入 `frontend/src/views/problems/ProblemCreate.vue`。

- __关键技术概念 (Key Technical Concepts):__

  - Vue 3 (Composition API, `<script setup>`)
  - Element Plus UI 库
  - FastAPI 后端 (根据API端点结构推断)
  - AI驱动功能：图像转文字 (OCR)、从文本中提取结构化数据、通过AI聊天进行交互式分析和内容优化。
  - 服务器发送事件 (Server-Sent Events, SSE)：用于流式传输AI聊天响应 (已计划，并实现了模拟版本)。
  - `FormData`：用于文件上传。

- __相关文件和代码 (Relevant Files and Code):__

  - `frontend/src/views/problems/ProblemCreate.vue`: 主要工作文件。其最新预期内容（我最近一次尝试用 `write_to_file` 写入的内容）包含了上述所有已开发和计划中的功能。这份内容对于接下来的开发至关重要。
  - `frontend/src/utils/api.js` (推断): 需要添加新的API函数定义，用于 `initiateProblemFromImage`, `finalizeProblem`, `getChatHistory`, `streamInteractiveAnalysis`, `getProblemAISession`。
  - 后端 `problem_service` (特别是 `api.py`, `service.py`, `schemas.py`, `models.py`): 需要实现与前端AI功能对应的API端点。这包括创建和管理AI交互会话、处理图像、OCR、与AI模型的聊天逻辑以及数据持久化。
  - `docs/项目文档.md`: 需要更新的文档。

- __已解决的问题 (Problem Solving):__

  - 之前多次使用 `replace_in_file` 工具失败，因此转而尝试使用 `write_to_file`。
  - 系统在处理包含大量内容的 `write_to_file` 工具调用时似乎存在解析问题。

- __待办任务和后续步骤 (Pending Tasks and Next Steps):__

  __A. 前端 - `frontend/src/views/problems/ProblemCreate.vue` (第二阶段：交互式聊天功能完善)__

  - __真实SSE集成__:

    - 在 `handleSendChatMessage` 中将模拟SSE替换为真实的 `EventSource` 设置。

      - 正确处理SSE连接 (`onopen`)、消息事件 (`onmessage` - 解析不同类型的事件如 `text`, `json_suggestion`, `final_structured_data`, `error`) 和错误事件 (`onerror`)。
      - 根据从AI接收到的 `json_suggestion` (例如更新表单字段、添加知识点) 和 `final_structured_data` (更新整个 `aiSessionData`) 事件，动态更新 `aiSessionData` 和表单字段。
      - 如果AI聊天内容可能包含Markdown或HTML，确保使用 `marked` 和 `DOMPurify` 进行安全渲染 (目前相关库已引入但实际渲染代码为简化版)。

    - 实现 `loadChatHistory` 方法，使其能从后端真实获取指定 `sessionId` 的聊天记录。

  - __聊天界面与体验优化__:

    - 改进聊天过程中的加载状态提示 (例如，在AI思考时显示更明确的加载指示)。
    - 优化聊天中的错误处理和用户反馈。
    - 考虑如何更好地渲染AI返回的复杂建议 (例如，直接修改表单项的建议、新增步骤的建议等)。
    - 确保 `EventSource` 在组件卸载 (`onUnmounted`钩子中已部分实现) 或AI会话改变（例如重新上传图片）时被正确关闭和清理。

  - __状态同步__: 确保通过聊天交互更新的 `aiSessionData` 或表单字段，在用户点击“应用分析结果到表单”或最终提交时，能够正确反映到 `aiAnalysisResult` (对话框数据源) 和最终提交的数据中。

  __B. 前端 - `frontend/src/utils/api.js` (API客户端函数定义)__

  - 定义并实现以下API调用函数：

    - `problemAPI.initiateProblemFromImage(formData)`: `POST /api/v1/problems/ai/initiate-from-image`
    - `problemAPI.finalizeProblem(sessionId, problemData)`: `POST /api/v1/problems/ai/finalize/{session_id}`
    - `problemAPI.getChatHistory(sessionId)`: `GET /api/v1/problems/ai/chat-history/{session_id}`
    - `problemAPI.streamInteractiveAnalysis(sessionId, streamRequestData)`: 此函数需要设置 `EventSource` 来连接 `POST /api/v1/problems/ai/interactive-analysis-stream/{session_id}` (如果后端SSE端点是POST) 或相应的GET端点。
    - `problemAPI.getProblemAISession(sessionId)`: `GET /api/v1/problems/ai/session/{session_id}` (用于获取/刷新整个AI会话状态，包括结构化数据)。

  __C. 后端 - `problem_service` (及相关的 `ai_api_manager`)__

  - __实现 `/problems/ai/initiate-from-image` 端点__:

    - 接收图片文件和可选的学科提示。
    - 执行OCR（可能调用 `file_service` 或 `ai_api_manager`）。
    - 调用AI模型 (通过 `ai_api_manager`) 进行初步的结构化数据提取 (生成 `ProblemAIStructuredDataSchema` 对应的数据)。
    - 创建并存储AI交互会话 (例如，在新的 `ProblemAISession` 表中，如果编辑现有题目则需关联 `Problem` ID)。
    - 返回 `session_id` 和初始的 `structured_data`。

  - __实现 `/problems/ai/chat-history/{session_id}` 端点__:
    - 从 `ProblemAIChatLog` 表中检索并返回指定会话的聊天记录。

  - __实现 `/problems/ai/interactive-analysis-stream/{session_id}` (SSE) 端点__:

    - 接收用户消息、聊天历史以及当前的题目上下文信息 (例如 `aiSessionData` 中的关键字段)。
    - 通过 `ai_api_manager` 调用AI大模型，以流式方式返回AI的分析、建议或回答。
    - 响应流中可以包含不同类型的事件：纯文本块 (`text`)、用于更新表单的JSON格式建议 (`json_suggestion`)、错误信息 (`error`) 或最终的完整结构化数据 (`final_structured_data`)。
    - 将用户消息和AI回复记录到 `ProblemAIChatLog` 表。
    - 根据AI的反馈（特别是 `final_structured_data` 或重要的 `json_suggestion`）更新 `ProblemAISession` 中存储的题目结构化数据。

  - __实现 `/problems/ai/session/{session_id}` 端点__:
    - 检索并返回 `ProblemAISession` 的当前状态 (应包含最新的 `ProblemAIStructuredData`)。

  - __实现 `/problems/ai/finalize/{session_id}` 端点__:

    - 接收最终确认的题目数据 (来自前端表单) 和会话ID。
    - 使用这些数据在数据库中创建新的 `Problem` 记录，或更新已有的题目。
    - （可选）将AI会话标记为已完成或已敲定。

  - __数据库设计与迁移__:

    - 确保 `ProblemAISession` (存储AI交互会话状态及演进中的题目结构化数据) 和 `ProblemAIChatLog` (存储聊天记录) 表结构设计合理。
    - 创建并应用相应的数据库迁移脚本。

  __D. 文档 - `docs/项目文档.md`__

  - __(此项任务由您接手)__ 根据上述待办事项，更新项目文档。详细记录新增的AI功能模块（图片导入、交互式分析）、前端组件 (`ProblemCreate.vue`) 的主要变更、新增的API端点（请求/响应结构、SSE事件类型等）、以及后端服务的逻辑调整和数据库表结构变更。
