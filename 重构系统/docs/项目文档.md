# 错题管理系统 - 项目文档

## 目录

1. [项目概述](#项目概述)
2. [系统架构](#系统架构)
3. [技术栈](#技术栈)
4. [目录结构](#目录结构)
5. [核心模块](#核心模块)
6. [API文档](#api文档)
7. [数据库设计](#数据库设计)
8. [部署指南](#部署指南)
9. [开发指南](#开发指南)
10. [常见问题](#常见问题)

## 项目概述

### 简介
错题管理系统是一个专为考研学生设计的智能学习辅助工具，支持多学科错题管理、AI智能分析、学习进度跟踪等功能。

### 主要功能
- 📚 **多学科支持**：数学、英语、政治、专业课
- 🤖 **AI智能分析**：错误原因分析、解题思路生成、知识点提取
- 📷 **OCR识别**：支持拍照录入题目
- 📊 **深度分析**：学习模式识别、薄弱点分析、个性化建议
- 📈 **进度跟踪**：复习记录、掌握度评估、学习曲线
- 🏷️ **标签管理**：自定义标签、快速分类检索

### 系统特点
- **微服务架构**：模块化设计，易于扩展和维护
- **异步处理**：高性能异步框架，提升响应速度
- **类型安全**：前后端全面类型检查
- **本地优先**：支持完全本地运行，保护隐私
- **灵活部署**：支持Docker容器化部署

## 系统架构

### 整体架构
```
┌─────────────────────────────────────────────────────────┐
│                     前端应用 (React)                      │
├─────────────────────────────────────────────────────────┤
│                   API Gateway (FastAPI)                   │
├──────────────┬──────────────┬──────────────┬────────────┤
│  AI API管理   │   错题管理    │   回顾分析    │  文件服务  │
├──────────────┴──────────────┴──────────────┴────────────┤
│                    共享组件层                             │
├─────────────────────────────────────────────────────────┤
│                 数据库 (PostgreSQL/SQLite)                │
└─────────────────────────────────────────────────────────┘
```

### 服务依赖关系
```
文件服务 (独立)
AI管理服务 (独立)
错题服务 → AI管理服务、文件服务
回顾分析服务 → AI管理服务、错题服务
```

## 技术栈

### 后端技术
- **框架**: FastAPI (异步Web框架)
- **数据库**: 
  - 开发环境: SQLite
  - 生产环境: PostgreSQL
- **ORM**: SQLAlchemy 2.0 (异步)
- **验证**: Pydantic
- **AI集成**: 
  - OpenAI API
  - Anthropic Claude API
  - Google Gemini API
- **对象存储**: MinIO
- **日志**: structlog
- **测试**: pytest + pytest-asyncio

### 前端技术
- **框架**: React 18
- **语言**: TypeScript
- **UI库**: Ant Design 5
- **状态管理**: React Query
- **路由**: React Router 6
- **构建工具**: Create React App

### 部署技术
- **容器化**: Docker
- **编排**: Docker Compose
- **反向代理**: Nginx (可选)

## 目录结构

```
重构系统/
├── backend/                      # 后端代码
│   ├── main.py                  # 应用入口
│   ├── requirements.txt         # Python依赖
│   ├── check_system.py         # 系统检查脚本
│   ├── shared/                 # 共享组件
│   │   ├── config.py          # 配置管理
│   │   ├── database.py        # 数据库连接
│   │   ├── models/            # 基础模型
│   │   └── utils/             # 工具函数
│   ├── services/              # 微服务
│   │   ├── ai_api_manager/    # AI API管理服务
│   │   ├── problem_service/   # 错题管理服务
│   │   ├── review_service/    # 回顾分析服务
│   │   └── file_service/      # 文件服务
│   └── infrastructure/        # 基础设施
│       └── database/          # 数据库相关
│           ├── migrations/    # 数据库迁移
│           └── migrate.py     # 迁移脚本
├── frontend/                   # 前端代码
│   ├── public/                # 静态资源
│   ├── src/                   # 源代码
│   │   ├── components/        # 通用组件
│   │   ├── pages/            # 页面组件
│   │   ├── services/         # API服务
│   │   └── utils/            # 工具函数
│   ├── package.json          # npm配置
│   └── tsconfig.json         # TypeScript配置
├── docs/                      # 文档
├── tests/                     # 测试
├── docker-compose.yml         # Docker编排
├── Makefile                   # 构建脚本
└── README.md                  # 项目说明
```

## 核心模块

### 1. AI API管理服务
**功能**：统一管理多个AI提供商的API调用

**核心组件**：
- `AIRouter`: 智能路由，根据任务类型和模型可用性分配请求
- `ProviderManager`: 管理不同AI提供商的实现
- `HealthChecker`: 监控AI服务健康状态
- `LoadBalancer`: 负载均衡和故障转移

**支持的AI任务**：
- 错题分析
- OCR识别
- 知识点提取
- 学习建议生成

### 2. 错题管理服务
**功能**：错题的增删改查、AI分析、统计

**核心模型**：
- `Problem`: 错题实体
- `ReviewRecord`: 复习记录
- `ProblemTemplate`: 题目模板

**主要接口**：
- 创建错题（支持图片上传）
- 更新错题信息
- AI智能分析
- 批量导入/导出
- 多维度查询和筛选

### 3. 回顾分析服务
**功能**：深度学习分析、模式识别、个性化建议

**分析类型**：
- 批量错题分析
- 知识点专项分析
- 时间段趋势分析
- 综合学习报告

**核心功能**：
- 错误模式识别
- 薄弱领域定位
- 学习计划生成
- 进度跟踪对比

### 4. 文件服务
**功能**：文件上传、存储、访问控制

**特性**：
- 支持多种存储后端（MinIO/本地文件系统）
- 图片自动压缩优化
- 访问权限控制
- 文件元数据管理

## API文档

### 基础信息
- **Base URL**: `http://localhost:8000/api/v1`
- **认证方式**: 本地系统，无需认证
- **响应格式**: JSON

### 主要接口

#### 错题管理
```
POST   /problems              创建错题
GET    /problems              获取错题列表
GET    /problems/{id}         获取错题详情
PUT    /problems/{id}         更新错题
DELETE /problems/{id}         删除错题
POST   /problems/{id}/analyze AI分析错题
POST   /problems/ocr          OCR识别
POST   /problems/batch        批量导入
```

#### 回顾分析
```
POST   /reviews/analyze/batch         批量分析
POST   /reviews/analyze/knowledge     知识点分析
POST   /reviews/analyze/time-period   时间段分析
POST   /reviews/analyze/comprehensive 综合分析
GET    /reviews/insights              获取学习洞察
```

#### AI服务
```
POST   /ai/models             添加AI模型
GET    /ai/models             获取模型列表
POST   /ai/route              智能路由请求
GET    /ai/health             健康检查
```

### 详细API文档
启动服务后访问：`http://localhost:8000/docs`

## 数据库设计

### 核心表结构

#### problems（错题表）
| 字段 | 类型 | 说明 |
|-----|------|------|
| id | UUID | 主键 |
| title | VARCHAR(200) | 标题 |
| content | TEXT | 题目内容 |
| subject | VARCHAR(50) | 学科 |
| difficulty_level | INTEGER | 难度等级(1-5) |
| mastery_level | FLOAT | 掌握程度(0-1) |
| knowledge_points | JSONB | 知识点列表 |
| ai_analysis | JSONB | AI分析结果 |
| created_at | TIMESTAMP | 创建时间 |

#### review_analyses（分析记录表）
| 字段 | 类型 | 说明 |
|-----|------|------|
| id | UUID | 主键 |
| analysis_type | VARCHAR(50) | 分析类型 |
| problem_ids | UUID[] | 相关题目 |
| ai_analysis | JSONB | AI分析结果 |
| error_patterns | JSONB | 错误模式 |
| study_plan | JSONB | 学习计划 |

### 数据库迁移
```bash
# 运行迁移
cd backend
python infrastructure/database/migrate.py

# 检查数据库
python check_system.py
```

## 部署指南

### 开发环境部署

#### 1. 环境准备
```bash
# Python 3.8+
python --version

# Node.js 16+
node --version

# Git
git --version
```

#### 2. 后端启动
```bash
# 进入后端目录
cd backend

# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate  # Windows

# 安装依赖
pip install -r requirements.txt

# 运行数据库迁移
python infrastructure/database/migrate.py

# 启动服务
python main.py
```

#### 3. 前端启动
```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install

# 启动开发服务器
npm start
```

### 生产环境部署

#### 使用Docker Compose
```bash
# 构建并启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

#### 环境变量配置
创建`.env`文件：
```env
# 应用配置
APP_ENV=production
APP_DEBUG=false

# 数据库配置
DATABASE_URL=postgresql+asyncpg://user:pass@db:5432/dbname

# AI API配置
OPENAI_API_KEY=your-key
ANTHROPIC_API_KEY=your-key

# 对象存储配置
MINIO_ENDPOINT=minio:9000
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin
```

## 开发指南

### 代码规范
- **Python**: 遵循PEP 8，使用Black格式化
- **TypeScript**: 使用ESLint + Prettier
- **提交规范**: 使用Conventional Commits

### 添加新功能
1. 在相应的service目录下创建新模块
2. 定义数据模型（models.py）
3. 创建请求/响应模式（schemas.py）
4. 实现业务逻辑（service.py）
5. 添加API路由（api.py）
6. 编写测试用例
7. 更新文档

### 测试
```bash
# 运行所有测试
pytest

# 运行特定测试
pytest tests/test_problem_service.py

# 查看测试覆盖率
pytest --cov=backend
```

### 调试技巧
1. 使用structlog查看结构化日志
2. FastAPI自动生成的交互式文档：`/docs`
3. 使用VS Code的Python调试器
4. 查看SQLAlchemy生成的SQL：设置`DATABASE_ECHO=true`

## 常见问题

### Q1: 导入路径错误
**问题**：`ModuleNotFoundError: No module named 'backend'`

**解决方案**：
1. 确保在正确的目录运行
2. 检查PYTHONPATH设置
3. 使用相对导入替代绝对导入

### Q2: 数据库连接失败
**问题**：无法连接到数据库

**解决方案**：
1. 检查数据库服务是否启动
2. 验证连接字符串是否正确
3. 确保数据库用户有足够权限

### Q3: AI服务调用失败
**问题**：AI分析功能不可用

**解决方案**：
1. 检查API密钥是否配置
2. 验证网络连接
3. 查看AI服务健康状态

### Q4: 文件上传失败
**问题**：无法上传图片

**解决方案**：
1. 检查MinIO服务是否运行
2. 验证存储桶权限
3. 确保文件大小未超限

## 更新日志

### v2.0.0 (2024-03-08)
- 🎉 完全重构为微服务架构
- ✨ 新增AI API管理服务
- ✨ 新增深度学习分析功能
- 🔧 优化数据库设计
- 📚 完善项目文档

### v1.0.0 (2024-01-01)
- 🎉 初始版本发布
- ✨ 基础错题管理功能
- ✨ 简单的AI分析

## 贡献指南

欢迎贡献代码！请遵循以下步骤：

1. Fork项目
2. 创建功能分支：`git checkout -b feature/AmazingFeature`
3. 提交更改：`git commit -m 'Add some AmazingFeature'`
4. 推送到分支：`git push origin feature/AmazingFeature`
5. 提交Pull Request

## 许可证

本项目采用MIT许可证 - 查看[LICENSE](LICENSE)文件了解详情

## 联系方式

- 项目主页：[GitHub Repository](https://github.com/yourusername/error-management-system)
- 问题反馈：[Issues](https://github.com/yourusername/error-management-system/issues)
- 邮箱：your-email@example.com

---

*最后更新：2024年3月8日* 