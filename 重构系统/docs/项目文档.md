# 错题管理系统 - 项目文档

## 目录

1. [项目概述](#项目概述)
2. [系统架构](#系统架构)
3. [技术栈](#技术栈)
4. [目录结构](#目录结构)
5. [核心模块](#核心模块)
6. [API文档](#api文档)
7. [数据库设计](#数据库设计)
8. [部署指南](#部署指南)
9. [开发指南](#开发指南)
10. [常见问题](#常见问题)

## 项目概述

### 简介
错题管理系统是一个专为考研学生设计的智能学习辅助工具，支持多学科错题管理、AI智能分析、学习进度跟踪等功能。

### 主要功能
- 📚 **多学科支持**：数学、英语、政治、专业课
- 🤖 **AI智能分析**：错误原因分析、解题思路生成、知识点提取
- 📷 **OCR识别**：支持拍照录入题目
- 📊 **深度分析**：学习模式识别、薄弱点分析、个性化建议
- 📈 **进度跟踪**：复习记录、掌握度评估、学习曲线
- 🏷️ **标签管理**：自定义标签、快速分类检索

### 系统特点
- **微服务架构**：模块化设计，易于扩展和维护
- **异步处理**：高性能异步框架，提升响应速度
- **类型安全**：前后端全面类型检查
- **本地优先**：支持完全本地运行，保护隐私
- **灵活部署**：支持Docker容器化部署

## 系统架构

### 整体架构
```
┌─────────────────────────────────────────────────────────┐
│                     前端应用 (Vue.js)                     │
├─────────────────────────────────────────────────────────┤
│                   API Gateway (FastAPI)                   │
├──────────────┬──────────────┬──────────────┬────────────┤
│  AI API管理   │   错题管理    │   回顾分析    │  文件服务  │
├──────────────┴──────────────┴──────────────┴────────────┤
│                    共享组件层                             │
├─────────────────────────────────────────────────────────┤
│                 数据库 (PostgreSQL/SQLite)                │
└─────────────────────────────────────────────────────────┘
```

### 服务依赖关系
```
文件服务 (独立)
AI管理服务 (独立)
错题服务 → AI管理服务、文件服务
回顾分析服务 → AI管理服务、错题服务
```

## 技术栈

### 后端技术
- **框架**: FastAPI (异步Web框架)
- **数据库**: 
  - 开发环境: SQLite
  - 生产环境: PostgreSQL
- **ORM**: SQLAlchemy 2.0 (异步)
- **验证**: Pydantic
- **AI集成**: 
  - OpenAI API
  - Anthropic Claude API
  - Google Gemini API
- **对象存储**: MinIO
- **日志**: structlog
- **测试**: pytest + pytest-asyncio

### 前端技术
- **框架**: Vue.js 3 (Vue ^3.3.11)
- **语言**: JavaScript / TypeScript (Vue 3 with Vite, tsconfig.json exists)
- **UI库**: Element Plus (^2.4.3)
- **状态管理**: Pinia (^2.1.7)
- **路由**: Vue Router 4 (^4.2.5)
- **构建工具**: Vite (^5.0.8)

### 部署技术
- **容器化**: Docker
- **编排**: Docker Compose
- **反向代理**: Nginx (可选)

## 目录结构

```
重构系统/
├── backend/                      # 后端代码
│   ├── main.py                  # 应用入口
│   ├── requirements.txt         # Python依赖
│   ├── check_system.py         # 系统检查脚本
│   ├── shared/                 # 共享组件
│   │   ├── config.py          # 配置管理
│   │   ├── database.py        # 数据库连接
│   │   ├── models/            # 基础模型
│   │   └── utils/             # 工具函数
│   ├── services/              # 微服务
│   │   ├── ai_api_manager/    # AI API管理服务
│   │   ├── problem_service/   # 错题管理服务
│   │   ├── review_service/    # 回顾分析服务
│   │   └── file_service/      # 文件服务
│   └── infrastructure/        # 基础设施
│       └── database/          # 数据库相关
│           ├── migrations/    # 数据库迁移
│           └── migrate.py     # 迁移脚本
├── frontend/                   # 前端代码
│   ├── index.html             # 入口HTML文件
│   ├── package.json           # npm配置
│   ├── package-lock.json      # npm锁文件
│   ├── tsconfig.json          # TypeScript配置
│   ├── vite.config.js         # Vite配置文件
│   └── src/                   # 源代码
│       ├── App.tsx              # (若App.vue为主要入口则此文件可能未使用或为辅助)
│       ├── App.vue              # 主要Vue应用组件
│       ├── main.js              # 应用入口 (Vue)
│       ├── api/                 # API调用模块
│       │   └── statistics.js
│       ├── components/          # Vue组件
│       │   ├── AIReviewSuggestion.vue
│       │   └── ProblemStatistics.vue
│       ├── layouts/             # 布局组件
│       │   └── MainLayout.vue
│       ├── router/              # Vue路由配置
│       │   └── index.js
│       ├── stores/              # Pinia状态管理
│       │   └── auth.js
│       ├── styles/              # 样式文件
│       │   └── index.css
│       ├── utils/               # 工具函数
│       │   └── api.js
│       └── views/               # 页面视图 (Vue)
│           ├── Dashboard.vue
│           ├── ai/
│           │   ├── AIModelList.vue
│           │   └── AIStats.vue
│           ├── analyses/
│           │   ├── AnalysisCreate.vue
│           │   ├── AnalysisDetail.vue
│           │   └── AnalysisList.vue
│           └── problems/
│               ├── ProblemCreate.vue
│               ├── ProblemDetail.vue
│               ├── ProblemEdit.vue
│               └── ProblemList.vue
├── docs/                      # 文档
├── tests/                     # 测试
├── docker-compose.yml         # Docker编排
├── Makefile                   # 构建脚本
└── README.md                  # 项目说明
```

## 核心模块

### 1. AI API管理服务
**功能**：统一管理多个AI提供商的API调用

**核心组件**：
- `AIRouter`: 智能路由，根据任务类型和模型可用性分配请求
- `ProviderManager`: 管理不同AI提供商的实现
- `HealthChecker`: 监控AI服务健康状态
- `LoadBalancer`: 负载均衡和故障转移

**支持的AI任务**：
- 错题分析
- OCR识别
- 知识点提取
- 学习建议生成

### 2. 错题管理服务
**功能概述**：提供错题全生命周期管理，包括错题的录入、编辑、组织、AI智能分析、复习支持、查询统计等核心功能。

**详细功能点**：

1.  **错题录入 (Problem Entry)**:
    *   **手动录入**: 用户通过表单填写错题的详细信息，包括题目标题、内容（支持富文本）、学科、分类、答案、错误分析、知识点、标签等。
    *   **图片录入与OCR识别**:
        *   支持上传题目图片（通过与 **文件服务** 交互存储图片）。
        *   调用 **AI API管理服务** 对图片进行OCR识别，提取题目文本，自动填充到题目内容字段。
        *   用户可对OCR结果进行手动校对和编辑。
    *   **批量导入**:
        *   支持从特定格式文件（如CSV, JSON）批量导入错题。
        *   可使用预定义的 `ProblemTemplate` (题目模板) 指导导入过程，确保数据结构一致性。

2.  **错题组织与编辑 (Problem Organization & Editing)**:
    *   **信息编辑**: 提供对错题所有字段的完整编辑功能。
    *   **结构化管理**:
        *   通过 `subject` (学科) 进行一级分类。
        *   通过 `ProblemCategory` (题目分类) 实现多级、精细化的分类管理。
        *   通过 `ProblemTag` (题目标签) 为错题打上灵活的标签，便于检索和归纳。
    *   **难度与掌握度**:
        *   `difficulty_level`: 用户可设定或由AI辅助评估题目的难度等级。
        *   `mastery_level`: 记录对错题的掌握程度，通常在复习后更新。

3.  **AI辅助功能 (AI-Assisted Features)** (通过 **AI API管理服务** 实现):
    *   **智能知识点提取**: 根据题目内容自动分析并提取相关的 `knowledge_points`。
    *   **错误原因分析**: 基于用户答案和正确答案，AI自动生成 `error_analysis`，帮助理解错误本质。
    *   **解题思路生成**: AI可以辅助生成或完善题目的 `solution`。
    *   **AI建议分类 (AI-Suggested Category)**: AI可以根据题目内容和学科，自动分析并建议一个最合适的题目细分分类 (`suggested_category`)。系统在分析后会将此建议分类更新到错题的 `category` 字段，并相应调整分类的使用计数。
    *   **相似题目推荐**: (高级功能) AI分析当前错题特征，推荐知识点或题型相似的其他题目，用于巩固练习。
    *   **题目信息补全**: AI可根据题目内容尝试自动填充标签、难度等信息 (分类建议见上一条)。

4.  **复习流程支持 (Review Process Support)**:
    *   **复习记录**: 用户每次复习后，系统创建一条 `ReviewRecord`，记录复习结果、用时、笔记等。
    *   **状态更新**: 复习后，自动更新对应 `Problem` 的 `mastery_level` (掌握程度)、`review_count` (复习次数) 和 `last_review_at` (最后复习时间)。掌握度的更新可基于复习结果，或结合艾宾浩斯遗忘曲线等算法。
    *   **复习计划集成**: (可与 **回顾分析服务** 联动) 根据错题的掌握程度和复习历史，辅助生成复习计划，提醒用户在最佳时间点复习。

5.  **查询与展示 (Query & Display)**:
    *   **多维度筛选**: 支持按学科、分类、标签、难度、掌握度、创建日期、关键字等多种条件组合查询。
    *   **结果排序**: 支持按创建时间、更新时间、难度、掌握度等字段排序。
    *   **分页展示**: 对查询结果进行分页，提高加载效率。
    *   **错题详情**: 清晰展示错题的全部信息，包括题目内容、图片、答案、分析、知识点、标签、复习历史等。

6.  **数据管理 (Data Management)**:
    *   **导出功能**: 支持将错题数据导出为常见格式（如JSON, CSV, PDF），方便备份或离线学习。
    -   **批量操作**: 支持对多个错题进行批量删除、批量添加标签、批量AI重新分析等操作。

**核心模型**：

详细模型定义请参考 `backend/services/problem_service/models.py`。

- **`Problem`**: 错题核心实体，包含以下主要字段：
    - `id`: UUID, 主键
    - `title`: String(200), 题目标题
    - `content`: Text, 题目内容
    - `subject`: Enum(Subject), 学科 (数学, 英语, 政治, 专业课)
    - `category`: String(100), 题目分类 (可选, 可由用户指定或AI分析后建议)
    - `source`: String(200), 题目来源 (可选)
    - `year`: Integer, 年份 (可选)
    - `error_analysis`: Text, 错误分析 (可选)
    - `user_answer`: Text, 用户答案 (可选)
    - `correct_answer`: Text, 正确答案 (可选)
    - `solution`: Text, 解题思路 (可选)
    - `ai_analysis`: JSON, AI分析的完整结果 (JSON, 可选, 包含知识点、错误分析、建议分类等)
    - `knowledge_points`: JSON (List[str]), 知识点列表
    - `difficulty_level`: Integer, 难度等级 (1-5, 默认3)
    - `image_urls`: JSON (List[str]), 题目图片URL列表
    - `ocr_result`: Text, OCR识别结果 (可选)
    - `review_count`: Integer, 复习次数 (默认0)
    - `last_review_at`: DateTime, 最后复习时间 (可选)
    - `mastery_level`: Float, 掌握程度 (0.0-1.0, 默认0.0)
    - `tags`: JSON (List[str]), 标签列表
    - `notes`: Text, 用户备注 (可选)
    - `created_at`, `updated_at`: DateTime, 创建和更新时间
    - `deleted_at`: DateTime, 软删除标记 (可选)

- **`ReviewRecord`**: 复习记录实体，关联到`Problem`：
    - `id`: UUID, 主键
    - `problem_id`: String(36), 关联的错题ID
    - `review_result`: String(20), 复习结果 (e.g., "correct", "incorrect", "partial") (可选)
    - `confidence_level`: Integer, 信心等级 (1-5) (可选)
    - `time_spent`: Integer, 花费时间(秒) (可选)
    - `notes`: Text, 复习笔记 (可选)
    - `ai_feedback`: JSON, AI给出的反馈 (可选)
    - `created_at`, `updated_at`: DateTime

- **`ProblemTemplate`**: 题目模板实体，用于批量导入等场景：
    - `id`: UUID, 主键
    - `name`: String(100), 模板名称
    - `subject`: Enum(Subject), 学科
    - `category`: String(100), 题目分类 (可选)
    - `template_content`: JSON, 模板内容结构
    - `example_content`: JSON, 示例内容 (可选)
    - `description`: Text, 描述 (可选)
    - `usage_count`: Integer, 使用次数
    - `tags`: JSON (List[str]), 标签列表
    - `created_at`, `updated_at`: DateTime

- **`ProblemTag`**: 题目标签实体：
    - `id`: UUID, 主键
    - `name`: String(50), 标签名称 (唯一)
    - `description`: Text, 描述 (可选)
    - `color`: String(20), 标签颜色 (可选)
    - `usage_count`: Integer, 使用次数
    - `created_at`, `updated_at`: DateTime

- **`ProblemCategory`**: 题目分类实体，支持层级结构：
    - `id`: UUID, 主键
    - `name`: String(100), 分类名称
    - `subject`: Enum(Subject), 学科
    - `parent_id`: String(36), 父分类ID (可选, 用于层级)
    - `description`: Text, 描述 (可选)
    - `order`: Integer, 排序字段
    - `usage_count`: Integer, 使用次数
    - `created_at`, `updated_at`: DateTime

**核心业务流程示例**:

1.  **手动创建新错题流程**:
    *   前端：用户在创建页面填写表单（标题、学科、题目内容等），可选上传图片。
    *   后端 `problem_service`：
        *   接收创建请求。若有图片，先调用 `file_service` 上传图片，获取图片URL存入 `image_urls`。
        *   保存基础 `Problem` 信息到数据库。
        *   （可选，根据配置或用户选择）调用 `ai_api_manager` 对题目内容进行AI分析（知识点提取、初步错误分析等）。
        *   将AI分析结果更新到该 `Problem` 记录的 `ai_analysis`, `knowledge_points` 等字段。
        *   返回创建成功及错题信息给前端。

2.  **OCR图片录入错题流程**:
    *   前端：用户上传题目图片。
    *   后端 `problem_service`：
        *   调用 `file_service` 存储图片。
        *   调用 `ai_api_manager` 的OCR功能处理图片，获取识别文本。
        *   将OCR文本预填充到新题目的内容字段，返回给前端供用户确认和编辑。
        *   用户确认并提交后，按手动创建流程继续（可再次触发更详细的AI分析）。

3.  **复习错题流程**:
    *   前端：用户选择一道错题进行复习，提交复习结果（如是否答对、掌握程度反馈、笔记）。
    *   后端 `problem_service`：
        *   创建一条新的 `ReviewRecord`，记录本次复习详情。
        *   根据复习结果和既定算法（或用户直接输入的掌握度），更新 `Problem` 的 `mastery_level`, `review_count`, `last_review_at`。
        *   （可选）若与 **回顾分析服务** 集成，可能需要通知该服务更新复习计划。

4.  **对已有错题请求AI分析流程**:
    *   前端：用户选择某条错题，点击“AI分析”按钮。
    *   后端 `problem_service`：
        *   获取该错题的现有数据（内容、答案等）。
        *   调用 `ai_api_manager` 执行指定的AI分析任务（如错误原因深度分析、解题思路优化等）。
        *   接收AI返回的分析结果，更新该 `Problem` 的 `ai_analysis` 或其他相关字段。
        *   返回更新后的错题信息给前端。

**与其他模块的交互**:

-   **AI API管理服务**:
    *   **调用方**: `problem_service` 在需要AI能力时（如OCR、知识点提取、错误分析、内容生成）调用此服务。
    *   **交互内容**: 传递题目文本、图片数据、分析指令等；接收AI处理结果。
-   **文件服务**:
    *   **调用方**: `problem_service` 在处理带图片的错题时调用此服务。
    *   **交互内容**: 上传图片文件；获取图片的存储URL或引用。`problem_service` 自身存储这些URL。
-   **回顾分析服务 (Review Service)**:
    *   **交互方式**: `problem_service` 可能在错题创建、更新或复习记录产生时，通知 `review_service` 相关事件，以便后者更新学习模型、调整复习计划。`problem_service` 自身负责基础的复习记录和状态更新。
-   **统计服务 (Statistics Service)**:
    *   **数据源**: `problem_service` 存储的错题数据 (`Problem` 表) 和复习记录数据 (`ReviewRecord` 表) 是 `statistics_service` 进行统计分析的基础。`statistics_service` 通常会直接查询这些数据或通过API获取聚合数据。

**主要接口 (概览，详细见API文档部分)**：
- **错题 (Problems)**:
    - `POST /`: 创建错题 (支持图片、AI自动分析选项)。
    - `GET /`: 获取错题列表 (支持复杂查询、筛选、排序、分页)。
    - `GET /{problem_id}`: 获取单个错题详情。
    - `PUT /{problem_id}`: 更新错题信息。
    - `DELETE /{problem_id}`: 删除错题 (软删除)。
    - `POST /{problem_id}/analyze`: 对指定错题执行AI分析。
    - `POST /batch`: 批量导入错题。
    - `GET /export`: 导出错题 (查询参数控制范围和格式)。
- **复习记录 (Review Records)**:
    - `POST /{problem_id}/reviews`: 为错题添加复习记录。
    - `GET /{problem_id}/reviews`: 获取指定错题的所有复习记录。
    - `GET /reviews/{review_id}`: 获取单条复习记录详情。
    - `PUT /reviews/{review_id}`: 更新复习记录。
    - `DELETE /reviews/{review_id}`: 删除复习记录。
- **图片与OCR**:
    - `POST /ocr`: 对提供的图片进行OCR识别 (可选择是否自动创建题目)。
    - `POST /upload/image`: 上传错题图片 (可选择是否自动OCR)。
- **标签与分类管理 (Tags & Categories)**:
    - `GET /tags`: 获取所有可用标签。
    - `POST /tags`: 创建新标签。
    - `GET /categories`: 获取所有题目分类 (支持层级)。
    - `POST /categories`: 创建新分类。
- **统计接口 (由 `problem_service` 提供的基础统计)**:
    - `GET /stats/overview`: 获取错题总体统计概览。
    - `GET /stats/knowledge-points`: 获取知识点相关的统计数据。
    *(更复杂的统计分析由独立的 `statistics_service` 提供)*

- **导出错题数据**
    - `GET /export`
    - **查询参数**:
        - `subject: Optional[Subject]`
        - `category: Optional[str]`
        - `tags: Optional[List[str]]`
        - `keyword: Optional[str]`
        - `min_difficulty: Optional[int]` (1-5)
        - `max_difficulty: Optional[int]` (1-5)
        - `min_mastery: Optional[float]` (0.0-1.0)
        - `max_mastery: Optional[float]` (0.0-1.0)
        - `sort_by: str` (默认 "created_at")
        - `sort_desc: bool` (默认 `True`)
        - `export_format: ExportFormat` (枚举: "json", "csv", 默认 "json")
    - **响应**:
        - 如果 `export_format="json"`: `JSONResponse` 包含 `List[ProblemData]`。
        - 如果 `export_format="csv"`: `StreamingResponse` CSV文件流。
        - 文件名将包含时间戳，例如 `problems_export_YYYYMMDD_HHMMSS.json`。

- **批量操作错题**
    - `POST /batch-operate`
    - **请求体**: `ProblemBatchRequest` schema.
        - `problem_ids: List[str]` (必需, 错题ID列表, 至少1项)
        - `operation: str` (必需, 操作类型, 枚举: "delete", "update", "analyze")
        - `update_data: Optional[Dict[str, Any]]` (当 `operation="update"` 时需要，提供要更新的字段和值，结构类似 `ProblemUpdate` 但更灵活)
    - **响应**: `BatchOperationResponse` schema.
        - `success: bool`
        - `message: str`
        - `successful_ids: List[str]`
        - `failed_count: int`
        - `errors: List[BatchOperationResultDetail]` (其中 `BatchOperationResultDetail` 包含 `id` 和 `error`)

### 3. 回顾分析服务
**功能**：深度学习分析、模式识别、个性化建议

**分析类型**：
- 批量错题分析
- 知识点专项分析
- 时间段趋势分析
- 综合学习报告

**核心功能**：
- 错误模式识别
- 薄弱领域定位
- 学习计划生成
- 进度跟踪对比

### 4. 文件服务
**功能**：文件上传、存储、访问控制

**特性**：
- 支持多种存储后端（MinIO/本地文件系统）
- 图片自动压缩优化
- 访问权限控制
- 文件元数据管理

## API文档

### 基础信息
- **Base URL**: `http://localhost:8000/api/v1`
- **认证方式**: 无需认证
- **响应格式**: JSON

### 主要接口

#### 错题管理

详细的请求/响应模型请参考 `backend/services/problem_service/schemas.py`。
FastAPI 自动生成的交互式文档位于 `/docs`，提供了最准确的接口详情和测试功能。

**基础路径**: `/api/v1/problems`

- **创建错题**
    - `POST /`
    - **请求体**: `ProblemCreate` schema.
        - `title: str` (必需)
        - `content: str` (必需)
        - `subject: Subject` (必需, 枚举: "math", "english", "politics", "professional")
        - `category: Optional[str]`
        - `source: Optional[str]`
        - `year: Optional[int]`
        - `user_answer: Optional[str]`
        - `correct_answer: Optional[str]`
        - `error_analysis: Optional[str]`
        - `solution: Optional[str]`
        - `tags: List[str]` (默认空列表)
        - `image_urls: List[str]` (默认空列表, 通常由后端处理图片上传后填充)
        - `image_base64: Optional[List[str]]` (用于通过base64上传图片)
        - `notes: Optional[str]`
    - **查询参数**:
        - `auto_analyze: bool` (默认 `True`): 是否在创建后自动执行AI分析。
    - **响应**: `SingleProblemResponse` (包含创建的 `ProblemData`)。

- **获取错题列表 (支持高级查询)**
    - `GET /`
    - **查询参数**: (基于 `ProblemQuery` schema)
        - `subject: Optional[Subject]`
        - `category: Optional[str]`
        - `tags: Optional[List[str]]` (例如: `tags=重点&tags=易错`)
        - `keyword: Optional[str]` (搜索标题、内容、备注)
        - `min_difficulty: Optional[int]` (1-5)
        - `max_difficulty: Optional[int]` (1-5)
        - `min_mastery: Optional[float]` (0.0-1.0)
        - `max_mastery: Optional[float]` (0.0-1.0)
        - `page: int` (默认 1)
        - `size: int` (默认 20, 最大 100)
        - `sort_by: str` (默认 "created_at", 可选: "updated_at", "difficulty_level", "mastery_level", "review_count")
        - `sort_desc: bool` (默认 `True`)
    - **响应**: `ProblemListResponse` (包含 `data: List[ProblemData]`, `total`, `page`, `size`, `pages`)。

- **获取单个错题详情**
    - `GET /{problem_id}`
    - **路径参数**: `problem_id: str`
    - **响应**: `SingleProblemResponse` (包含 `ProblemData`)。

- **更新错题信息**
    - `PUT /{problem_id}`
    - **路径参数**: `problem_id: str`
    - **请求体**: `ProblemUpdate` schema (所有字段可选).
        - `title: Optional[str]`
        - `content: Optional[str]`
        - `category: Optional[str]`
        - `source: Optional[str]`
        - `year: Optional[int]`
        - `user_answer: Optional[str]`
        - `correct_answer: Optional[str]`
        - `error_analysis: Optional[str]`
        - `solution: Optional[str]`
        - `tags: Optional[List[str]]`
        - `image_urls: Optional[List[str]]` (注意：通常图片管理通过专门的上传/删除接口)
        - `notes: Optional[str]`
        - `mastery_level: Optional[float]` (0.0-1.0)
    - **响应**: `SingleProblemResponse` (包含更新后的 `ProblemData`)。

- **删除错题 (软删除)**
    - `DELETE /{problem_id}`
    - **路径参数**: `problem_id: str`
    - **响应**: `SingleProblemResponse` (仅包含 `success` 和 `message`)。

- **AI分析错题**
    - `POST /{problem_id}/analyze`
    - **路径参数**: `problem_id: str`
    - **请求体**: (可选) `ProblemAnalyzeRequest` schema.
        - `regenerate: bool` (默认 `False`, 当前服务层实现未直接使用此参数，分析总是基于最新数据)
        - `focus_areas: Optional[List[str]]` (当前服务层实现未直接使用此参数)
    - **响应**: `SingleProblemResponse` (包含更新AI分析结果后的 `ProblemData`，AI分析结果现在也包括建议的分类 `suggested_category`，并已更新到错题的 `category` 字段，或AI分析失败信息)。

- **OCR识别图片内容**
    - `POST /ocr`
    - **请求体**: `ProblemOCRRequest` schema.
        - `image_base64: Optional[str]` (图片的Base64编码)
        - `image_url: Optional[HttpUrl]` (图片的URL)
        - `enhance_math: bool` (默认 `True`, 是否增强数学公式识别)
        - `auto_create: bool` (默认 `False`, 是否在OCR成功后自动创建题目)
        - `subject: Optional[Subject]` (当 `auto_create` 为 `True` 时，用于指定新题目的学科)
        - `category: Optional[str]` (当 `auto_create` 为 `True` 时，用于指定新题目的分类)
    - **响应**: `SingleProblemResponse`.
        - 如果 `auto_create` 为 `True` 并成功创建题目，`data` 字段为 `ProblemData`。
        - 如果仅OCR，`data` 字段可能包含 `{"ocr_text": "识别的文本"}`，或文本在 `message` 中。

- **批量导入错题**
    - `POST /batch`
    - **请求体**: `List[ProblemCreate]` (一个包含多个 `ProblemCreate` 对象的列表)
    - **查询参数**:
        - `auto_analyze: bool` (默认 `False`): 是否对每个成功导入的题目自动执行AI分析。
    - **响应**: `dict` 包含 `success: bool`, `message: str`, 和 `data: {total, success, failed, errors, created_ids}`。

- **上传错题图片**
    - `POST /upload/image`
    - **请求体**: `multipart/form-data`
        - `file: UploadFile` (必需, 图片文件)
    - **查询参数**:
        - `auto_ocr: bool` (默认 `True`): 是否在图片上传成功后自动进行OCR识别。如果OCR配置为自动创建题目，则会尝试创建。
    - **响应**: `ProblemImageUploadResponse`
        - `success: bool`
        - `message: str`
        - `file_info: Optional[StorageFileUploadResponse]` (文件服务返回的文件信息)
        - `ocr_result: Optional[Dict[str, Any]]` (OCR识别结果，包括是否创建了新题目等)

- **添加复习记录**
    - `POST /{problem_id}/reviews`
    - **路径参数**: `problem_id: str`
    - **请求体**: `ReviewRecordCreate` schema.
        - `problem_id: str` (通常由路径参数填充，请求体中可忽略或校验一致性)
        - `review_result: Optional[str]` (枚举: "correct", "incorrect", "partial")
        - `confidence_level: Optional[int]` (1-5)
        - `time_spent: Optional[int]` (花费时间，秒)
        - `notes: Optional[str]`
    - **响应**: `ReviewRecordResponse` (包含创建的 `ReviewRecordData`)。

- **获取错题统计概览**
    - `GET /stats/overview`
    - **响应**: `dict` 包含 `success: bool` 和 `data: ProblemStatistics` (包含总数、各学科、各难度、平均掌握度等统计)。

- **获取知识点统计**
    - `GET /stats/knowledge-points`
    - **响应**: `dict` 包含 `success: bool` 和 `data: List[KnowledgePointStats]` (包含各知识点的题目数、平均掌握度、平均难度)。

#### 题目标签管理 (Problem Tags)

**基础路径**: `/api/v1/problem-tags`

- **创建题目标签**
    - `POST /`
    - **请求体**: `ProblemTagCreate` schema.
        - `name: str` (必需, 标签名称)
        - `description: Optional[str]`
        - `color: Optional[str]` (例如: "#FF0000")
    - **响应**: `ProblemTagResponse` (包含创建的 `ProblemTagData`)。

- **获取题目标签列表**
    - `GET /`
    - **查询参数**:
        - `page: int` (默认 1)
        - `size: int` (默认 100)
    - **响应**: `ProblemTagListResponse` (包含 `data: List[ProblemTagData]`)。
        *(注意: `ProblemTagListResponse` schema 当前仅包含 `success` 和 `data`。如需分页元数据 `total`, `page`, `size`，需更新 schema)*

- **获取单个题目标签**
    - `GET /{tag_id}`
    - **路径参数**: `tag_id: str`
    - **响应**: `ProblemTagResponse` (包含 `ProblemTagData`)。

- **更新题目标签**
    - `PUT /{tag_id}`
    - **路径参数**: `tag_id: str`
    - **请求体**: `ProblemTagUpdate` schema (所有字段可选).
        - `name: Optional[str]`
        - `description: Optional[str]`
        - `color: Optional[str]`
    - **响应**: `ProblemTagResponse` (包含更新后的 `ProblemTagData`)。

- **删除题目标签**
    - `DELETE /{tag_id}`
    - **路径参数**: `tag_id: str`
    - **响应**: `ProblemTagResponse` (仅包含 `success` 和 `message`)。
        *(注意: 删除标签不会自动从题目中移除该标签的引用，需谨慎操作)*

#### 题目分类管理 (Problem Categories)

**基础路径**: `/api/v1/problem-categories`

- **创建题目分类**
    - `POST /`
    - **请求体**: `ProblemCategoryCreate` schema.
        - `name: str` (必需, 分类名称)
        - `subject: Subject` (必需, 学科)
        - `parent_id: Optional[str]` (父分类ID，用于层级)
        - `description: Optional[str]`
        - `order: Optional[int]` (排序字段, 默认 0)
    - **响应**: `ProblemCategoryResponse` (包含创建的 `ProblemCategoryData`)。

- **获取题目分类列表**
    - `GET /`
    - **查询参数**:
        - `subject: Optional[Subject]` (按学科过滤)
        - `parent_id: Optional[str]` (默认 "root", 可为父ID或 `None` 获取扁平列表)
        - `hierarchical: bool` (默认 `True`, 当 `parent_id="root"` 时尝试返回层级结构)
    - **响应**: `ProblemCategoryListResponse` (包含 `data: List[ProblemCategoryData]`)。
        - 如果 `hierarchical=True` 且 `parent_id="root"`，`ProblemCategoryData` 中的 `children` 字段会递归包含子分类。

- **获取单个题目分类**
    - `GET /{category_id}`
    - **路径参数**: `category_id: str`
    - **响应**: `ProblemCategoryResponse` (包含 `ProblemCategoryData`)。

- **更新题目分类**
    - `PUT /{category_id}`
    - **路径参数**: `category_id: str`
    - **请求体**: `ProblemCategoryUpdate` schema (所有字段可选).
        - `name: Optional[str]`
        - `parent_id: Optional[str]` (注意: 不能将父级设置为自身或其子级)
        - `description: Optional[str]`
        - `order: Optional[int]`
    - **响应**: `ProblemCategoryResponse` (包含更新后的 `ProblemCategoryData`)。

- **删除题目分类**
    - `DELETE /{category_id}`
    - **路径参数**: `category_id: str`
    - **响应**: `ProblemCategoryResponse` (仅包含 `success` 和 `message`)。
        *(注意: 如果分类下有子分类，默认会阻止删除)*

#### 回顾分析
```
POST   /reviews/analyze/batch         批量分析
POST   /reviews/analyze/knowledge     知识点分析
POST   /reviews/analyze/time-period   时间段分析
POST   /reviews/analyze/comprehensive 综合分析
GET    /reviews/insights              获取学习洞察
```

#### AI服务
```
POST   /ai/models             添加AI模型
GET    /ai/models             获取模型列表
POST   /ai/route              智能路由请求
GET    /ai/health             健康检查
```

### 详细API文档
启动服务后访问：`http://localhost:8000/docs`

## 数据库设计

### 核心表结构

**重要说明：** `user_id` 字段以及所有相关的用户登录、注册和账户管理功能已在当前版本中被**完全废弃并移除**。系统中所有数据均为全局共享，不再与特定用户关联。如果在代码中遇到任何残留的 `user_id` 相关逻辑，应视为历史遗留代码并进行无害化移除。**未来版本不考虑恢复用户账户系统。**

以下是主要服务相关的核心表结构。更详细的字段信息（如是否可为空、索引、默认值等）请直接参考各服务下的 `models.py` 文件。

#### `problem_service` 相关表

**1. `problems` (错题表)**

| 字段                 | 类型                               | 说明                                     |
|----------------------|------------------------------------|------------------------------------------|
| `id`                 | UUID                               | 主键                                     |
| `title`              | VARCHAR(200)                       | 题目标题                                 |
| `content`            | TEXT                               | 题目内容                                 |
| `subject`            | SQLEnum(Subject)                   | 学科 (math, english, politics, professional) |
| `category`           | VARCHAR(100), nullable             | 题目分类                                 |
| `source`             | VARCHAR(200), nullable             | 题目来源                                 |
| `year`               | INTEGER, nullable                  | 年份                                     |
| `error_analysis`     | TEXT, nullable                     | 错误分析                                 |
| `user_answer`        | TEXT, nullable                     | 用户答案                                 |
| `correct_answer`     | TEXT, nullable                     | 正确答案                                 |
| `solution`           | TEXT, nullable                     | 解题思路                                 |
| `ai_analysis`        | JSON, nullable                     | AI分析的完整结果                         |
| `knowledge_points`   | JSON (List[str]), default=[]       | 知识点列表                               |
| `difficulty_level`   | INTEGER, default=3                 | 难度等级 (1-5)                           |
| `image_urls`         | JSON (List[str]), default=[]       | 题目图片URL列表                          |
| `ocr_result`         | TEXT, nullable                     | OCR识别结果                              |
| `review_count`       | INTEGER, default=0                 | 复习次数                                 |
| `last_review_at`     | TIMESTAMP(timezone=True), nullable | 最后复习时间                             |
| `mastery_level`      | FLOAT, default=0.0                 | 掌握程度 (0.0-1.0)                       |
| `tags`               | JSON (List[str]), default=[]       | 标签列表                                 |
| `notes`              | TEXT, nullable                     | 用户备注                                 |
| `created_at`         | TIMESTAMP(timezone=True)           | 创建时间                                 |
| `updated_at`         | TIMESTAMP(timezone=True)           | 更新时间                                 |
| `deleted_at`         | TIMESTAMP(timezone=True), nullable | 软删除时间戳 (如果非空则表示已删除)        |

**2. `review_records` (复习记录表)**

| 字段                 | 类型                               | 说明                                     |
|----------------------|------------------------------------|------------------------------------------|
| `id`                 | UUID                               | 主键                                     |
| `problem_id`         | VARCHAR(36), ForeignKey(problems.id) | 关联的错题ID                             |
| `review_result`      | VARCHAR(20), nullable              | 复习结果 (correct, incorrect, partial)   |
| `confidence_level`   | INTEGER, nullable                  | 信心等级 (1-5)                           |
| `time_spent`         | INTEGER, nullable                  | 花费时间 (秒)                            |
| `notes`              | TEXT, nullable                     | 复习笔记                                 |
| `ai_feedback`        | JSON, nullable                     | AI给出的反馈                             |
| `created_at`         | TIMESTAMP(timezone=True)           | 创建时间                                 |
| `updated_at`         | TIMESTAMP(timezone=True)           | 更新时间                                 |

**3. `problem_templates` (题目模板表)**

| 字段                 | 类型                               | 说明                                     |
|----------------------|------------------------------------|------------------------------------------|
| `id`                 | UUID                               | 主键                                     |
| `name`               | VARCHAR(100)                       | 模板名称                                 |
| `subject`            | SQLEnum(Subject)                   | 学科                                     |
| `category`           | VARCHAR(100), nullable             | 题目分类                                 |
| `template_content`   | JSON                               | 模板内容结构                             |
| `example_content`    | JSON, nullable                     | 示例内容                                 |
| `description`        | TEXT, nullable                     | 描述                                     |
| `usage_count`        | INTEGER, default=0                 | 使用次数                                 |
| `tags`               | JSON (List[str]), default=[]       | 标签列表                                 |
| `created_at`         | TIMESTAMP(timezone=True)           | 创建时间                                 |
| `updated_at`         | TIMESTAMP(timezone=True)           | 更新时间                                 |
| *UniqueConstraint*   | (_subject_name_uc)                 | subject 和 name 组合唯一                 |

**4. `problem_tags` (题目标签表)**

| 字段                 | 类型                               | 说明                                     |
|----------------------|------------------------------------|------------------------------------------|
| `id`                 | UUID                               | 主键                                     |
| `name`               | VARCHAR(50), unique=True           | 标签名称 (唯一)                          |
| `description`        | TEXT, nullable                     | 描述                                     |
| `color`              | VARCHAR(20), nullable              | 标签颜色 (例如 #FFFFFF)                  |
| `usage_count`        | INTEGER, default=0                 | 使用次数                                 |
| `created_at`         | TIMESTAMP(timezone=True)           | 创建时间                                 |
| `updated_at`         | TIMESTAMP(timezone=True)           | 更新时间                                 |

**5. `problem_categories` (题目分类表)**

| 字段                 | 类型                               | 说明                                     |
|----------------------|------------------------------------|------------------------------------------|
| `id`                 | UUID                               | 主键                                     |
| `name`               | VARCHAR(100)                       | 分类名称                                 |
| `subject`            | SQLEnum(Subject)                   | 学科                                     |
| `parent_id`          | VARCHAR(36), ForeignKey(problem_categories.id), nullable | 父分类ID (用于层级结构)                |
| `description`        | TEXT, nullable                     | 描述                                     |
| `order`              | INTEGER, default=0                 | 排序字段                                 |
| `usage_count`        | INTEGER, default=0                 | 使用次数                                 |
| `created_at`         | TIMESTAMP(timezone=True)           | 创建时间                                 |
| `updated_at`         | TIMESTAMP(timezone=True)           | 更新时间                                 |
| *UniqueConstraint*   | (_subject_category_name_uc)        | subject 和 name 组合唯一                 |

#### `review_service` 相关表 (示例)

`review_analyses`（分析记录表） - *注意：此表定义在文档中，但实际代码中 `review_service` 的模型尚未详细审查。以下基于文档描述。*
| 字段 | 类型 | 说明 |
|-----|------|------|
| id | UUID | 主键 |
| analysis_type | VARCHAR(50) | 分析类型 |
| problem_ids | UUID[] | 相关题目 |
| ai_analysis | JSONB | AI分析结果 |
| error_patterns | JSONB | 错误模式 |
| study_plan | JSONB | 学习计划 |

### 数据库迁移
**注意**：当前系统在启动时通过 SQLAlchemy 的 `metadata.create_all()` 自动根据 Python 模型创建数据库表。项目中的 `backend/infrastructure/database/migrations/` 目录和 `migrate.py` 脚本当前未使用，适用于全新的数据库环境。如果需要进行后续的数据库结构变更管理，建议引入 Alembic 等迁移工具。

```bash
# (旧的迁移命令，当前未使用)
# cd backend
# python infrastructure/database/migrate.py

# 检查数据库 (可用于确认表结构是否按模型创建)
# python check_system.py 
```

## 部署指南

### 开发环境部署

#### 1. 环境准备
```bash
# Python 3.8+
python --version

# Node.js 16+ (Vite推荐使用最新LTS版本)
node --version

# Git
git --version
```

#### 2. 后端启动
```bash
# 进入后端目录
cd backend

# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate  # Windows

# 安装依赖
pip install -r requirements.txt

# 启动服务 (main.py 会自动创建数据库表)
python main.py
```

#### 3. 前端启动
```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install

# 启动开发服务器
npm run dev # (Vite通常使用 npm run dev)
```

### 生产环境部署

#### 使用Docker Compose
```bash
# 构建并启动所有服务
docker-compose up -d --build

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

#### 环境变量配置
创建`.env`文件：
```env
# 应用配置
APP_ENV=production
APP_DEBUG=false

# 数据库配置
DATABASE_URL=postgresql+asyncpg://user:pass@db:5432/dbname

# AI API配置
OPENAI_API_KEY=your-key
ANTHROPIC_API_KEY=your-key
# 根据实际使用的AI Provider添加更多配置

# 对象存储配置
MINIO_ENDPOINT=minio:9000
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin
```

## 开发指南

### 代码规范
- **Python**: 遵循PEP 8，使用Black格式化，isort进行导入排序
- **TypeScript/JavaScript**: 使用ESLint + Prettier (根据项目配置)
- **提交规范**: 使用Conventional Commits

### 添加新功能
1. 在相应的service目录下创建新模块
2. 定义数据模型（models.py）
3. 创建请求/响应模式（schemas.py）
4. 实现业务逻辑（service.py）
5. 添加API路由（api.py）
6. 编写测试用例
7. 更新文档

### 测试
```bash
# 运行所有后端测试
# cd backend
pytest

# 运行特定测试
pytest tests/test_problem_service.py

# 查看测试覆盖率
pytest --cov=backend

# 前端测试 (如果配置了)
# cd frontend
# npm test
```

### 调试技巧
1. 使用structlog查看结构化日志
2. FastAPI自动生成的交互式文档：`/docs`
3. 使用VS Code的Python调试器
4. 查看SQLAlchemy生成的SQL：设置`DATABASE_ECHO=true` (在`shared/config.py`中)
5. Vue Devtools for browser debugging

## 常见问题

### Q1: 导入路径错误
**问题**：`ModuleNotFoundError: No module named 'backend'` (或类似Python模块错误)

**解决方案**：
1. 确保在项目根目录或`backend`目录运行Python脚本，具体取决于脚本的导入方式。
2. 检查PYTHONPATH设置，通常不需要修改，依赖于正确的项目结构和运行位置。
3. 对于服务内部的导入，优先使用相对导入 (e.g., `from . import models`) 或绝对导入基于`backend`为根 (e.g., `from backend.services.problem_service import ...`)，确保运行上下文正确。

### Q2: 数据库连接失败
**问题**：无法连接到数据库

**解决方案**：
1. 检查数据库服务是否启动 (本地SQLite文件路径是否正确，或PostgreSQL/MinIO Docker容器是否运行)。
2. 验证`DATABASE_URL` (在`.env`或`shared/config.py`中) 是否正确。
3. 确保数据库用户有足够权限 (对于PostgreSQL)。
4. 检查防火墙或网络配置。

### Q3: AI服务调用失败
**问题**：AI分析功能不可用

**解决方案**：
1. 检查AI提供商的API密钥是否在`.env`或配置中正确设置。
2. 验证网络连接是否允许访问AI服务API。
3. 查看`ai_api_manager`服务的日志，了解具体错误。
4. 检查AI服务提供商的健康状态或是否有服务中断。

### Q4: 文件上传失败
**问题**：无法上传图片

**解决方案**：
1. 检查MinIO服务 (或所选对象存储服务) 是否运行。
2. 验证MinIO的`ENDPOINT`, `ACCESS_KEY`, `SECRET_KEY`配置是否正确。
3. 确保存储桶已创建且应用具有写入权限。
4. 检查文件大小是否超出配置限制。
5. 查看`file_service`的日志获取详细错误。

### Q5: 前端启动或构建问题
**问题**: `npm install` 失败或 `npm run dev` 报错

**解决方案**:
1. 确保Node.js和npm/yarn版本兼容 (查看`package.json`中的`engines`字段，如果存在)。
2. 删除`node_modules`和`package-lock.json` (或 `yarn.lock`)，然后重新运行 `npm install` (或 `yarn install`)。
3. 检查Vite或相关插件的配置 (`vite.config.js`, `tsconfig.json`)。
4. 查看终端输出的详细错误信息，通常会指明问题所在。

## 更新日志

### v2.0.0 (2024-03-08) - (示例，请根据实际情况更新)
- 🎉 完全重构为微服务架构 (FastAPI后端, Vue.js前端)
- ✨ 新增AI API管理服务，支持多提供商
- ✨ 新增深度学习分析功能
- ✨ 前端迁移至Vue.js 3 + Vite + Element Plus + Pinia
- 🔧 优化数据库设计，使用SQLAlchemy 2.0异步模式
- 🐳 全面支持Docker和Docker Compose部署
- 📚 完善项目文档，更新开发和部署指南

### v1.0.0 (2024-01-01) - (示例)
- 🎉 初始版本发布
- ✨ 基础错题管理功能 (旧版技术栈)
- ✨ 简单的AI分析

## 贡献指南

欢迎贡献代码！请遵循以下步骤：

1. Fork项目
2. 创建功能分支：`git checkout -b feature/AmazingFeature`
3. 提交更改：`git commit -m 'Add some AmazingFeature'` (遵循Conventional Commits)
4. 推送到分支：`git push origin feature/AmazingFeature`
5. 提交Pull Request

## 许可证

本项目采用MIT许可证 - 查看[LICENSE](LICENSE)文件了解详情 (如果项目中有LICENSE文件)

## 联系方式

- 项目主页：[GitHub Repository](https://github.com/yourusername/error-management-system) (请替换为实际链接)
- 问题反馈：[Issues](https://github.com/yourusername/error-management-system/issues) (请替换为实际链接)
- 邮箱：your-email@example.com (请替换为实际邮箱)

---

*最后更新：2025年5月25日*
