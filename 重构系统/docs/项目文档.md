# 错题管理系统 - 项目文档

## 目录

1. [项目概述](#项目概述)
2. [系统架构](#系统架构)
3. [技术栈](#技术栈)
4. [目录结构](#目录结构)
5. [核心模块](#核心模块)
6. [API文档](#api文档)
7. [数据库设计](#数据库设计)
8. [部署指南](#部署指南)
9. [开发指南](#开发指南)
10. [常见问题](#常见问题)

## 项目概述

### 简介
错题管理系统是一个专为考研学生设计的智能学习辅助工具，支持多学科错题管理、AI智能分析、学习进度跟踪等功能。

### 主要功能
- 📚 **多学科支持**：数学、英语、政治、专业课
- 🤖 **AI智能分析**：错误原因分析、解题思路生成、知识点提取
- 📷 **OCR识别与AI驱动录入**：支持拍照录入题目，并通过AI多阶段交互式流程智能创建错题。
- 📊 **深度分析**：学习模式识别、薄弱点分析、个性化建议
- 📈 **进度跟踪**：复习记录、掌握度评估、学习曲线
- 🏷️ **标签与分类管理**：自定义标签和分类，快速分类检索

### 系统特点
- **微服务架构**：模块化设计，易于扩展和维护
- **异步处理**：高性能异步框架，提升响应速度
- **类型安全**：前后端全面类型检查
- **本地优先**：支持完全本地运行，保护隐私
- **灵活部署**：支持Docker容器化部署

## 系统架构

### 整体架构
```
┌─────────────────────────────────────────────────────────┐
│                     前端应用 (Vue.js)                     │
├─────────────────────────────────────────────────────────┤
│                   API Gateway (FastAPI)                   │
├──────────────┬──────────────┬──────────────┬────────────┤
│  AI API管理   │   错题管理    │   回顾分析    │  文件服务  │
├──────────────┴──────────────┴──────────────┴────────────┤
│                    共享组件层                             │
├─────────────────────────────────────────────────────────┤
│                 数据库 (PostgreSQL/SQLite)                │
└─────────────────────────────────────────────────────────┘
```

### 服务依赖关系
```
文件服务 (独立)
AI管理服务 (独立)
错题服务 → AI管理服务、文件服务
回顾分析服务 → AI管理服务、错题服务
```

## 技术栈

### 后端技术
- **框架**: FastAPI (异步Web框架)
- **数据库**: 
  - 开发环境: SQLite
  - 生产环境: PostgreSQL
- **ORM**: SQLAlchemy 2.0 (异步)
- **验证**: Pydantic
- **AI集成**: 
  - OpenAI API
  - Anthropic Claude API
  - Google Gemini API
  - DeepSeek API
- **对象存储**: MinIO (或兼容S3的服务)
- **日志**: structlog
- **测试**: pytest + pytest-asyncio

### 前端技术
- **框架**: Vue.js 3 (Vue ^3.3.11)
- **语言**: JavaScript / TypeScript (Vue 3 with Vite, tsconfig.json exists)
- **UI库**: Element Plus (^2.4.3)
- **状态管理**: Pinia (^2.1.7)
- **路由**: Vue Router 4 (^4.2.5)
- **构建工具**: Vite (^5.0.8)

### 部署技术
- **容器化**: Docker
- **编排**: Docker Compose
- **反向代理**: Nginx (可选)

## 目录结构

```
重构系统/
├── backend/                      # 后端代码
│   ├── main.py                  # 应用入口
│   ├── requirements.txt         # Python依赖
│   ├── check_system.py         # 系统检查脚本
│   ├── shared/                 # 共享组件
│   │   ├── config.py          # 配置管理
│   │   ├── database.py        # 数据库连接
│   │   ├── models/            # 基础模型
│   │   └── utils/             # 工具函数
│   ├── services/              # 微服务
│   │   ├── ai_api_manager/    # AI API管理服务
│   │   ├── problem_service/   # 错题管理服务
│   │   ├── review_service/    # 回顾分析服务
│   │   └── file_service/      # 文件服务
│   └── infrastructure/        # 基础设施
│       └── database/          # 数据库相关
│           ├── migrations/    # 数据库迁移 (Alembic管理)
│           └── migrate.py     # 迁移脚本 (旧)
├── frontend/                   # 前端代码
│   ├── index.html             # 入口HTML文件
│   ├── package.json           # npm配置
│   ├── package-lock.json      # npm锁文件
│   ├── tsconfig.json          # TypeScript配置
│   ├── vite.config.js         # Vite配置文件
│   └── src/                   # 源代码
│       ├── App.tsx              # (若App.vue为主要入口则此文件可能未使用或为辅助)
│       ├── App.vue              # 主要Vue应用组件
│       ├── main.js              # 应用入口 (Vue)
│       ├── utils/               # 工具函数 (如 api.js)
│       ├── components/          # Vue组件
│       │   ├── AIReviewSuggestion.vue
│       │   └── ProblemStatistics.vue
│       ├── layouts/             # 布局组件
│       │   └── MainLayout.vue
│       ├── router/              # Vue路由配置
│       │   └── index.js
│       ├── stores/              # Pinia状态管理
│       │   └── auth.js
│       ├── styles/              # 样式文件
│       │   └── index.css
│       └── views/               # 页面视图 (Vue)
│           ├── Dashboard.vue
│           ├── ai/
│           │   ├── AIModelList.vue
│           │   └── AIStats.vue
│           ├── analyses/
│           │   ├── AnalysisCreate.vue
│           │   ├── AnalysisDetail.vue
│           │   └── AnalysisList.vue
│           └── problems/
│               ├── ProblemCreate.vue
│               ├── ProblemDetail.vue
│               ├── ProblemEdit.vue
│               ├── ProblemList.vue
│               └── AISessionList.vue
├── docs/                      # 文档
├── tests/                     # 测试
├── docker-compose.yml         # Docker编排
├── Makefile                   # 构建脚本
└── README.md                  # 项目说明
```

## 核心模块

### 1. AI API管理服务
**功能**：统一管理、执行和监控对多个AI提供商的API调用，提供一致的接口供其他服务使用。

**核心组件与职责**：

-   **`AIModelService` (核心服务层)**:
    -   **统一请求处理**: 作为所有AI请求的入口点 (`process_ai_request` 方法)。
    -   **模型选择与实例化**:
        -   根据任务需求 (`AIRequestSchema.task_type`, `AIRequestSchema.model_preferences`) 从数据库加载并选择最合适的 `AIModel` 配置。
        -   动态实例化对应的AI提供商 (如 `OpenAIProvider`, `GeminiProvider`)。
    -   **请求执行**:
        -   将标准化的 `AIRequestSchema` 转换为特定提供商的API调用格式。
        -   调用提供商的 `execute_task` (非流式) 或 `execute_task_stream` (流式) 方法。
    -   **响应处理**:
        -   将提供商返回的结果（或流式块）转换为标准化的 `AIResponseDataSchema` (或流式事件)。
    -   **日志记录**: 记录详细的AI调用日志 (`AICallLog`)，包括请求、响应、用量、耗时、成本和状态。
    -   **成本计算**: 根据模型和用量估算调用成本。
    -   **错误处理与重试**: （部分在Provider层面实现）处理API调用过程中的错误。
-   **AI提供商 (`BaseAIProvider`及其子类)**:
    -   封装与特定AI服务（如OpenAI, Gemini, DeepSeek）API的交互细节。
    -   实现 `execute_task` 和 `execute_task_stream` 方法。
    -   处理API认证、请求构建、响应解析和错误映射。
-   **模型与配置管理 (`ai_api_manager.api`, `ai_api_manager.models`)**:
    -   提供API接口 (`/api/v1/ai/models`) 用于CRUD管理 `AIModel` 配置（如API密钥、URL、模型名称、能力、优先级等）。
    -   提供API接口 (`/api/v1/ai/providers`) 获取支持的提供商列表。
    -   提供系统健康检查接口 (`/api/v1/ai/health`) 和模型连通性测试接口。
-   **Schema (`ai_api_manager.schemas`)**:
    -   `AIModelSchema`, `AIModelCreateSchema`, `AIModelUpdateSchema`: 用于AI模型配置管理。
    -   `AIRequestSchema`: 定义统一的AI请求输入结构。
    -   `AIResponseDataSchema`: 定义统一的AI响应输出结构（非流式）。
    -   `AICallLogSchema`: AI调用日志的数据模型。
-   **后台任务**:
    -  可能用于后台任务，如定期健康检查 `AIModel` 连通性并更新其状态。

**支持的AI任务** (通过 `AIRequestSchema.task_type` 指定):
- 错题分析 (含建议分类、标签、解题思路、难度评估等) (`TaskType.PROBLEM_ANALYSIS`)
- OCR识别 (`TaskType.OCR`)
- 知识点提取 (`TaskType.KNOWLEDGE_POINT_EXTRACTION` - 可作为 `PROBLEM_ANALYSIS` 的一部分或独立任务)
- 学习建议生成 (`TaskType.LEARNING_SUGGESTION`)
- **错题图片初步结构化（OCR与基本信息提取）** (`TaskType.PROBLEM_IMAGE_TO_STRUCTURED_JSON`)
- **错题交互式深度分析（含流式问答）** (`TaskType.PROBLEM_INTERACTIVE_DEEP_ANALYSIS`)
- 通用问答 (`TaskType.GENERAL_QA`)
- 聊天 (`TaskType.CHAT`)
- 文本摘要 (`TaskType.SUMMARIZATION`)
- 文本翻译 (`TaskType.TRANSLATION`)
- 更多任务类型可以根据需求扩展...


### 2. 错题管理服务
**功能概述**：提供错题全生命周期管理，包括AI驱动的智能录入、手动录入、编辑、组织、AI辅助分析、复习支持、查询统计、标签与分类管理等核心功能。

**详细功能点**：

1.  **错题录入 (Problem Entry)**:
    *   **AI驱动的智能录入 (高级)**: (详见下一节“AI驱动的智能错题录入流程”) 用户上传图片，通过多阶段AI处理（OCR、结构化、深度分析、交互优化）自动创建错题。
    *   **手动录入**: 用户通过表单填写错题的详细信息，包括题目标题、内容（支持富文本）、学科、分类、答案、错误分析、知识点、标签等。
    *   **图片录入与OCR识别 (传统流程)**:
        *   支持上传题目图片（通过与 **文件服务** 交互存储图片）。
        *   调用 **AI API管理服务** 对图片进行OCR识别，提取题目文本，自动填充到题目内容字段。
        *   用户可对OCR结果进行手动校对和编辑。
    *   **批量导入**:
        *   支持从特定格式文件（如CSV, JSON）批量导入错题。
        *   可使用预定义的 `ProblemTemplate` (题目模板) 指导导入过程，确保数据结构一致性。

2.  **错题组织与编辑 (Problem Organization & Editing)**:
    *   **信息编辑**: 提供对错题所有字段的完整编辑功能。
    *   **结构化管理**:
        *   通过 `subject` (学科) 进行一级分类。
        *   通过 `ProblemCategory` (题目分类) 实现多级、精细化的分类管理。
        *   通过 `ProblemTag` (题目标签) 为错题打上灵活的标签，便于检索和归纳。
    *   **难度与掌握度**:
        *   `difficulty_level`: 用户可设定或由AI辅助评估题目的难度等级。
        *   `mastery_level`: 记录对错题的掌握程度，通常在复习后更新。

3.  **AI辅助功能 (AI-Assisted Features)** (通过 **AI API管理服务** 实现):
    *   **智能知识点提取**: 根据题目内容自动分析并提取相关的 `knowledge_points`。
    *   **错误原因分析**: 基于用户答案和正确答案，AI自动生成 `error_analysis`，帮助理解错误本质。
    *   **解题思路生成**: AI可以辅助生成或完善题目的 `solution`。
    *   **AI建议分类 (AI-Suggested Category)**: AI可以根据题目内容和学科，自动分析并建议一个最合适的题目细分分类 (`suggested_category`)。系统在分析后会将此建议分类更新到错题的 `category` 字段，并相应调整分类的使用计数。
    *   **相似题目推荐**: (高级功能) AI分析当前错题特征，推荐知识点或题型相似的其他题目，用于巩固练习。
    *   **题目信息补全**: AI可根据题目内容尝试自动填充标签、难度等信息 (分类建议见上一条)。

4.  **复习流程支持 (Review Process Support)**:
    *   **复习记录**: 用户每次复习后，系统创建一条 `ReviewRecord`，记录复习结果、用时、笔记等。
    *   **状态更新**: 复习后，自动更新对应 `Problem` 的 `mastery_level` (掌握程度)、`review_count` (复习次数) 和 `last_review_at` (最后复习时间)。掌握度的更新可基于复习结果，或结合艾宾浩斯遗忘曲线等算法。
    *   **复习计划集成**: (可与 **回顾分析服务** 联动) 根据错题的掌握程度和复习历史，辅助生成复习计划，提醒用户在最佳时间点复习。

5.  **查询与展示 (Query & Display)**:
    *   **多维度筛选**: 支持按学科、分类、标签、难度、掌握度、创建日期、关键字等多种条件组合查询。
    *   **结果排序**: 支持按创建时间、更新时间、难度、掌握度等字段排序。
    *   **分页展示**: 对查询结果进行分页，提高加载效率。
    *   **错题详情**: 清晰展示错题的全部信息，包括题目内容、图片、答案、分析、知识点、标签、复习历史等。

6.  **数据管理 (Data Management)**:
    *   **导出功能**: 支持将错题数据导出为常见格式（如JSON, CSV, PDF），方便备份或离线学习。
    -   **批量操作**: 支持对多个错题进行批量删除、批量添加标签、批量AI重新分析等操作。

**核心模型**：

详细模型定义请参考 `backend/services/problem_service/models.py`。

- **`Problem`**: 错题核心实体，包含以下主要字段：
    - `id`: UUID, 主键
    - `title`: String(200), 题目标题
    - `content`: Text, 题目内容
    - `subject`: Enum(Subject), 学科 (数学, 英语, 政治, 专业课)
    - `category`: String(100), 题目分类 (可选, 可由用户指定或AI分析后建议)
    - `source`: String(200), 题目来源 (可选)
    - `year`: Integer, 年份 (可选)
    - `error_analysis`: Text, 错误分析 (可选)
    - `user_answer`: Text, 用户答案 (可选)
    - `correct_answer`: Text, 正确答案 (可选)
    - `solution`: Text, 解题思路 (可选)
    - `ai_analysis`: JSON, AI分析的完整结果 (JSON, 可选, 包含知识点、错误分析、建议分类等)
    - `knowledge_points`: JSON (List[str]), 知识点列表
    - `difficulty_level`: Integer, 难度等级 (1-5, 默认3)
    - `image_urls`: JSON (List[str]), 题目图片URL列表
    - `ocr_result`: Text, OCR识别结果 (可选)
    - `review_count`: Integer, 复习次数 (默认0)
    - `last_review_at`: DateTime, 最后复习时间 (可选)
    - `mastery_level`: Float, 掌握程度 (0.0-1.0, 默认0.0)
    - `tags`: JSON (List[str]), 标签列表
    - `notes`: Text, 用户备注 (可选)
    - `created_at`, `updated_at`: DateTime, 创建和更新时间
    - `deleted_at`: DateTime, 软删除标记 (可选)

- **`ReviewRecord`**: 复习记录实体，关联到`Problem`：
    - `id`: UUID, 主键
    - `problem_id`: String(36), 关联的错题ID
    - `review_result`: String(20), 复习结果 (e.g., "correct", "incorrect", "partial") (可选)
    - `confidence_level`: Integer, 信心等级 (1-5) (可选)
    - `time_spent`: Integer, 花费时间(秒) (可选)
    - `notes`: Text, 复习笔记 (可选)
    - `ai_feedback`: JSON, AI给出的反馈 (可选)
    - `created_at`, `updated_at`: DateTime

- **`ProblemTemplate`**: 题目模板实体，用于批量导入等场景：
    - `id`: UUID, 主键
    - `name`: String(100), 模板名称
    - `subject`: Enum(Subject), 学科
    - `category`: String(100), 题目分类 (可选)
    - `template_content`: JSON, 模板内容结构
    - `example_content`: JSON, 示例内容 (可选)
    - `description`: Text, 描述 (可选)
    - `usage_count`: Integer, 使用次数
    - `tags`: JSON (List[str]), 标签列表
    - `created_at`, `updated_at`: DateTime

- **`ProblemTag`**: 题目标签实体：
    - `id`: UUID, 主键
    - `name`: String(50), 标签名称 (唯一)
    - `description`: Text, 描述 (可选)
    - `color`: String(20), 标签颜色 (可选)
    - `usage_count`: Integer, 使用次数
    - `created_at`, `updated_at`: DateTime

- **`ProblemCategory`**: 题目分类实体，支持层级结构：
    - `id`: UUID, 主键
    - `name`: String(100), 分类名称
    - `subject`: Enum(Subject), 学科
    - `parent_id`: String(36), 父分类ID (可选, 用于层级)
    - `description`: Text, 描述 (可选)
    - `order`: Integer, 排序字段
    - `usage_count`: Integer, 使用次数
    - `created_at`, `updated_at`: DateTime

**核心业务流程示例**:

1.  **手动创建新错题流程**:
    *   前端：用户在创建页面填写表单（标题、学科、题目内容等），可选上传图片。
    *   后端 `problem_service`：
        *   接收创建请求。若有图片，先调用 `file_service` 上传图片，获取图片URL存入 `image_urls`。
        *   保存基础 `Problem` 信息到数据库。
        *   （可选，根据配置或用户选择）调用 `ai_api_manager` 对题目内容进行AI分析（知识点提取、初步错误分析等）。
        *   将AI分析结果更新到该 `Problem` 记录的 `ai_analysis`, `knowledge_points` 等字段。
        *   返回创建成功及错题信息给前端。

2.  **OCR图片录入错题流程 (传统)**:
    *   前端：用户上传题目图片。
    *   后端 `problem_service`：
        *   调用 `file_service` 存储图片。
        *   调用 `ai_api_manager` 的OCR功能处理图片，获取识别文本。
        *   将OCR文本预填充到新题目的内容字段，返回给前端供用户确认和编辑。
        *   用户确认并提交后，按手动创建流程继续（可再次触发更详细的AI分析）。

3.  **复习错题流程**:
    *   前端：用户选择一道错题进行复习，提交复习结果（如是否答对、掌握程度反馈、笔记）。
    *   后端 `problem_service`：
        *   创建一条新的 `ReviewRecord`，记录本次复习详情。
        *   根据复习结果和既定算法（或用户直接输入的掌握度），更新 `Problem` 的 `mastery_level`, `review_count`, `last_review_at`。
        *   （可选）若与 **回顾分析服务** 集成，可能需要通知该服务更新复习计划。

4.  **对已有错题请求AI分析流程**:
    *   前端：用户选择某条错题，点击“AI分析”按钮。
    *   后端 `problem_service`：
        *   获取该错题的现有数据（内容、答案等）。
        *   调用 `ai_api_manager` 执行指定的AI分析任务（如错误原因深度分析、解题思路优化等）。
        *   接收AI返回的分析结果，更新该 `Problem` 的 `ai_analysis` 或其他相关字段。
        *   返回更新后的错题信息给前端。

#### AI驱动的智能错题录入流程 (高级工作流)

本流程旨在提供一个高度自动化和智能化的错题录入体验，用户主要通过上传图片与AI进行交互，AI负责大部分的文本识别、内容结构化、深度分析及初步数据填充工作。

**核心思想**: 用户上传图片 -> AI多阶段处理与分析（结构化、深度分析、交互式优化） -> 用户确认 -> 错题及分析数据、交互记录完整入库。

**数据流与组件交互**:

1.  **阶段一：图片上传与初步结构化 (`/problems/ai-create/initiate`)**
    *   **前端**: 用户在 `ProblemCreate.vue` 上传图片，可选提供学科提示。图片转换为 Base64。
    *   **`problemAPI.initiateAICreation`**: 调用后端接口。
        *   请求 (`ProblemAICreateInitiateRequest`): `{ image_base64: string, subject_hint?: string }`
    *   **后端 `problem_service.api.initiate_ai_problem_creation`**:
        *   调用 `FileService.upload_base64_image` 保存图片，获取 `image_url`。
        *   创建 `ProblemAISession` 记录 (状态: `active`)，获得 `session_id`。
        *   调用 `AIModelService.process_ai_request` (任务类型: `PROBLEM_IMAGE_TO_STRUCTURED_JSON`)。
            *   请求包含 `image_url` 和 `subject_hint`。
            *   AI返回初步结构化数据 (`ProblemAIStructuredData` schema: `raw_ocr_text`, `extracted_content`, `suggested_subject`, `preliminary_category`, `preliminary_tags`, `image_regions_of_interest`等)。
        *   更新 `ProblemAISession` 记录的 `initial_image_ref` 和 `initial_structured_data_snapshot`。
        *   响应 (`ProblemAICreateInitiateResponse`): `{ session_id: UUID, structured_data: ProblemAIStructuredData }`
    *   **前端 `ProblemCreate.vue` (`handleStartAIImageImport` -> `initiateAIImageAnalysis`)**:
        *   存储 `session_id` 和 `structured_data`。
        *   使用 `structured_data` 预填充表单。
        *   UI提示用户检查并开始交互式分析。

2.  **阶段二：交互式深度分析与优化 (`/problems/ai-create/interactive-stream/{session_id}`)**
    *   **前端 `ProblemCreate.vue` (`startAIInteraction` / `sendChatMessage`)**:
        *   用户在聊天界面输入消息。
        *   准备 `chat_history` (含用户消息)。
        *   使用 `EventSource` 连接到后端的流式接口。
        *   `problemAPI.getAIInteractiveStreamURL` 构建SSE请求URL，包含查询参数 (如 `user_message`, `chat_history` - 实际通过POST body传递更佳，但SSE通常GET，因此需考虑URL长度或寻找替代方案如WebSockets。此处文档描述为POST到流式接口，后端FastAPI可以支持请求体和SSE结合)。
        *   此接口实际应为 `POST` 以便传递 `chat_history` 和 `user_message`。
    *   **后端 `problem_service.api.stream_ai_interactive_analysis`**:
        *   接收 `ProblemAIStreamRequest` (`user_message`, `chat_history`)。
        *   获取 `ProblemAISession`。
        *   构造 `AIRequestSchema` (任务类型: `PROBLEM_INTERACTIVE_DEEP_ANALYSIS`, `stream=True`)。
            *   上下文包含 `initial_structured_data_snapshot`, `chat_history`, `user_message`。
            *   使用引导AI进行深度分析和交互的系统提示。
        *   调用 `AIModelService.process_ai_request` (返回异步生成器)。
        *   **流式响应 (SSE)**:
            *   `async for chunk in ai_response_generator:`
                *   `ProblemAIChatLog` 记录AI的回复块。
                *   `yield` SSE事件 (`data: { type: 'content_chunk', value: str }` 或 `data: { type: 'structured_update', data: ProblemAIStructuredData }` 等)。
    *   **前端 `ProblemCreate.vue`**:
        *   `eventSource.onmessage`: 接收SSE事件，更新聊天界面和表单预览。
        *   `eventSource.onerror`: 处理错误。

3.  **阶段三：用户确认与数据持久化 (`/problems/ai-create/finalize`)**
    *   **前端 `ProblemCreate.vue` (`handleFinalizeAIProblem`)**:
        *   用户点击“确认保存”。
        *   收集最终表单数据 (`problemForm: ProblemCreate`) 和完整的 `chat_history`。
        *   `problemAPI.finalizeAICreation` 调用后端。
            *   请求 (`ProblemAIFinalizeRequest`): `{ session_id: UUID, problem_data: ProblemCreate, chat_history: List[ChatLogEntry], ai_full_analysis_json?: dict }`
    *   **后端 `problem_service.api.finalize_ai_problem_creation`**:
        *   获取 `ProblemAISession`。
        *   使用 `problem_data` 创建 `Problem` 记录。
        *   更新 `ProblemAISession` (状态: `finalized`, `final_problem_id`, `final_structured_data_snapshot`)。
        *   `problem_service.save_chat_history` 将 `chat_history` 中的每条记录存入 `ProblemAIChatLog` 表，关联 `session_id` 和 `final_problem_id`。
        *   响应 (`SingleProblemResponse`): 包含创建的 `ProblemData`。
    *   **前端 `ProblemCreate.vue`**:
        *   提示成功，清空会话状态，导航到错题列表或详情。

**对现有模块的利用与扩展**:

*   **`ai_api_manager`**:
    *   **`AIModelService` 和 AI 提供商**:
        *   `TaskType` 枚举已更新 (例如 `PROBLEM_IMAGE_TO_STRUCTURED_JSON`, `PROBLEM_INTERACTIVE_DEEP_ANALYSIS`)。
        *   提供商实现已更新，以处理这些任务类型并支持流式输出 (`execute_task_stream`)，它们接收 `AIRequestSchema`。
        *   模型配置 (通过 `ai_api_manager.api` 管理) 允许为不同任务类型指定合适的AI模型。
*   **`problem_service`**:
    *   **模型扩展**: (详见数据库设计部分)
        *   `ProblemAISession` (新): 存储AI创建会话的状态和中间数据。
        *   `ProblemAIChatLog` (新): 存储AI交互聊天记录。
    *   **API接口**: (详见API文档部分)
        *   `/ai-create/initiate`
        *   `/ai-create/interactive-stream/{session_id}`
        *   `/ai-create/finalize`
        *   `/ai-create/sessions` (列表)
        *   `/ai-create/session/{session_id}` (详情)
        *   `/ai-create/chat-history/{session_id}` (聊天记录)
    *   **Schema扩展 (主要在 `problem_service.schemas`)**:
        *   `ProblemAICreateInitiateRequest`, `ProblemAICreateInitiateResponse`
        *   `ProblemAIStructuredData`
        *   `ProblemAIStreamRequest`, `ChatLogEntry` (用于请求和存储)
        *   `ProblemAIFinalizeRequest`
        *   `ProblemAISessionCreate`, `ProblemAISessionData`, `ProblemAISessionUpdate`
        *   `ProblemAIChatLogCreate`, `ProblemAIChatLogData`
*   **`file_service`**: 按现有方式用于图片存储和URL管理。

**可维护性与算法升级**:

*   **模块化AI阶段**: 将AI处理分为明确的阶段（初步结构化 vs. 深度分析与交互），允许独立选择、优化和升级每个阶段所使用的AI模型和算法。
*   **标准化数据交换**: 阶段间以及前后端之间使用定义清晰的JSON格式进行数据交换，降低耦合度。
*   **AI任务类型化**: 在 `ai_api_manager` 中通过 `TaskType` 来管理不同的AI能力，便于扩展和维护。
*   **流式处理封装**: 尽可能将流式处理的复杂性封装在 `ai_api_manager` 的提供商实现和 `problem_service` 的对应接口中，简化前端调用。

**前端实现要点**:
*   `ProblemCreate.vue`: 处理图片上传、调用 `initiate`、管理 `session_id`、预填充表单、处理SSE流的接收与渲染、发送聊天消息、调用 `finalize`。
*   `AISessionList.vue`: 列出历史AI创建会话，允许查看详情或继续未完成的会话。
*   `api.js`: 添加新的 `problemAPI` 方法。

此高级流程旨在显著提升错题录入的效率和智能化水平。

**与其他模块的交互**:

-   **AI API管理服务**:
    *   **调用方**: `problem_service` 在需要AI能力时（如OCR、知识点提取、错误分析、内容生成）调用此服务。
    *   **交互内容**: 传递题目文本、图片数据、分析指令等；接收AI处理结果。
-   **文件服务**:
    *   **调用方**: `problem_service` 在处理带图片的错题时调用此服务。
    *   **交互内容**: 上传图片文件；获取图片的存储URL或引用。`problem_service` 自身存储这些URL。
-   **回顾分析服务 (Review Service)**:
    *   **交互方式**: `problem_service` 可能在错题创建、更新或复习记录产生时，通知 `review_service` 相关事件，以便后者更新学习模型、调整复习计划。`problem_service` 自身负责基础的复习记录和状态更新。
-   **统计服务 (Statistics Service)**:
    *   **数据源**: `problem_service` 存储的错题数据 (`Problem` 表) 和复习记录数据 (`ReviewRecord` 表) 是 `statistics_service` 进行统计分析的基础。`statistics_service` 通常会直接查询这些数据或通过API获取聚合数据。

**主要接口 (概览，详细见API文档部分)**：
- **错题 (Problems)** (`/api/v1/problems`):
    - `POST /`: 创建错题 (手动/传统流程)。
    - `GET /`: 获取错题列表 (支持复杂查询、筛选、排序、分页)。
    - `GET /{problem_id}`: 获取单个错题详情。
    - `PUT /{problem_id}`: 更新错题信息。
    - `DELETE /{problem_id}`: 删除错题 (软删除)。
    - `POST /{problem_id}/analyze`: 对指定错题执行AI分析。
    - `POST /batch`: 批量导入错题。
    - `GET /export`: 导出错题 (查询参数控制范围和格式)。
    - `POST /batch-operate`: 批量操作错题 (删除、更新、分析)。
- **AI驱动错题创建接口 (Problems - AI Driven)** (`/api/v1/problems/ai-create`):
    - `POST /initiate`: 启动AI驱动流程第一阶段 (图片初步结构化)。
    - `POST /interactive-stream/{session_id}`: 处理第二阶段AI分析与交互 (SSE流)。
    - `POST /finalize`: 最终保存AI驱动创建的错题。
    - `GET /sessions`: 获取AI创建会话列表。
    - `GET /session/{session_id}`: 获取指定AI会话详情。
    - `GET /chat-history/{session_id}`: 获取指定AI会话的聊天记录。
- **复习记录 (Review Records)** (`/api/v1/problems/{problem_id}/reviews`):
    - `POST /`: 为错题添加复习记录 (`ReviewRecordCreate` -> `ReviewRecordResponse`)。
    - `GET /`: 获取指定错题的所有复习记录 (`List[ReviewRecordData]`)。
- **图片与OCR (传统流程)** (`/api/v1/problems`):
    - `POST /ocr`: 对提供的图片进行OCR识别 (`ProblemOCRRequest` -> `SingleProblemResponse`，可能包含OCR文本或已创建的题目)。
    - `POST /upload/image`: 上传错题图片 (`ProblemImageUploadResponse`，包含文件信息和可选的OCR结果)。
- **标签管理 (`/api/v1/problem-tags`)** 和 **分类管理 (`/api/v1/problem-categories`)**: 接口保持不变。
- **统计接口 (`/api/v1/problems/stats`)**:
    - `GET /overview`: 获取错题总体统计概览。
    - `GET /knowledge-points`: 获取知识点相关的统计数据。

### 3. 回顾分析服务
**功能**：深度学习分析、模式识别、个性化建议

**分析类型**：
- 批量错题分析
- 知识点专项分析
- 时间段趋势分析
- 综合学习报告

**核心功能**：
- 错误模式识别
- 薄弱领域定位
- 学习计划生成
- 进度跟踪对比

### 4. 文件服务
**功能**：文件上传、存储、访问控制

**特性**：
- 支持多种存储后端（MinIO/本地文件系统）
- 图片自动压缩优化
- 访问权限控制
- 文件元数据管理

## API文档

### 基础信息
- **Base URL**: `/api` (由前端代理配置，例如 `http://localhost:8000/api` 或 `http://localhost:5173/api` 指向后端 `http://localhost:8000`)
- **认证方式**: 无需认证 (当前版本)
- **响应格式**: JSON

### 主要接口

#### 错题管理 (`/v1/problems`)

详细的请求/响应模型请参考 `backend/services/problem_service/schemas.py`。
FastAPI 自动生成的交互式文档位于后端 `/docs` (例如 `http://localhost:8000/docs`)，提供了最准确的接口详情和测试功能。

- **创建错题 (手动/传统流程)**
    - `POST /`
    - **请求体**: `ProblemCreate` schema.
        - `title: str` (必需)
        - `content: str` (必需)
        - `subject: Subject` (必需, 枚举: "math", "english", "politics", "professional")
        - `category: Optional[str]`
        - `source: Optional[str]`
        - `year: Optional[int]`
        - `user_answer: Optional[str]`
        - `correct_answer: Optional[str]`
        - `error_analysis: Optional[str]`
        - `solution: Optional[str]`
        - `tags: List[str]` (默认空列表)
        - `image_urls: List[str]` (默认空列表, 通常由后端处理图片上传后填充)
        - `image_base64: Optional[List[str]]` (用于通过base64上传图片)
        - `notes: Optional[str]`
    - **查询参数**:
        - `auto_analyze: bool` (默认 `True`): 是否在创建后自动执行AI分析。
    - **响应**: `SingleProblemResponse` (包含创建的 `ProblemData`)。

- **获取错题列表 (支持高级查询)**
    - `GET /`
    - **查询参数**: (基于 `ProblemQuery` schema)
        - `subject: Optional[Subject]`
        - `category: Optional[str]`
        - `tags: Optional[List[str]]` (例如: `tags=重点&tags=易错`)
        - `keyword: Optional[str]` (搜索标题、内容、备注)
        - `min_difficulty: Optional[int]` (1-5)
        - `max_difficulty: Optional[int]` (1-5)
        - `min_mastery: Optional[float]` (0.0-1.0)
        - `max_mastery: Optional[float]` (0.0-1.0)
        - `page: int` (默认 1)
        - `size: int` (默认 20, 最大 100)
        - `sort_by: str` (默认 "created_at", 可选: "updated_at", "difficulty_level", "mastery_level", "review_count")
        - `sort_desc: bool` (默认 `True`)
    - **响应**: `ProblemListResponse` (包含 `data: List[ProblemData]`, `total`, `page`, `size`, `pages`)。

- **获取单个错题详情**
    - `GET /{problem_id}`
    - **路径参数**: `problem_id: str`
    - **响应**: `SingleProblemResponse` (包含 `ProblemData`)。

- **更新错题信息**
    - `PUT /{problem_id}`
    - **路径参数**: `problem_id: str`
    - **请求体**: `ProblemUpdate` schema (所有字段可选).
        - `title: Optional[str]`
        - `content: Optional[str]`
        - `category: Optional[str]`
        - `source: Optional[str]`
        - `year: Optional[int]`
        - `user_answer: Optional[str]`
        - `correct_answer: Optional[str]`
        - `error_analysis: Optional[str]`
        - `solution: Optional[str]`
        - `tags: Optional[List[str]]`
        - `image_urls: Optional[List[str]]` (注意：通常图片管理通过专门的上传/删除接口)
        - `notes: Optional[str]`
        - `mastery_level: Optional[float]` (0.0-1.0)
    - **响应**: `SingleProblemResponse` (包含更新后的 `ProblemData`)。

- **删除错题 (软删除)**
    - `DELETE /{problem_id}`
    - **路径参数**: `problem_id: str`
    - **响应**: `SingleProblemResponse` (仅包含 `success` 和 `message`)。

- **AI分析错题 (针对已存在错题)**
    - `POST /{problem_id}/analyze`
    - **路径参数**: `problem_id: str`
    - **请求体**: (可选) `ProblemAnalyzeRequest` schema.
        - `regenerate: bool` (默认 `False`)
        - `focus_areas: Optional[List[str]]`
    - **响应**: `SingleProblemResponse` (包含更新AI分析结果后的 `ProblemData`)。

- **OCR识别图片内容 (传统流程)**
    - `POST /ocr`
    - **请求体**: `ProblemOCRRequest` schema.
        - `image_base64: Optional[str]`
        - `image_url: Optional[HttpUrl]`
        - `enhance_math: bool` (默认 `True`)
        - `auto_create: bool` (默认 `False`)
        - `subject: Optional[Subject]`
        - `category: Optional[str]`
    - **响应**: `SingleProblemResponse`.

- **批量导入错题**
    - `POST /batch`
    - **请求体**: `List[ProblemCreate]`
    - **查询参数**: `auto_analyze: bool` (默认 `False`)
    - **响应**: `dict` 包含 `success: bool`, `message: str`, 和 `data: {total, success, failed, errors, created_ids}`。

- **上传错题图片 (传统流程)**
    - `POST /upload/image`
    - **请求体**: `multipart/form-data` (`file: UploadFile`)
    - **查询参数**: `auto_ocr: bool` (默认 `True`)
    - **响应**: `ProblemImageUploadResponse` (包含 `file_info`, `ocr_result` 等)

- **导出错题数据**
    - `GET /export`
    - **查询参数**: (同获取列表, 额外加 `export_format: ExportFormat` (json, csv))
    - **响应**: JSON 列表或 CSV 文件流。

- **批量操作错题**
    - `POST /batch-operate`
    - **请求体**: `ProblemBatchRequest` (`problem_ids: List[str]`, `operation: str` ("delete", "update", "analyze"), `update_data: Optional[Dict]`)
    - **响应**: `BatchOperationResponse` (含成功/失败详情)

#### AI驱动的智能错题录入 (`/v1/problems/ai-create`)

- **启动AI驱动流程第一阶段 (图片初步结构化)**
    - `POST /initiate`
    - **请求体**: `ProblemAICreateInitiateRequest`
        - `image_base64: Optional[str]` (图片的Base64编码)
        - `image_url: Optional[HttpUrl]` (图片的URL，若不使用base64)
        - `subject_hint: Optional[str]` (用户提供学科提示，帮助AI更快定位)
    - **响应**: `ProblemAICreateInitiateResponse`
        - `session_id: UUID` (新创建的AI会话ID)
        - `structured_data: ProblemAIStructuredData` (AI初步结构化的数据，如 `raw_ocr_text`, `extracted_content`, `suggested_subject`, `preliminary_category`, `preliminary_tags`等)

- **处理第二阶段AI分析与交互 (SSE流)**
    - `POST /interactive-stream/{session_id}`
    - **路径参数**: `session_id: UUID`
    - **请求体**: `ProblemAIStreamRequest`
        - `user_message: str` (用户当前输入的消息)
        - `chat_history: List[ChatLogEntry]` (到目前为止的完整聊天记录)
        - `current_form_data: Optional[ProblemCreate]` (可选，用户在前端表单中的当前数据，供AI参考)
    - **响应**: `text/event-stream` (SSE)
        - 事件如: `data: {"type": "content_chunk", "value": "AI正在思考..."}\n\n`
        - 或 `data: {"type": "structured_update", "data": { "title": "更新后的标题", ...}}\n\n` (AI建议的表单字段更新)
        - 或 `data: {"type": "error", "message": "AI处理出错"}\n\n`
        - 或 `data: {"type": "stream_end"}\n\n` (表示AI本次回复结束)

- **最终保存AI驱动创建的错题**
    - `POST /finalize`
    - **请求体**: `ProblemAIFinalizeRequest`
        - `session_id: UUID` (要最终确定的会话ID)
        - `problem_data: ProblemCreate` (用户最终确认/编辑后的完整错题数据)
        - `ai_full_analysis_json: Optional[Dict[str, Any]]` (AI深度分析的完整JSON，若有，可存入 `Problem.ai_analysis`)
        - `chat_history: List[ChatLogEntry]` (本次创建会话的完整交互聊天记录)
    - **响应**: `SingleProblemResponse` (包含创建的 `ProblemData`)

- **获取AI创建会话列表**
    - `GET /sessions`
    - **查询参数**:
        - `page: int` (默认 1)
        - `size: int` (默认 10)
        - `status: Optional[str]` (会话状态过滤, e.g., "active", "finalized", "aborted")
    - **响应**: `ProblemAISessionListResponse` (包含 `data: List[ProblemAISessionData]`, `total`, `page`, `size`)

- **获取指定AI创建会话的详细信息**
    - `GET /session/{session_id}`
    - **路径参数**: `session_id: UUID`
    - **响应**: `ProblemAISessionResponse` (包含 `ProblemAISessionData`)

- **获取指定AI创建会话的完整聊天记录**
    - `GET /chat-history/{session_id}`
    - **路径参数**: `session_id: UUID`
    - **响应**: `ProblemAIChatLogListResponse` (包含 `data: List[ProblemAIChatLogData]`)


#### 复习记录 (`/v1/problems/{problem_id}/reviews` 和 `/v1/reviews`)

- **为错题添加复习记录**
    - `POST /v1/problems/{problem_id}/review` (此接口更符合RESTful风格，原文档中`/reviews`作为顶级资源)
    - **路径参数**: `problem_id: str`
    - **请求体**: `ReviewRecordCreate` schema (或简化版，如仅含 `mastery_level` 和 `notes`)
        - `mastery_level: float` (0.0-1.0)
        - `notes: Optional[str]`
        - `review_result: Optional[str]`
        - `confidence_level: Optional[int]`
        - `time_spent: Optional[int]`
    - **响应**: `ReviewRecordResponse` (包含创建的 `ReviewRecordData`)。
    *或者使用独立的 `analysisAPI` (前端已定义):*
    - `POST /v1/reviews` (请求体 `ReviewRecordCreate` 包含 `problem_id`)

- **获取错题的所有复习记录**
    - `GET /v1/problems/{problem_id}/reviews`
    - **响应**: `List[ReviewRecordData]` (或带分页的响应体)

- **获取错题统计概览**
    - `GET /v1/problems/stats/overview`
    - **响应**: `ProblemStatisticsResponse` (包含 `data: ProblemStatisticsOverviewSchema`)

- **获取知识点统计**
    - `GET /v1/problems/stats/knowledge-points`
    - **响应**: `KnowledgePointStatsListResponse` (包含 `data: List[KnowledgePointStatsSchema]`)


#### 题目标签管理 (Problem Tags) (`/v1/problem-tags`)

- **创建题目标签**: `POST /` (请求: `ProblemTagCreate`, 响应: `ProblemTagResponse`)
- **获取题目标签列表**: `GET /` (响应: `ProblemTagListResponse`)
- **获取单个题目标签**: `GET /{tag_id}` (响应: `ProblemTagResponse`)
- **更新题目标签**: `PUT /{tag_id}` (请求: `ProblemTagUpdate`, 响应: `ProblemTagResponse`)
- **删除题目标签**: `DELETE /{tag_id}` (响应: `ProblemTagResponse` 仅含成功消息)

#### 题目分类管理 (Problem Categories) (`/v1/problem-categories`)

- **创建题目分类**: `POST /` (请求: `ProblemCategoryCreate`, 响应: `ProblemCategoryResponse`)
- **获取题目分类列表**: `GET /` (查询参数 `subject`, `parent_id`, `hierarchical`; 响应: `ProblemCategoryListResponse`)
- **获取单个题目分类**: `GET /{category_id}` (响应: `ProblemCategoryResponse`)
- **更新题目分类**: `PUT /{category_id}` (请求: `ProblemCategoryUpdate`, 响应: `ProblemCategoryResponse`)
- **删除题目分类**: `DELETE /{category_id}` (响应: `ProblemCategoryResponse` 仅含成功消息)


#### AI API 管理服务 (`/v1/ai`)

详细的请求/响应模型请参考 `backend/services/ai_api_manager/schemas.py`。
FastAPI 自动生成的交互式文档位于后端 `/docs`。

**基础路径**: `/v1/ai` (原为 `/api/v1/ai-manager`)

- **AI模型配置管理**
    - `POST /models`: 创建新的AI模型配置。 (请求: `AIModelCreate`, 响应: `AIModelResponse`)
    - `GET /models`: 获取所有AI模型配置列表。 (响应: `AIModelListResponse`)
    - `GET /models/{model_id}`: 获取指定的AI模型配置。 (响应: `AIModelResponse`)
    - `PUT /models/{model_id}`: 更新指定的AI模型配置。 (请求: `AIModelUpdate`, 响应: `AIModelResponse`)
    - `DELETE /models/{model_id}`: 删除指定的AI模型配置。 (响应状态码: 204)
    - `POST /models/{model_id}/test-connectivity`: 测试指定AI模型配置的连通性。 (响应: `AIModelTestConnectivityResponse`)

- **AI提供商信息**
    - `GET /providers`: 获取支持的AI提供商列表及其能力。 (响应: `AIProviderInfoListResponse`)

- **执行AI任务**
    - `POST /execute`: 统一执行AI任务（流式或非流式）。
        - 请求体: `AIRequestSchema` (其中 `stream: bool` 控制是否流式)
        - 响应:
            - 非流式 (`stream=False`): `AIResponseDataSchema`
            - 流式 (`stream=True`): Server-Sent Events (SSE) 流

- **系统与健康检查**
    - `GET /health/system`: 获取AI管理服务的整体健康状态和统计信息。 (响应: `AISystemHealthResponse`)
    - `GET /health/logs`: 获取最近的AI调用日志（支持分页）。 (响应: `AICallLogListResponse`)

### 详细API文档
启动服务后访问：后端 `/docs` (例如 `http://localhost:8000/docs`) (FastAPI自带的Swagger UI) 和 `/redoc`。

## 数据库设计

### 核心表结构

**重要说明：** 用户账户系统已废弃。所有数据全局共享。

以下是主要服务相关的核心表结构。详细定义请参考各服务下的 `models.py`。

#### `problem_service` 相关表

**1. `problems` (错题表)** (基本不变，参考前文)

**2. `review_records` (复习记录表)** (基本不变，参考前文)

**3. `problem_templates` (题目模板表)** (基本不变，参考前文)

**4. `problem_tags` (题目标签表)** (基本不变，参考前文)

**5. `problem_categories` (题目分类表)** (基本不变，参考前文)


**6. `problem_ai_sessions` (AI错题创建会话表)**

| 字段                          | 类型                               | 说明                                                              |
|-------------------------------|------------------------------------|-------------------------------------------------------------------|
| `id`                          | UUID                               | 主键, 会话ID                                                      |
| `initial_image_ref`           | VARCHAR(1024), nullable          | 初始上传图片的引用/URL                                              |
| `initial_subject_hint`        | VARCHAR(100), nullable             | 用户初始提供的学科提示                                            |
| `initial_structured_data_snapshot` | JSON, nullable                  | 阶段一AI初步结构化的数据快照 (`ProblemAIStructuredData`)            |
| `current_structured_data_snapshot`| JSON, nullable                  | 阶段二AI交互过程中，最新的结构化数据快照                          |
| `final_problem_id`            | UUID, ForeignKey(problems.id), nullable | 最终成功创建的错题ID                                            |
| `status`                      | VARCHAR(30), default='active'      | 会话状态 ('active', 'finalized', 'aborted', 'error', 'expired')   |
| `last_activity_at`            | TIMESTAMP(timezone=True)           | 最后活跃时间 (自动更新)                                           |
| `expires_at`                  | TIMESTAMP(timezone=True), nullable | 会话过期时间 (例如，创建后24小时)                               |
| `error_message`               | TEXT, nullable                     | 如果会话因错误中止，记录错误信息                                  |
| `metadata`                    | JSON, nullable                     | 其他会话相关元数据 (例如，使用的AI模型ID, 流程步骤，UI状态等)   |
| `created_at`                  | TIMESTAMP(timezone=True)           | 创建时间                                                          |
| `updated_at`                  | TIMESTAMP(timezone=True)           | 更新时间                                                          |

**7. `problem_ai_chat_logs` (AI交互聊天记录表)**

| 字段                     | 类型                               | 说明                                                              |
|--------------------------|------------------------------------|-------------------------------------------------------------------|
| `id`                     | UUID                               | 主键                                                              |
| `session_id`             | UUID, ForeignKey(problem_ai_sessions.id) | 关联的AI错题创建会话ID (级联删除)                               |
| `problem_id`             | UUID, ForeignKey(problems.id), nullable | 关联的错题ID (仅在会话最终生成错题后填充, 可选)                   |
| `timestamp`              | TIMESTAMP(timezone=True), default=now | 消息时间戳                                                        |
| `role`                   | VARCHAR(10)                        | 角色 ('user' 或 'assistant' 或 'system')                          |
| `content`                | TEXT                               | 消息内容 (纯文本或JSON结构的字符串化表示)                           |
| `content_type`           | VARCHAR(50), default='text/plain'  | 内容MIME类型 (例如: 'text/plain', 'application/json+suggestion', 'application/json+form_update') |
| `order_in_session`       | INTEGER                            | 在该会话中的顺序 (从1开始，自增)                                   |
| `metadata`               | JSON, nullable                     | 额外元数据 (例如，AI思考过程、工具使用、消息ID、引用等)            |
| `created_at`             | TIMESTAMP(timezone=True), default=now | 记录创建时间                                                      |

*关系说明*:
- `problem_ai_chat_logs.session_id` 指向 `problem_ai_sessions.id`。
- `problem_ai_sessions.final_problem_id` 指向 `problems.id`。

#### `review_service` 相关表 (示例)
(同前文)

#### `ai_api_manager` 相关表
**1. `ai_models` (AI模型配置表)**
| 字段                | 类型                               | 说明                                                         |
|---------------------|------------------------------------|--------------------------------------------------------------|
| `id`                | UUID                               | 主键                                                         |
| `model_name`        | VARCHAR(255), unique=True          | 模型唯一名称/ID (例如 "gpt-4-turbo-preview")                 |
| `provider`          | VARCHAR(50)                        | AI提供商 (例如 "openai", "gemini", "deepseek")                 |
| `api_key_env_var`   | VARCHAR(100), nullable             | 存储API密钥的环境变量名 (例如 "OPENAI_API_KEY")              |
| `base_url_env_var`  | VARCHAR(100), nullable             | 存储API基础URL的环境变量名 (可选)                            |
| `capabilities`      | JSON (List[str])                   | 模型能力列表 (例如 ["ocr", "chat", "problem_analysis"])        |
| `config_json`       | JSON, nullable                     | 特定于提供商的额外配置 (例如 temperature, top_p)             |
| `priority`          | INTEGER, default=0                 | 优先级 (用于模型选择)                                        |
| `is_active`         | BOOLEAN, default=True              | 是否激活可用                                                 |
| `last_tested_at`    | TIMESTAMP(timezone=True), nullable | 最后连通性测试时间                                           |
| `last_test_status`| VARCHAR(20), nullable              | 最后测试状态 ("ok", "error")                                 |
| `notes`             | TEXT, nullable                     | 备注                                                         |
| `created_at`        | TIMESTAMP(timezone=True)           | 创建时间                                                     |
| `updated_at`        | TIMESTAMP(timezone=True)           | 更新时间                                                     |

**2. `ai_call_logs` (AI调用日志表)**
| 字段                | 类型                               | 说明                                                         |
|---------------------|------------------------------------|--------------------------------------------------------------|
| `id`                | UUID                               | 主键                                                         |
| `model_id`          | UUID, ForeignKey(ai_models.id)     | 使用的AI模型ID                                               |
| `task_type`         | VARCHAR(100), nullable             | AI任务类型 (例如 `TaskType.PROBLEM_ANALYSIS`)                |
| `request_data`      | JSON, nullable                     | 发送给AI的请求数据（脱敏后）                                 |
| `response_data`     | JSON, nullable                     | AI返回的响应数据（脱敏后，流式可能只记录摘要或错误）         |
| `prompt_tokens`     | INTEGER, nullable                  | 输入Token数量                                                |
| `completion_tokens` | INTEGER, nullable                  | 输出Token数量                                                |
| `total_tokens`      | INTEGER, nullable                  | 总Token数量                                                  |
| `duration_ms`       | INTEGER, nullable                  | 调用耗时 (毫秒)                                              |
| `cost`              | DECIMAL(10, 6), nullable           | 估算成本                                                     |
| `status_code`       | INTEGER, nullable                  | HTTP状态码 (若适用)                                          |
| `error_message`     | TEXT, nullable                     | 错误信息 (如果调用失败)                                      |
| `is_stream`         | BOOLEAN, default=False             | 是否为流式调用                                               |
| `user_identifier`   | VARCHAR(255), nullable             | 调用方标识 (例如，服务名或用户ID - 当前废弃)                 |
| `created_at`        | TIMESTAMP(timezone=True)           | 创建时间                                                     |


### 数据库迁移
当前系统在开发模式下启动时通过 SQLAlchemy 的 `metadata.create_all()` 自动根据 Python 模型创建数据库表 (如果表不存在)。
对于生产环境和后续的数据库结构变更管理，**强烈建议引入 Alembic**。
`backend/infrastructure/database/migrations/` 目录已预留给 Alembic 使用。

```bash
# 检查数据库 (可用于确认表结构是否按模型创建)
# python check_system.py 
```

## 部署指南

### 开发环境部署

#### 1. 环境准备
```bash
# Python 3.9+
python --version

# Node.js 18+ (Vite推荐使用最新LTS版本)
node --version

# Git
git --version
```

#### 2. 后端启动
```bash
# 进入后端目录
cd backend

# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate  # Windows

# 安装依赖
pip install -r requirements.txt

# (可选) 如果使用PostgreSQL, 确保数据库服务已运行且配置正确
# (可选) 如果使用MinIO, 确保服务已运行且配置正确

# 启动服务 (main.py 会自动创建数据库表 - 仅限SQLite或首次在空PG库运行)
python main.py
```

#### 3. 前端启动
```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install

# 启动开发服务器
npm run dev # (Vite通常使用 npm run dev)
```
访问 `http://localhost:5173` (或Vite指定的端口)。

### 生产环境部署

#### 使用Docker Compose
```bash
# (确保已安装 Docker 和 Docker Compose)

# 在项目根目录创建 .env 文件，配置必要的环境变量 (见下文)

# 构建并启动所有服务 (后台运行)
docker-compose up -d --build

# 查看服务状态
docker-compose ps

# 查看日志 (例如后端服务)
docker-compose logs -f backend

# 停止并移除容器
docker-compose down
```

#### 环境变量配置
在项目根目录创建 `.env` 文件 (会被 `docker-compose.yml` 和后端配置加载):
```env
# 应用配置
APP_ENV=production # "development" 或 "production"
APP_DEBUG=false # 在生产中设为 false
LOG_LEVEL=INFO # (DEBUG, INFO, WARNING, ERROR)

# 数据库配置 (PostgreSQL示例)
DATABASE_URL=postgresql+asyncpg://your_pg_user:your_pg_password@db:5432/your_db_name
# 对于本地SQLite开发 (通常由config.py自动处理，但可覆盖)
# DATABASE_URL=sqlite+aiosqlite:///./test_dev.db 

# AI API配置 (必需, 示例)
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
GEMINI_API_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
# ... 其他AI提供商的API密钥，根据ai_models表中的api_key_env_var配置

# 文件服务 (MinIO示例)
MINIO_ENDPOINT=minio:9000 # Docker内部地址
MINIO_ACCESS_KEY=your_minio_access_key
MINIO_SECRET_KEY=your_minio_secret_key
MINIO_BUCKET_NAME=deepstudents-dev
MINIO_USE_SSL=false # 根据MinIO配置

# FastAPI服务器配置 (可选)
BACKEND_HOST=0.0.0.0
BACKEND_PORT=8000
BACKEND_RELOAD=false # 生产中设为false

# CORS (生产中应限制)
# ALLOWED_ORIGINS=["http://localhost:5173","https://yourdomain.com"]
```

## 开发指南

### 代码规范
- **Python**: 遵循PEP 8，使用Black格式化，isort进行导入排序。 Ruff用于综合Linting和格式化。
- **TypeScript/JavaScript**: 使用ESLint + Prettier (根据项目配置)。
- **提交规范**: 使用Conventional Commits。

### 添加新功能
1. 在相应的service目录下创建新模块/文件。
2. 定义数据模型（`models.py`）。
3. 创建请求/响应模式（`schemas.py`）。
4. 实现业务逻辑（`service.py`）。
5. 添加API路由（`api.py` 或 `router.py`）。
6. 编写测试用例 (在 `tests/` 目录下对应服务)。
7. 更新本文档 (`docs/项目文档.md`) 和 `README.md`。
8. 如果涉及数据库模型变更，创建并应用Alembic迁移。

### 测试
```bash
# 进入后端目录
cd backend

# 运行所有后端测试
pytest

# 运行特定测试文件或目录
pytest tests/services/problem_service/

# 查看测试覆盖率 (需要 pytest-cov)
pytest --cov=services --cov-report=html  # 生成HTML报告到 htmlcov/

# 前端测试 (如果配置了)
# cd frontend
# npm test
```

### 调试技巧
1. 使用 `get_logger` 获取的logger实例进行日志记录。
2. FastAPI自动生成的交互式文档：后端 `/docs` (例如 `http://localhost:8000/docs`)。
3. 使用VS Code的Python调试器 (配置 `launch.json`)。
4. 查看SQLAlchemy生成的SQL：在 `shared/config.py` 中设置 `Settings.DATABASE_ECHO=True`。
5. Vue Devtools for browser debugging (安装浏览器扩展)。

## 常见问题
(同前文)

## 更新日志

### v2.1.0 (进行中)
- ✨ 新增AI驱动的错题智能录入流程，包括多阶段AI处理和用户交互界面。
- ✨ 新增 `ProblemAISession` 和 `ProblemAIChatLog` 用于支持AI错题创建会话管理和聊天记录存储。
- ✨ 前端 `ProblemCreate.vue` 重构以支持新的AI录入流程。
- ✨ 新增 `AISessionList.vue` 用于查看和管理AI创建会话。
- 🔧 更新API接口和数据库模型以支持新功能。
- 📚 对应更新项目文档。

### v2.0.0 (2024-03-08) - (示例，请根据实际情况更新)
- 🎉 完全重构为微服务架构 (FastAPI后端, Vue.js前端)
- ✨ 新增AI API管理服务，支持多提供商
- ✨ 新增深度学习分析功能
- ✨ 前端迁移至Vue.js 3 + Vite + Element Plus + Pinia
- 🔧 优化数据库设计，使用SQLAlchemy 2.0异步模式
- 🐳 全面支持Docker和Docker Compose部署
- 📚 完善项目文档，更新开发和部署指南

### v1.0.0 (2024-01-01) - (示例)
- 🎉 初始版本发布
- ✨ 基础错题管理功能 (旧版技术栈)
- ✨ 简单的AI分析

## 贡献指南
(同前文)

## 许可证
(同前文)

## 联系方式
(同前文)

---

*最后更新：2025年5月25日*
